---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/models/base.py
  - src/models/task.py
  - src/models/client.py
  - src/models/artifact.py
  - src/models/skill.py
  - src/models/log.py
  - src/models/__init__.py
  - src/core/database.py
autonomous: true

must_haves:
  truths:
    - "All 11 tables defined as SQLAlchemy models"
    - "Models use async-compatible patterns (Mapped[], mapped_column)"
    - "Database engine factory creates async engine with connection pooling"
  artifacts:
    - path: "src/models/base.py"
      provides: "SQLAlchemy declarative base"
      contains: "class Base"
    - path: "src/models/task.py"
      provides: "Task and related models"
      contains: "class Task"
    - path: "src/core/database.py"
      provides: "Async engine and session factory"
      contains: "async_sessionmaker"
  key_links:
    - from: "src/models/task.py"
      to: "src/models/base.py"
      via: "import Base"
      pattern: "from src.models.base import Base"
    - from: "src/core/database.py"
      to: "src/core/config.py"
      via: "import settings"
      pattern: "from src.core.config import settings"
---

<objective>
Create SQLAlchemy async models for the complete database schema and database connection utilities.

Purpose: Define the data layer with all 11 tables from MASTERPLAN (tasks, clients, client_profile_entries, task_artifacts, escalations, feedback_entries, skill_files, agent_logs, agent_metrics, document_embeddings, skill_embeddings) using SQLAlchemy 2.0 async patterns.

Output: Complete SQLAlchemy models with proper relationships and an async engine/session factory.
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQLAlchemy declarative base and all domain models</name>
  <files>src/models/base.py, src/models/task.py, src/models/client.py, src/models/artifact.py, src/models/skill.py, src/models/log.py, src/models/__init__.py</files>
  <action>
    1. Create src/models/base.py:
       - DeclarativeBase subclass
       - Common mixins if needed (timestamps)

    2. Create src/models/task.py with:
       - Task: id, client_id (FK), task_type, status (enum: pending, assigned, in_progress, completed, failed, escalated), assigned_agent, created_at, updated_at, completed_at
       - Escalation: id, task_id (FK), reason, escalated_at, resolved_at, resolution
       - TaskArtifact: id, task_id (FK), artifact_type, file_path, content, created_at

    3. Create src/models/client.py with:
       - Client: id, name, email, created_at, updated_at
       - ClientProfileEntry: id, client_id (FK), entry_type, data (JSONB), created_at (append-only log pattern)

    4. Create src/models/artifact.py with:
       - FeedbackEntry: id, task_id (FK), reviewer_id, feedback_type, original_content, corrected_content, diff_summary, tags (ARRAY), created_at
       - DocumentEmbedding: id, task_id (FK), content, embedding (Vector(1536)), created_at

    5. Create src/models/skill.py with:
       - SkillFile: id, name, version, effective_date, content, created_at
       - SkillEmbedding: id, skill_file_id (FK), chunk_text, embedding (Vector(1536)), created_at

    6. Create src/models/log.py with:
       - AgentLog: id, task_id (FK), client_id (FK), agent, level, message, extra (JSONB), created_at
       - AgentMetric: id, task_id (FK), agent, metric_name, metric_value, created_at

    7. Update src/models/__init__.py to export all models:
       ```python
       from src.models.base import Base
       from src.models.task import Task, Escalation, TaskArtifact
       from src.models.client import Client, ClientProfileEntry
       from src.models.artifact import FeedbackEntry, DocumentEmbedding
       from src.models.skill import SkillFile, SkillEmbedding
       from src.models.log import AgentLog, AgentMetric

       __all__ = [
           "Base", "Task", "Escalation", "TaskArtifact",
           "Client", "ClientProfileEntry", "FeedbackEntry",
           "DocumentEmbedding", "SkillFile", "SkillEmbedding",
           "AgentLog", "AgentMetric",
       ]
       ```

    Use SQLAlchemy 2.0 patterns:
    - `Mapped[T]` for type hints
    - `mapped_column()` for column definitions
    - `relationship()` with back_populates for bidirectional relationships
    - pgvector.sqlalchemy.Vector for embedding columns
  </action>
  <verify>
    - `python -c "from src.models import Base, Task, Client"` imports without error
    - All 11 model classes are importable from src.models
  </verify>
  <done>All 11 database tables defined as SQLAlchemy models with proper types and relationships</done>
</task>

<task type="auto">
  <name>Task 2: Create async database engine factory and session maker</name>
  <files>src/core/database.py</files>
  <action>
    Create src/core/database.py with:

    1. `create_async_engine` factory function:
       - Uses settings.database_url
       - pool_size=20, max_overflow=0 (controlled pool)
       - pool_pre_ping=True (connection health check)
       - echo=settings.debug (SQL logging in debug mode)

    2. `create_async_session_factory` function:
       - Takes engine as parameter
       - Returns async_sessionmaker with expire_on_commit=False (critical for async)

    3. Helper function `get_db_session` that yields a session (for use in FastAPI Depends):
       ```python
       async def get_db_session(request: Request) -> AsyncGenerator[AsyncSession, None]:
           async with request.app.state.async_session() as session:
               yield session
       ```

    4. Import all models at module level to ensure they're registered with Base.metadata
  </action>
  <verify>
    - `python -c "from src.core.database import create_async_engine, create_async_session_factory"` imports
    - Engine factory accepts settings.database_url
  </verify>
  <done>Async database utilities ready for FastAPI lifespan integration</done>
</task>

</tasks>

<verification>
1. All models importable: `python -c "from src.models import *; print(len(__all__))"`  shows 11+ items
2. Database utilities importable: `python -c "from src.core.database import create_async_engine"`
3. Vector type used: `grep -r "Vector" src/models/` shows embedding columns
4. expire_on_commit=False present in database.py
</verification>

<success_criteria>
- 11 SQLAlchemy model classes defined across 5 model files
- All models inherit from common Base
- pgvector Vector type used for embedding columns
- Async engine factory with proper pool configuration
- Session maker with expire_on_commit=False
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
