---
phase: 01-foundation
plan: 05
type: execute
wave: 4
depends_on: ["01-01", "01-02", "01-03", "01-04"]
files_modified:
  - src/main.py
  - src/api/__init__.py
  - src/api/deps.py
  - src/api/health.py
autonomous: true

must_haves:
  truths:
    - "FastAPI server starts without error"
    - "GET /api/health returns {status, db, redis} JSON"
    - "Health endpoint returns 'ok' when both db and redis connected"
    - "Lifespan manages db and redis connections properly"
  artifacts:
    - path: "src/main.py"
      provides: "FastAPI application with lifespan"
      contains: "@asynccontextmanager"
    - path: "src/api/health.py"
      provides: "Health check endpoint"
      contains: "/api/health"
    - path: "src/api/deps.py"
      provides: "Dependency injection for db/redis"
      contains: "get_db"
  key_links:
    - from: "src/main.py"
      to: "src/core/database.py"
      via: "lifespan creates engine"
      pattern: "create_async_engine"
    - from: "src/main.py"
      to: "src/core/redis.py"
      via: "lifespan creates pool"
      pattern: "create_redis_pool"
    - from: "src/api/health.py"
      to: "app.state"
      via: "request.app.state"
      pattern: "request.app.state"
---

<objective>
Create FastAPI application with lifespan context manager and health endpoint.

Purpose: Integrate all foundation components (database, Redis, logging, Sentry) into a running FastAPI server with a health endpoint that verifies all connections. This is the final piece that satisfies INFRA-01 (health endpoint) and proves the infrastructure works together.

Output: Running FastAPI application with /api/health endpoint returning {"status": "ok", "db": "connected", "redis": "connected"}.
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FastAPI app with lifespan context manager</name>
  <files>src/main.py, src/api/deps.py</files>
  <action>
    1. Create src/main.py with lifespan pattern:
       ```python
       from contextlib import asynccontextmanager
       from fastapi import FastAPI

       from src.core.config import settings
       from src.core.database import create_async_engine, create_async_session_factory
       from src.core.redis import create_redis_pool
       from src.core.logging import configure_logging, get_logger
       from src.core.sentry import init_sentry
       from src.api.health import router as health_router

       # Initialize logging and Sentry before app creation
       configure_logging()
       init_sentry()

       logger = get_logger(__name__)

       @asynccontextmanager
       async def lifespan(app: FastAPI):
           """Manage application lifecycle - startup and shutdown."""
           logger.info("starting_application", environment=settings.environment)

           # Startup: Create connections
           app.state.db_engine = create_async_engine(settings.database_url)
           app.state.async_session = create_async_session_factory(app.state.db_engine)
           app.state.redis = await create_redis_pool()

           logger.info("connections_established", db="ready", redis="ready")

           yield

           # Shutdown: Clean up connections
           logger.info("shutting_down_application")
           await app.state.redis.aclose()
           await app.state.db_engine.dispose()
           logger.info("connections_closed")

       app = FastAPI(
           title="Rookie",
           description="AI Employee for CPA Firms",
           version="0.1.0",
           lifespan=lifespan,
       )

       # Include routers
       app.include_router(health_router)
       ```

    2. Create src/api/deps.py with dependency injection:
       ```python
       from typing import AsyncGenerator
       from fastapi import Request
       from sqlalchemy.ext.asyncio import AsyncSession
       import redis.asyncio as redis

       async def get_db(request: Request) -> AsyncGenerator[AsyncSession, None]:
           """Get database session for request."""
           async with request.app.state.async_session() as session:
               yield session

       def get_redis(request: Request) -> redis.Redis:
           """Get Redis client for request."""
           return request.app.state.redis
       ```
  </action>
  <verify>
    - `python -c "from src.main import app; print(app.title)"` outputs "Rookie"
    - `python -c "from src.api.deps import get_db, get_redis"` imports
  </verify>
  <done>FastAPI app with lifespan managing db and redis connections</done>
</task>

<task type="auto">
  <name>Task 2: Create /api/health endpoint</name>
  <files>src/api/health.py, src/api/__init__.py</files>
  <action>
    1. Create src/api/health.py:
       ```python
       from fastapi import APIRouter, Request
       from sqlalchemy import text
       from pydantic import BaseModel

       router = APIRouter(tags=["health"])

       class HealthResponse(BaseModel):
           status: str
           db: str
           redis: str

       @router.get("/api/health", response_model=HealthResponse)
       async def health_check(request: Request) -> HealthResponse:
           """
           Check health of all infrastructure components.

           Returns:
               - status: "ok" if all components healthy, "degraded" otherwise
               - db: "connected" or "disconnected"
               - redis: "connected" or "disconnected"
           """
           # Check database connection
           db_status = "connected"
           try:
               async with request.app.state.async_session() as session:
                   await session.execute(text("SELECT 1"))
           except Exception:
               db_status = "disconnected"

           # Check Redis connection
           redis_status = "connected"
           try:
               await request.app.state.redis.ping()
           except Exception:
               redis_status = "disconnected"

           # Determine overall status
           status = "ok" if db_status == "connected" and redis_status == "connected" else "degraded"

           return HealthResponse(
               status=status,
               db=db_status,
               redis=redis_status,
           )
       ```

    2. Update src/api/__init__.py to export router:
       ```python
       from src.api.health import router as health_router

       __all__ = ["health_router"]
       ```

    3. Test the endpoint:
       ```bash
       # Start the server
       uv run uvicorn src.main:app --reload

       # In another terminal, test health endpoint
       curl http://localhost:8000/api/health
       ```

       Expected output:
       ```json
       {"status": "ok", "db": "connected", "redis": "connected"}
       ```
  </action>
  <verify>
    - `curl http://localhost:8000/api/health` returns JSON with status, db, redis
    - When db is down, db shows "disconnected"
    - When redis is down, redis shows "disconnected"
    - OpenAPI docs available at http://localhost:8000/docs
  </verify>
  <done>Health endpoint returns infrastructure status as required by INFRA-01</done>
</task>

</tasks>

<verification>
1. Server starts: `uv run uvicorn src.main:app --host 0.0.0.0 --port 8000`
2. Health check works: `curl http://localhost:8000/api/health`
   - Returns: `{"status": "ok", "db": "connected", "redis": "connected"}`
3. OpenAPI docs accessible: http://localhost:8000/docs
4. Structured logging visible in console (development) or JSON (production)
5. Graceful shutdown: Ctrl+C logs "shutting_down_application" and "connections_closed"
</verification>

<success_criteria>
- FastAPI server starts without error
- `/api/health` returns `{"status": "ok", "db": "connected", "redis": "connected"}`
- Lifespan properly creates and closes database and Redis connections
- Structured logs output during startup and shutdown
- OpenAPI documentation available at /docs
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
