---
phase: 03-personal-tax-simple
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/documents/__init__.py
  - src/documents/models.py
autonomous: true

must_haves:
  truths:
    - "W-2 form data can be represented as validated Pydantic model"
    - "1099-INT form data can be represented as validated Pydantic model"
    - "1099-DIV form data can be represented as validated Pydantic model"
    - "1099-NEC form data can be represented as validated Pydantic model"
    - "SSN format is validated (XXX-XX-XXXX)"
    - "EIN format is validated (XX-XXXXXXX)"
  artifacts:
    - path: "src/documents/models.py"
      provides: "Pydantic models for all tax form types"
      min_lines: 200
      contains: "class W2Data"
    - path: "src/documents/__init__.py"
      provides: "Module exports for document models"
  key_links:
    - from: "src/documents/models.py"
      to: "pydantic"
      via: "BaseModel inheritance"
      pattern: "class.*BaseModel"
---

<objective>
Create Pydantic models for tax document extraction with field validation.

Purpose: These models define the schema for extracted tax form data, ensuring type safety and format validation. Required for DOC-01 through DOC-04 (extraction accuracy requirements).

Output:
- src/documents/models.py with W2Data, Form1099INT, Form1099DIV, Form1099NEC models
- Phase 3 dependencies installed (anthropic, instructor, openpyxl, fsspec)
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-personal-tax-simple/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Phase 3 dependencies</name>
  <files>pyproject.toml</files>
  <action>
Add Phase 3 dependencies using uv:
```bash
uv add anthropic instructor openpyxl fsspec httpx
```

These libraries provide:
- anthropic: Claude API client with Vision support
- instructor: Structured LLM output with Pydantic validation
- openpyxl: Excel worksheet generation for Drake
- fsspec: Cloud storage abstraction (S3/GCS/local)
- httpx: Async HTTP for image fetching (may already be present as dev dep)

Do NOT add gcsfs or s3fs yet - add those when cloud storage backend is chosen.
  </action>
  <verify>
```bash
uv run python -c "import anthropic; import instructor; import openpyxl; import fsspec; print('OK')"
```
  </verify>
  <done>All Phase 3 dependencies importable</done>
</task>

<task type="auto">
  <name>Task 2: Create Pydantic models for tax forms</name>
  <files>src/documents/__init__.py, src/documents/models.py</files>
  <action>
Create src/documents/ directory and models.py with Pydantic models for each form type.

**W2Data model (Box 1-20):**
- employee_ssn: str with SSN validator (XXX-XX-XXXX format)
- employer_ein: str with EIN validator (XX-XXXXXXX format)
- employer_name, employee_name: str
- wages_tips_compensation: Decimal (Box 1)
- federal_tax_withheld: Decimal (Box 2)
- social_security_wages: Decimal (Box 3)
- social_security_tax: Decimal (Box 4)
- medicare_wages: Decimal (Box 5)
- medicare_tax: Decimal (Box 6)
- social_security_tips: Decimal = 0 (Box 7)
- allocated_tips: Decimal = 0 (Box 8)
- dependent_care_benefits: Decimal = 0 (Box 10)
- box_12_codes: list[dict] (code/amount pairs)
- statutory_employee, retirement_plan, third_party_sick_pay: bool (Box 13)
- state_wages, state_tax_withheld: Decimal (Box 16-17)
- confidence: str (HIGH/MEDIUM/LOW)
- uncertain_fields: list[str]

**Form1099INT model:**
- payer_name, payer_tin, recipient_tin: str
- interest_income: Decimal (Box 1)
- early_withdrawal_penalty: Decimal = 0 (Box 2)
- interest_us_savings_bonds: Decimal = 0 (Box 3)
- federal_tax_withheld: Decimal = 0 (Box 4)
- investment_expenses: Decimal = 0 (Box 5)
- foreign_tax_paid: Decimal = 0 (Box 6)
- tax_exempt_interest: Decimal = 0 (Box 8)
- private_activity_bond_interest: Decimal = 0 (Box 9)
- confidence: str

**Form1099DIV model:**
- payer_name, payer_tin, recipient_tin: str
- total_ordinary_dividends: Decimal (Box 1a)
- qualified_dividends: Decimal = 0 (Box 1b)
- total_capital_gain_distributions: Decimal = 0 (Box 2a)
- unrecaptured_1250_gain: Decimal = 0 (Box 2b)
- section_1202_gain: Decimal = 0 (Box 2c)
- collectibles_gain: Decimal = 0 (Box 2d)
- nondividend_distributions: Decimal = 0 (Box 3)
- federal_tax_withheld: Decimal = 0 (Box 4)
- section_199a_dividends: Decimal = 0 (Box 5)
- foreign_tax_paid: Decimal = 0 (Box 7)
- exempt_interest_dividends: Decimal = 0 (Box 12)
- confidence: str

**Form1099NEC model:**
- payer_name, payer_tin, recipient_name, recipient_tin: str
- nonemployee_compensation: Decimal (Box 1)
- direct_sales: bool = False (Box 2)
- federal_tax_withheld: Decimal = 0 (Box 4)
- state_tax_withheld: Decimal = 0 (Boxes 5-7)
- confidence: str

**Validators:**
- SSN validator: Strips non-digits, validates 9 digits, formats as XXX-XX-XXXX
- EIN validator: Strips non-digits, validates 9 digits, formats as XX-XXXXXXX
- Use Decimal for all monetary fields (not float) for precision

**DocumentType enum:**
- W2, FORM_1099_INT, FORM_1099_DIV, FORM_1099_NEC, UNKNOWN

Create __init__.py exporting all models and DocumentType.
  </action>
  <verify>
```bash
uv run python -c "
from src.documents.models import W2Data, Form1099INT, Form1099DIV, Form1099NEC, DocumentType
from decimal import Decimal

# Test W2 with valid data
w2 = W2Data(
    employee_ssn='123-45-6789',
    employer_ein='12-3456789',
    employer_name='Test Corp',
    employee_name='John Doe',
    wages_tips_compensation=Decimal('50000.00'),
    federal_tax_withheld=Decimal('5000.00'),
    social_security_wages=Decimal('50000.00'),
    social_security_tax=Decimal('3100.00'),
    medicare_wages=Decimal('50000.00'),
    medicare_tax=Decimal('725.00'),
    confidence='HIGH'
)
print(f'W2 SSN: {w2.employee_ssn}')

# Test 1099-INT
int_form = Form1099INT(
    payer_name='Bank',
    payer_tin='12-3456789',
    recipient_tin='123-45-6789',
    interest_income=Decimal('100.00'),
    confidence='HIGH'
)
print(f'1099-INT interest: {int_form.interest_income}')

print('All models validated successfully')
"
```
  </verify>
  <done>W2Data, Form1099INT, Form1099DIV, Form1099NEC models created with SSN/EIN validators, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create model tests</name>
  <files>tests/documents/__init__.py, tests/documents/test_models.py</files>
  <action>
Create comprehensive tests for document models covering:

**SSN validation tests:**
- Valid SSN with dashes (123-45-6789) -> accepted, formatted correctly
- Valid SSN without dashes (123456789) -> accepted, formatted with dashes
- SSN with spaces (123 45 6789) -> accepted after cleaning
- Invalid SSN (too few digits) -> ValidationError
- Invalid SSN (too many digits) -> ValidationError

**EIN validation tests:**
- Valid EIN with dash (12-3456789) -> accepted
- Valid EIN without dash (123456789) -> accepted, formatted with dash
- Invalid EIN -> ValidationError

**W2Data tests:**
- Complete valid W2 -> all fields populated
- W2 with optional fields missing -> defaults applied
- W2 with box_12_codes list -> parsed correctly
- Invalid monetary values -> ValidationError

**Form1099INT tests:**
- Valid form with required fields
- Optional fields default to 0

**Form1099DIV tests:**
- Valid form with required fields
- Capital gain distribution fields

**Form1099NEC tests:**
- Valid form with required fields
- direct_sales boolean handling

**DocumentType enum tests:**
- All values accessible
- String representation matches expected

Use pytest with parametrize for validation edge cases.
  </action>
  <verify>
```bash
uv run pytest tests/documents/test_models.py -v
```
All tests pass.
  </verify>
  <done>20+ tests covering all models and validators pass</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Dependencies installed:
```bash
uv run python -c "import anthropic; import instructor; import openpyxl; import fsspec; print('All deps OK')"
```

2. Models importable and functional:
```bash
uv run python -c "from src.documents import W2Data, Form1099INT, Form1099DIV, Form1099NEC, DocumentType; print('Models OK')"
```

3. All tests pass:
```bash
uv run pytest tests/documents/ -v
```
</verification>

<success_criteria>
- anthropic, instructor, openpyxl, fsspec installed and importable
- W2Data model with SSN/EIN validators working
- Form1099INT, Form1099DIV, Form1099NEC models complete
- DocumentType enum defined
- 20+ unit tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/03-personal-tax-simple/03-01-SUMMARY.md`
</output>
