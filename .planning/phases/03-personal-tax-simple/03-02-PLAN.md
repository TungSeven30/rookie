---
phase: 03-personal-tax-simple
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/integrations/__init__.py
  - src/integrations/storage.py
  - src/documents/scanner.py
autonomous: true

must_haves:
  truths:
    - "Client folder can be scanned for documents from local filesystem"
    - "Client folder can be scanned from cloud storage URLs"
    - "Scanner returns document metadata (path, name, size, modified)"
    - "Only supported file types returned (pdf, jpg, jpeg, png)"
  artifacts:
    - path: "src/integrations/storage.py"
      provides: "fsspec wrapper for cloud storage abstraction"
      exports: ["get_filesystem", "read_file", "list_files"]
    - path: "src/documents/scanner.py"
      provides: "Client folder scanning for tax documents"
      exports: ["scan_client_folder", "ClientDocument"]
  key_links:
    - from: "src/documents/scanner.py"
      to: "src/integrations/storage.py"
      via: "fsspec filesystem"
      pattern: "get_filesystem"
---

<objective>
Create storage integration and client folder scanner for document discovery.

Purpose: Enables the Personal Tax Agent to discover documents in a client's folder, supporting both local filesystem and cloud storage (S3/GCS). Required for INT-04 (client folder scanner) and PTAX-02 (scan client folder).

Output:
- src/integrations/storage.py with fsspec wrapper
- src/documents/scanner.py with ClientDocument dataclass and scan function
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-personal-tax-simple/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage integration module</name>
  <files>src/integrations/__init__.py, src/integrations/storage.py</files>
  <action>
Create src/integrations/ directory with fsspec wrapper.

**storage.py functions:**

```python
def get_filesystem(url: str) -> fsspec.AbstractFileSystem:
    """Get filesystem for URL, auto-detecting protocol.

    Args:
        url: Storage URL (file://, s3://, gs://, or local path)

    Returns:
        Filesystem instance for the protocol

    Examples:
        get_filesystem("s3://bucket/path") -> S3FileSystem
        get_filesystem("/local/path") -> LocalFileSystem
        get_filesystem("file:///local/path") -> LocalFileSystem
    """
```

```python
async def read_file(url: str, path: str) -> bytes:
    """Read file bytes from storage.

    Args:
        url: Base storage URL
        path: File path within storage

    Returns:
        File contents as bytes
    """
```

```python
def list_files(url: str, path: str = "") -> list[dict]:
    """List files in storage path.

    Args:
        url: Base storage URL
        path: Subdirectory path (optional)

    Returns:
        List of file info dicts with name, size, type, mtime
    """
```

**Implementation notes:**
- Use fsspec.filesystem() to auto-detect protocol from URL scheme
- For local paths without scheme, default to local filesystem
- Handle both sync and async operations (fsspec supports both)
- Return detailed file info for downstream filtering

Create __init__.py exporting storage functions.
  </action>
  <verify>
```bash
uv run python -c "
from src.integrations.storage import get_filesystem, list_files
import tempfile
import os

# Create temp directory with test files
with tempfile.TemporaryDirectory() as tmpdir:
    # Create test files
    (open(os.path.join(tmpdir, 'test.pdf'), 'w')).close()
    (open(os.path.join(tmpdir, 'test.jpg'), 'w')).close()

    # Test local filesystem
    fs = get_filesystem(tmpdir)
    print(f'Filesystem type: {type(fs).__name__}')

    files = list_files(tmpdir)
    print(f'Files found: {len(files)}')
    for f in files:
        print(f'  - {f[\"name\"]}')

print('Storage integration OK')
"
```
  </verify>
  <done>Storage module created with get_filesystem, list_files, read_file functions working on local filesystem</done>
</task>

<task type="auto">
  <name>Task 2: Create client folder scanner</name>
  <files>src/documents/scanner.py</files>
  <action>
Create scanner.py with ClientDocument dataclass and scanning function.

**ClientDocument dataclass:**
```python
@dataclass
class ClientDocument:
    path: str           # Full path to document
    name: str           # Filename only
    size: int           # File size in bytes
    modified: datetime  # Last modified time
    extension: str      # File extension (pdf, jpg, etc.)
```

**scan_client_folder function:**
```python
def scan_client_folder(
    storage_url: str,
    client_id: str,
    tax_year: int,
) -> list[ClientDocument]:
    """Scan client folder for tax documents.

    Folder convention: {storage_url}/{client_id}/{tax_year}/

    Args:
        storage_url: Base storage URL (s3://bucket, gs://bucket, /local/path)
        client_id: Client identifier
        tax_year: Tax year to scan

    Returns:
        List of discovered documents (pdf, jpg, jpeg, png only)
        Empty list if folder doesn't exist

    Raises:
        Nothing - returns empty list on folder not found
    """
```

**Implementation notes:**
- Build folder path as f"{storage_url}/{client_id}/{tax_year}/"
- Filter for supported extensions: .pdf, .jpg, .jpeg, .png
- Case-insensitive extension matching
- Return empty list (not raise) if folder doesn't exist
- Log warning if folder not found (for debugging)
- Sort results by filename for deterministic ordering

Update src/documents/__init__.py to export scanner types.
  </action>
  <verify>
```bash
uv run python -c "
from src.documents.scanner import scan_client_folder, ClientDocument
import tempfile
import os

# Create test client folder structure
with tempfile.TemporaryDirectory() as tmpdir:
    client_dir = os.path.join(tmpdir, 'client123', '2024')
    os.makedirs(client_dir)

    # Create test documents
    open(os.path.join(client_dir, 'w2_employer.pdf'), 'w').close()
    open(os.path.join(client_dir, '1099int_bank.jpg'), 'w').close()
    open(os.path.join(client_dir, 'notes.txt'), 'w').close()  # Should be filtered out

    # Scan
    docs = scan_client_folder(tmpdir, 'client123', 2024)
    print(f'Found {len(docs)} documents')
    for doc in docs:
        print(f'  - {doc.name} ({doc.extension})')

    # Verify filtering
    assert len(docs) == 2, f'Expected 2 docs (pdf, jpg), got {len(docs)}'
    extensions = {d.extension for d in docs}
    assert 'txt' not in extensions, 'txt should be filtered'

print('Scanner OK')
"
```
  </verify>
  <done>scan_client_folder returns ClientDocument list, filters for supported file types</done>
</task>

<task type="auto">
  <name>Task 3: Create scanner and storage tests</name>
  <files>tests/integrations/__init__.py, tests/integrations/test_storage.py, tests/documents/test_scanner.py</files>
  <action>
Create tests for storage and scanner modules.

**test_storage.py tests:**
- get_filesystem with local path returns LocalFileSystem
- get_filesystem with file:// URL returns LocalFileSystem
- list_files returns file info dicts
- list_files on empty directory returns empty list
- read_file returns file contents as bytes

**test_scanner.py tests:**
- scan_client_folder finds pdf files
- scan_client_folder finds jpg/jpeg/png files
- scan_client_folder filters out unsupported extensions
- scan_client_folder returns empty list for nonexistent folder
- scan_client_folder builds correct path from client_id and tax_year
- ClientDocument has correct attributes
- Results sorted by filename

Use pytest fixtures with tempfile.TemporaryDirectory for isolation.
  </action>
  <verify>
```bash
uv run pytest tests/integrations/test_storage.py tests/documents/test_scanner.py -v
```
All tests pass.
  </verify>
  <done>15+ tests covering storage and scanner modules pass</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Storage functions work:
```bash
uv run python -c "from src.integrations import get_filesystem, list_files; print('Storage OK')"
```

2. Scanner works:
```bash
uv run python -c "from src.documents import scan_client_folder, ClientDocument; print('Scanner OK')"
```

3. All tests pass:
```bash
uv run pytest tests/integrations/ tests/documents/test_scanner.py -v
```
</verification>

<success_criteria>
- fsspec wrapper provides filesystem abstraction for local and cloud
- scan_client_folder discovers documents in client folder
- Only supported file types (pdf, jpg, jpeg, png) returned
- Empty list returned for nonexistent folders (no exception)
- 15+ unit tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/03-personal-tax-simple/03-02-SUMMARY.md`
</output>
