---
phase: 03-personal-tax-simple
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-03"]
files_modified:
  - src/documents/extractor.py
autonomous: true

must_haves:
  truths:
    - "W-2 images can be extracted into validated W2Data model"
    - "1099-INT images can be extracted into validated Form1099INT model"
    - "1099-DIV images can be extracted into validated Form1099DIV model"
    - "1099-NEC images can be extracted into validated Form1099NEC model"
    - "Extraction uses Claude Vision API with Instructor validation"
    - "Extraction includes self-reported confidence from LLM"
  artifacts:
    - path: "src/documents/extractor.py"
      provides: "Document extraction using Claude Vision + Instructor"
      exports: ["extract_document", "extract_w2", "extract_1099_int", "extract_1099_div", "extract_1099_nec"]
      min_lines: 150
  key_links:
    - from: "src/documents/extractor.py"
      to: "src/documents/models.py"
      via: "Pydantic response models"
      pattern: "response_model=W2Data"
    - from: "src/documents/extractor.py"
      to: "src/documents/classifier.py"
      via: "Document type routing"
      pattern: "classify_document"
---

<objective>
Create document extraction using Claude Vision API with Instructor for validated output.

Purpose: This is the core extraction capability that achieves >95% field accuracy on tax documents. Required for DOC-01 through DOC-04 (extraction requirements).

Output:
- src/documents/extractor.py with extraction functions for each document type
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-personal-tax-simple/03-RESEARCH.md
@src/documents/models.py
@src/documents/classifier.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create document extractor module</name>
  <files>src/documents/extractor.py</files>
  <action>
Create extractor.py with Claude Vision extraction using Instructor.

**Core extraction function:**
```python
async def extract_document(
    image_bytes: bytes,
    document_type: DocumentType,
    media_type: str = "image/jpeg",
    client: AsyncAnthropic | None = None,
) -> W2Data | Form1099INT | Form1099DIV | Form1099NEC:
    """Extract document data based on type.

    Args:
        image_bytes: Document image as bytes
        document_type: Type of document to extract
        media_type: MIME type (image/jpeg, image/png, application/pdf)
        client: Optional Anthropic client (for testing)

    Returns:
        Extracted data model based on document_type

    Raises:
        ValueError: If document_type is UNKNOWN
    """
```

**Type-specific extraction functions:**

```python
async def extract_w2(
    image_bytes: bytes,
    media_type: str = "image/jpeg",
    client: AsyncAnthropic | None = None,
) -> W2Data:
    """Extract W-2 form data using Claude Vision.

    Prompt instructs Claude to:
    - Extract all numbered boxes (1-20)
    - Format SSN as XXX-XX-XXXX
    - Format EIN as XX-XXXXXXX
    - Report confidence level (HIGH/MEDIUM/LOW)
    - Note any uncertain fields in uncertain_fields list
    """
```

```python
async def extract_1099_int(
    image_bytes: bytes,
    media_type: str = "image/jpeg",
    client: AsyncAnthropic | None = None,
) -> Form1099INT:
    """Extract 1099-INT form data."""
```

```python
async def extract_1099_div(
    image_bytes: bytes,
    media_type: str = "image/jpeg",
    client: AsyncAnthropic | None = None,
) -> Form1099DIV:
    """Extract 1099-DIV form data."""
```

```python
async def extract_1099_nec(
    image_bytes: bytes,
    media_type: str = "image/jpeg",
    client: AsyncAnthropic | None = None,
) -> Form1099NEC:
    """Extract 1099-NEC form data."""
```

**Implementation details:**
- Use instructor.from_anthropic(AsyncAnthropic()) wrapper
- Model: claude-sonnet-4-5-20250514 (good accuracy, faster than Opus)
- Max tokens: 2048 for complete extraction
- Base64 encode image_bytes for API
- Prompts should:
  - Describe exact box locations for each form type
  - Request HIGH/MEDIUM/LOW confidence assessment
  - Ask for uncertain_fields list when confidence < HIGH
  - Instruct to return 0 for empty monetary fields

**Mock mode:**
Check MOCK_LLM=true environment variable. If set, return realistic mock data instead of calling API. This enables testing without API key.

Update src/documents/__init__.py to export extractor functions.
  </action>
  <verify>
```bash
# Test with mock mode
MOCK_LLM=true uv run python -c "
import asyncio
from src.documents.extractor import extract_document, extract_w2
from src.documents.models import DocumentType, W2Data

async def test():
    # Test direct W2 extraction
    w2 = await extract_w2(b'fake image', 'image/jpeg')
    print(f'W2 extracted: wages={w2.wages_tips_compensation}, confidence={w2.confidence}')
    assert isinstance(w2, W2Data)

    # Test routed extraction
    result = await extract_document(b'fake', DocumentType.W2, 'image/jpeg')
    assert isinstance(result, W2Data)

    print('Extractor mock mode OK')

asyncio.run(test())
"
```
  </verify>
  <done>extract_document and type-specific extractors work in mock mode</done>
</task>

<task type="auto">
  <name>Task 2: Create extraction prompts module</name>
  <files>src/documents/prompts.py</files>
  <action>
Create prompts.py with detailed extraction prompts for each document type.

**Purpose:** Separating prompts makes them easier to tune for accuracy and test.

**W2_EXTRACTION_PROMPT:**
```python
W2_EXTRACTION_PROMPT = '''Extract all data from this W-2 Wage and Tax Statement.

For each field, extract the exact value shown. Box locations:
- Box A: Employee's Social Security Number (format: XXX-XX-XXXX)
- Box B: Employer Identification Number (format: XX-XXXXXXX)
- Box C: Employer's name, address, and ZIP code
- Box E: Employee's name
- Box F: Employee's address
- Box 1: Wages, tips, other compensation
- Box 2: Federal income tax withheld
- Box 3: Social Security wages
- Box 4: Social Security tax withheld
- Box 5: Medicare wages and tips
- Box 6: Medicare tax withheld
- Box 7: Social Security tips
- Box 8: Allocated tips
- Box 10: Dependent care benefits
- Box 12: See codes (a-d, multiple possible)
- Box 13: Checkboxes (Statutory employee, Retirement plan, Third-party sick pay)
- Box 16: State wages, tips, etc.
- Box 17: State income tax

Set confidence to:
- HIGH: All fields clearly visible and readable
- MEDIUM: Some fields partially obscured or unclear
- LOW: Multiple critical fields hard to read

Add any uncertain field names to uncertain_fields list.
For empty monetary boxes, use 0.
'''
```

**Similar prompts for 1099-INT, 1099-DIV, 1099-NEC:**
- Include specific box descriptions for each form
- Request confidence assessment
- Specify formatting expectations

Export prompts for use in extractor.py.
  </action>
  <verify>
```bash
uv run python -c "
from src.documents.prompts import W2_EXTRACTION_PROMPT, FORM_1099_INT_PROMPT, FORM_1099_DIV_PROMPT, FORM_1099_NEC_PROMPT
print(f'W2 prompt length: {len(W2_EXTRACTION_PROMPT)} chars')
print(f'1099-INT prompt length: {len(FORM_1099_INT_PROMPT)} chars')
print(f'1099-DIV prompt length: {len(FORM_1099_DIV_PROMPT)} chars')
print(f'1099-NEC prompt length: {len(FORM_1099_NEC_PROMPT)} chars')
print('Prompts module OK')
"
```
  </verify>
  <done>Extraction prompts defined for all four document types</done>
</task>

<task type="auto">
  <name>Task 3: Create extractor tests</name>
  <files>tests/documents/test_extractor.py</files>
  <action>
Create tests for document extraction module.

**Mock mode tests (run without API key):**
- extract_w2 returns W2Data with valid structure
- extract_1099_int returns Form1099INT with valid structure
- extract_1099_div returns Form1099DIV with valid structure
- extract_1099_nec returns Form1099NEC with valid structure
- extract_document routes to correct extractor based on DocumentType
- extract_document raises ValueError for UNKNOWN type
- Mock data has realistic field values
- confidence field is set (HIGH/MEDIUM/LOW)

**Prompt tests:**
- W2 prompt mentions all critical boxes
- 1099-INT prompt mentions interest income
- 1099-DIV prompt mentions dividends
- 1099-NEC prompt mentions nonemployee compensation
- All prompts request confidence assessment

Use pytest with MOCK_LLM=true in tests.
  </action>
  <verify>
```bash
MOCK_LLM=true uv run pytest tests/documents/test_extractor.py -v
```
All tests pass.
  </verify>
  <done>15+ tests covering extraction functions in mock mode pass</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Extractor works in mock mode:
```bash
MOCK_LLM=true uv run python -c "
import asyncio
from src.documents import extract_document, DocumentType
result = asyncio.run(extract_document(b'test', DocumentType.W2, 'image/jpeg'))
print(f'Extracted: {type(result).__name__}')
"
```

2. All prompts defined:
```bash
uv run python -c "from src.documents.prompts import W2_EXTRACTION_PROMPT; print('Prompts OK')"
```

3. All tests pass:
```bash
MOCK_LLM=true uv run pytest tests/documents/test_extractor.py -v
```
</verification>

<success_criteria>
- extract_document routes to correct type-specific extractor
- All extractors return validated Pydantic models
- Mock mode enables testing without Anthropic API key
- Prompts include detailed box descriptions for each form type
- 15+ unit tests passing in mock mode
</success_criteria>

<output>
After completion, create `.planning/phases/03-personal-tax-simple/03-04-SUMMARY.md`
</output>
