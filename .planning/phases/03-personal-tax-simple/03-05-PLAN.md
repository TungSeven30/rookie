---
phase: 03-personal-tax-simple
plan: 05
type: tdd
wave: 4
depends_on: ["03-01"]
files_modified:
  - src/agents/personal_tax/__init__.py
  - src/agents/personal_tax/calculator.py
  - tests/agents/personal_tax/test_calculator.py
autonomous: true

must_haves:
  truths:
    - "Income from multiple W-2s is aggregated correctly"
    - "Income from multiple 1099s is aggregated by type"
    - "Standard deduction is looked up by filing status and tax year"
    - "Standard vs itemized comparison selects higher deduction"
    - "Tax liability is calculated using correct marginal brackets"
    - "Prior year variances >10% are flagged"
  artifacts:
    - path: "src/agents/personal_tax/calculator.py"
      provides: "Tax calculation functions"
      exports: ["aggregate_income", "calculate_deductions", "calculate_tax", "compare_years"]
      min_lines: 200
    - path: "tests/agents/personal_tax/test_calculator.py"
      provides: "TDD tests for tax calculations"
      min_lines: 150
  key_links:
    - from: "src/agents/personal_tax/calculator.py"
      to: "src/documents/models.py"
      via: "Form data models"
      pattern: "W2Data|Form1099"
---

<objective>
Create tax calculation logic using TDD approach.

Purpose: Tax calculations are pure functions with defined inputs/outputs, making them ideal for TDD. This ensures correctness of income aggregation, deduction selection, and bracket-based tax computation. Required for PTAX-03 through PTAX-06 and PTAX-12.

Output:
- src/agents/personal_tax/calculator.py with all tax calculation functions
- Comprehensive test suite written before implementation (TDD)
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-personal-tax-simple/03-RESEARCH.md
@src/documents/models.py
</context>

<feature>
  <name>Tax Calculator</name>
  <files>src/agents/personal_tax/calculator.py, tests/agents/personal_tax/test_calculator.py</files>
  <behavior>
**Income Aggregation (PTAX-03):**
- Input: List of extracted document data (W2Data, Form1099INT, etc.)
- Output: IncomeSummary with totals by type

| Input | Output |
|-------|--------|
| [W2($50000), W2($30000)] | total_wages=$80000 |
| [1099INT($100), 1099INT($50)] | total_interest=$150 |
| [1099DIV($200)] | total_dividends=$200 |
| [1099NEC($5000)] | total_nec=$5000 |
| [W2($50000), 1099INT($100)] | total_wages=$50000, total_interest=$100 |

**Deduction Calculation (PTAX-04):**
- Input: IncomeSummary, filing_status, tax_year
- Output: DeductionResult with method and amount

2024 Standard Deductions:
- Single: $14,600
- MFJ: $29,200
- MFS: $14,600
- HOH: $21,900

| Scenario | Output |
|----------|--------|
| Single, no itemized | standard=$14600, method="standard" |
| MFJ, itemized=$35000 | itemized=$35000, method="itemized" |
| MFJ, itemized=$20000 | standard=$29200, method="standard" |

**Tax Calculation (PTAX-06):**
- Input: taxable_income, filing_status, tax_year
- Output: TaxResult with total tax and bracket breakdown

2024 Single Brackets:
- 10%: $0 - $11,600
- 12%: $11,601 - $47,150
- 22%: $47,151 - $100,525
- 24%: $100,526 - $191,950
- 32%: $191,951 - $243,725
- 35%: $243,726 - $609,350
- 37%: $609,351+

| Taxable Income | Tax |
|----------------|-----|
| $10,000 | $1,000 (10% of $10k) |
| $50,000 | $1,160 + $4,266 + $627.78 = $6,053.78 |
| $100,000 | $1,160 + $4,266 + $11,742.50 + ($100k-$100,525)*0 = ~$17,168 |

**Prior Year Comparison (PTAX-12):**
- Input: current_values, prior_values, threshold=10%
- Output: List of VarianceItem for fields exceeding threshold

| Current | Prior | Variance |
|---------|-------|----------|
| wages=$80000 | wages=$70000 | 14.3% increase - FLAGGED |
| interest=$100 | interest=$95 | 5.3% - not flagged |
| wages=$50000 | wages=$0 | new income - FLAGGED |
  </behavior>
  <implementation>
**TDD Cycle:**

**RED Phase:** Write failing tests first
1. test_aggregate_income_single_w2
2. test_aggregate_income_multiple_w2
3. test_aggregate_income_mixed_documents
4. test_standard_deduction_single
5. test_standard_deduction_mfj
6. test_itemized_beats_standard
7. test_standard_beats_itemized
8. test_tax_10_percent_bracket_only
9. test_tax_crosses_brackets
10. test_tax_high_income
11. test_variance_flags_10_percent
12. test_variance_ignores_small_changes
13. test_variance_new_income_source

**GREEN Phase:** Implement functions
- IncomeSummary dataclass
- DeductionResult dataclass
- TaxResult dataclass
- VarianceItem dataclass
- aggregate_income()
- get_standard_deduction()
- calculate_deductions()
- calculate_tax()
- compare_years()

**Data structures:**
```python
@dataclass
class IncomeSummary:
    total_wages: Decimal
    total_interest: Decimal
    total_dividends: Decimal
    total_qualified_dividends: Decimal
    total_nec: Decimal
    total_other: Decimal
    total_income: Decimal
    federal_withholding: Decimal

@dataclass
class DeductionResult:
    method: str  # "standard" or "itemized"
    amount: Decimal
    standard_amount: Decimal
    itemized_amount: Decimal

@dataclass
class TaxResult:
    total_tax: Decimal
    bracket_breakdown: list[dict]  # [{bracket, rate, tax_in_bracket}]
    effective_rate: Decimal

@dataclass
class VarianceItem:
    field: str
    current_value: Decimal
    prior_value: Decimal
    variance_pct: Decimal
    direction: str  # "increase" or "decrease"
```

Store tax brackets and standard deductions as constants indexed by (year, filing_status).
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for calculator</name>
  <files>src/agents/__init__.py, src/agents/personal_tax/__init__.py, tests/agents/__init__.py, tests/agents/personal_tax/__init__.py, tests/agents/personal_tax/test_calculator.py</files>
  <action>
Create directory structure and write comprehensive tests BEFORE implementation.

**Directory setup:**
- src/agents/__init__.py
- src/agents/personal_tax/__init__.py
- tests/agents/__init__.py
- tests/agents/personal_tax/__init__.py

**test_calculator.py tests:**

```python
# Income aggregation tests
def test_aggregate_income_single_w2():
    """Single W-2 should produce correct totals."""
    w2 = W2Data(wages_tips_compensation=Decimal("50000"), ...)
    result = aggregate_income([w2])
    assert result.total_wages == Decimal("50000")
    assert result.total_income == Decimal("50000")

def test_aggregate_income_multiple_w2():
    """Multiple W-2s should sum wages."""
    ...

def test_aggregate_income_mixed_documents():
    """Mix of W-2 and 1099s should categorize correctly."""
    ...

# Deduction tests
def test_standard_deduction_single_2024():
    """Single filer 2024 standard deduction is $14,600."""
    result = calculate_deductions(IncomeSummary(...), "single", 2024)
    assert result.standard_amount == Decimal("14600")

def test_standard_deduction_mfj_2024():
    """MFJ 2024 standard deduction is $29,200."""
    ...

def test_itemized_beats_standard():
    """Higher itemized should be selected."""
    result = calculate_deductions(..., itemized_total=Decimal("35000"))
    assert result.method == "itemized"
    assert result.amount == Decimal("35000")

# Tax calculation tests
def test_tax_10_percent_bracket_only():
    """Income under $11,600 is 10%."""
    result = calculate_tax(Decimal("10000"), "single", 2024)
    assert result.total_tax == Decimal("1000")

def test_tax_crosses_brackets():
    """Income crossing brackets uses marginal rates."""
    # $50,000 taxable: 10% up to 11600, 12% up to 47150, 22% rest
    result = calculate_tax(Decimal("50000"), "single", 2024)
    expected = Decimal("1160") + Decimal("4266") + Decimal("627.00")  # Approx
    assert abs(result.total_tax - expected) < Decimal("10")  # Within $10

# Variance tests
def test_variance_flags_10_percent_increase():
    """10%+ increase should be flagged."""
    variances = compare_years(
        {"wages": Decimal("80000")},
        {"wages": Decimal("70000")},
    )
    assert len(variances) == 1
    assert variances[0].direction == "increase"

def test_variance_ignores_small_changes():
    """Under 10% change not flagged."""
    variances = compare_years(
        {"wages": Decimal("75000")},
        {"wages": Decimal("70000")},
    )
    assert len(variances) == 0
```

Tests should FAIL because calculator.py doesn't exist yet.
  </action>
  <verify>
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v 2>&1 | head -30
# Should show import errors or test failures (RED phase)
```
  </verify>
  <done>Tests written, all fail due to missing implementation (RED phase complete)</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement calculator to pass tests</name>
  <files>src/agents/personal_tax/calculator.py</files>
  <action>
Implement calculator.py with all functions to make tests pass.

**Constants (store at module level):**
```python
# 2024 Standard Deductions
STANDARD_DEDUCTIONS = {
    (2024, "single"): Decimal("14600"),
    (2024, "mfj"): Decimal("29200"),
    (2024, "mfs"): Decimal("14600"),
    (2024, "hoh"): Decimal("21900"),
    # Add 2023 for prior year
    (2023, "single"): Decimal("13850"),
    (2023, "mfj"): Decimal("27700"),
    (2023, "mfs"): Decimal("13850"),
    (2023, "hoh"): Decimal("20800"),
}

# 2024 Tax Brackets (Single)
TAX_BRACKETS = {
    (2024, "single"): [
        (Decimal("11600"), Decimal("0.10")),
        (Decimal("47150"), Decimal("0.12")),
        (Decimal("100525"), Decimal("0.22")),
        (Decimal("191950"), Decimal("0.24")),
        (Decimal("243725"), Decimal("0.32")),
        (Decimal("609350"), Decimal("0.35")),
        (None, Decimal("0.37")),  # No upper limit
    ],
    (2024, "mfj"): [
        (Decimal("23200"), Decimal("0.10")),
        (Decimal("94300"), Decimal("0.12")),
        (Decimal("201050"), Decimal("0.22")),
        (Decimal("383900"), Decimal("0.24")),
        (Decimal("487450"), Decimal("0.32")),
        (Decimal("731200"), Decimal("0.35")),
        (None, Decimal("0.37")),
    ],
    # Add remaining filing statuses
}
```

**Implementation:**

1. **aggregate_income(documents: list) -> IncomeSummary**
   - Iterate documents, categorize by type
   - Sum each category
   - Calculate total_income as sum of all categories

2. **get_standard_deduction(filing_status: str, tax_year: int) -> Decimal**
   - Lookup in STANDARD_DEDUCTIONS
   - Raise ValueError if not found

3. **calculate_deductions(income: IncomeSummary, filing_status: str, tax_year: int, itemized_total: Decimal = 0) -> DeductionResult**
   - Get standard deduction
   - Compare with itemized
   - Return result with method and amount

4. **calculate_tax(taxable_income: Decimal, filing_status: str, tax_year: int) -> TaxResult**
   - Get brackets for year/status
   - Fill each bracket sequentially
   - Track breakdown by bracket
   - Calculate effective rate

5. **compare_years(current: dict, prior: dict, threshold: Decimal = 10) -> list[VarianceItem]**
   - For each field in current, compare to prior
   - Calculate percentage change
   - Flag if exceeds threshold
   - Handle new income (prior=0) as 100% increase

Update src/agents/personal_tax/__init__.py to export all functions and dataclasses.
  </action>
  <verify>
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v
# All tests should PASS (GREEN phase)
```
  </verify>
  <done>All calculator tests pass (GREEN phase complete)</done>
</task>

<task type="auto">
  <name>Task 3: REFACTOR - Clean up and add edge case tests</name>
  <files>src/agents/personal_tax/calculator.py, tests/agents/personal_tax/test_calculator.py</files>
  <action>
Refactor implementation and add additional edge case tests.

**Refactoring opportunities:**
- Extract bracket calculation into helper function
- Add type hints throughout
- Add docstrings with examples
- Ensure Decimal precision (2 decimal places for money)

**Additional edge case tests:**
- test_aggregate_income_empty_list -> returns zero totals
- test_aggregate_income_with_withholding -> sums federal_withholding
- test_deduction_unknown_filing_status -> raises ValueError
- test_tax_zero_income -> returns zero tax
- test_tax_at_bracket_boundary -> correct calculation
- test_variance_both_zero -> no variance
- test_variance_decrease -> direction="decrease"
- test_variance_custom_threshold -> respects threshold parameter

Run all tests to ensure refactoring didn't break anything.
  </action>
  <verify>
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v --tb=short
# All tests still pass, including new edge cases
```
  </verify>
  <done>Calculator refactored, 20+ tests passing including edge cases</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Calculator importable:
```bash
uv run python -c "from src.agents.personal_tax import aggregate_income, calculate_deductions, calculate_tax, compare_years; print('Calculator OK')"
```

2. All tests pass:
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v
```

3. Manual calculation check:
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import calculate_tax

# $50,000 single: should be about $6,053
result = calculate_tax(Decimal('50000'), 'single', 2024)
print(f'Tax on \$50,000: \${result.total_tax:,.2f}')
print(f'Effective rate: {result.effective_rate * 100:.2f}%')
"
```
</verification>

<success_criteria>
- TDD cycle completed (RED -> GREEN -> REFACTOR)
- Income aggregation sums correctly by type
- Standard deduction lookup by filing status and year
- Itemized vs standard comparison selects higher
- Tax calculation uses correct marginal brackets
- Variance detection flags >10% changes
- 20+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/03-personal-tax-simple/03-05-SUMMARY.md`
</output>
