---
phase: 03-personal-tax-simple
plan: 05
type: tdd
wave: 4
depends_on: ["03-01"]
files_modified:
  - src/agents/personal_tax/__init__.py
  - src/agents/personal_tax/calculator.py
  - tests/agents/personal_tax/test_calculator.py
autonomous: true

must_haves:
  truths:
    - "Income from multiple W-2s is aggregated correctly"
    - "Income from multiple 1099s is aggregated by type"
    - "Standard deduction is looked up by filing status and tax year"
    - "Standard vs itemized comparison selects higher deduction"
    - "Tax liability is calculated using correct marginal brackets"
    - "Applicable credits are evaluated and reduce tax liability"
    - "Prior year variances >10% are flagged"
  artifacts:
    - path: "src/agents/personal_tax/calculator.py"
      provides: "Tax calculation functions including credits"
      exports: ["aggregate_income", "calculate_deductions", "calculate_tax", "evaluate_credits", "compare_years"]
      min_lines: 250
    - path: "tests/agents/personal_tax/test_calculator.py"
      provides: "TDD tests for tax calculations including credits"
      min_lines: 200
  key_links:
    - from: "src/agents/personal_tax/calculator.py"
      to: "src/documents/models.py"
      via: "Form data models"
      pattern: "W2Data|Form1099"
---

<objective>
Create tax calculation logic using TDD approach, including credits evaluation.

Purpose: Tax calculations are pure functions with defined inputs/outputs, making them ideal for TDD. This ensures correctness of income aggregation, deduction selection, bracket-based tax computation, and credits evaluation. Required for PTAX-03 through PTAX-06 (including PTAX-05 credits) and PTAX-12.

Output:
- src/agents/personal_tax/calculator.py with all tax calculation functions including evaluate_credits
- Comprehensive test suite written before implementation (TDD)
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-personal-tax-simple/03-RESEARCH.md
@src/documents/models.py
</context>

<feature>
  <name>Tax Calculator with Credits</name>
  <files>src/agents/personal_tax/calculator.py, tests/agents/personal_tax/test_calculator.py</files>
  <behavior>
**Income Aggregation (PTAX-03):**
- Input: List of extracted document data (W2Data, Form1099INT, etc.)
- Output: IncomeSummary with totals by type

| Input | Output |
|-------|--------|
| [W2($50000), W2($30000)] | total_wages=$80000 |
| [1099INT($100), 1099INT($50)] | total_interest=$150 |
| [1099DIV($200)] | total_dividends=$200 |
| [1099NEC($5000)] | total_nec=$5000 |
| [W2($50000), 1099INT($100)] | total_wages=$50000, total_interest=$100 |

**Deduction Calculation (PTAX-04):**
- Input: IncomeSummary, filing_status, tax_year
- Output: DeductionResult with method and amount

2024 Standard Deductions:
- Single: $14,600
- MFJ: $29,200
- MFS: $14,600
- HOH: $21,900

| Scenario | Output |
|----------|--------|
| Single, no itemized | standard=$14600, method="standard" |
| MFJ, itemized=$35000 | itemized=$35000, method="itemized" |
| MFJ, itemized=$20000 | standard=$29200, method="standard" |

**Credits Evaluation (PTAX-05):**
- Input: TaxSituation (income, filing_status, dependents, education_expenses, retirement_contributions, earned_income)
- Output: CreditsResult with applicable credits and total

For simple returns, include these common credits:
- Child Tax Credit (CTC): $2,000 per qualifying child under 17; phases out at $200k single/$400k MFJ
- Additional Child Tax Credit (ACTC): Refundable portion up to $1,700 per child if CTC exceeds liability
- Education Credits (Form 8863):
  - American Opportunity Credit: Up to $2,500/student (40% refundable), first 4 years of college
  - Lifetime Learning Credit: Up to $2,000, any post-secondary education
- Retirement Savings Contribution Credit (Saver's Credit): Up to $1,000/$2,000 for low-income retirement contributions
- Earned Income Tax Credit (EITC): Refundable credit for low-to-moderate income earners (simplified eligibility check)

| Scenario | Credits |
|----------|---------|
| Single, 2 kids under 17, AGI=$100k | CTC=$4,000 |
| MFJ, 1 kid, AGI=$450k | CTC=$0 (phased out) |
| Single, $4k education expense | AOC=$2,500 |
| MFJ, $2k retirement contrib, AGI=$40k | Saver's Credit=$400 (20% rate) |
| Single, no kids, AGI=$20k, earned=$18k | EITC=~$600 (simplified) |

**Tax Calculation (PTAX-06):**
- Input: taxable_income, filing_status, tax_year
- Output: TaxResult with total tax and bracket breakdown

2024 Single Brackets:
- 10%: $0 - $11,600
- 12%: $11,601 - $47,150
- 22%: $47,151 - $100,525
- 24%: $100,526 - $191,950
- 32%: $191,951 - $243,725
- 35%: $243,726 - $609,350
- 37%: $609,351+

| Taxable Income | Tax |
|----------------|-----|
| $10,000 | $1,000 (10% of $10k) |
| $50,000 | $1,160 + $4,266 + $627.78 = $6,053.78 |
| $100,000 | $1,160 + $4,266 + $11,742.50 + ($100k-$100,525)*0 = ~$17,168 |

**Prior Year Comparison (PTAX-12):**
- Input: current_values, prior_values, threshold=10%
- Output: List of VarianceItem for fields exceeding threshold

| Current | Prior | Variance |
|---------|-------|----------|
| wages=$80000 | wages=$70000 | 14.3% increase - FLAGGED |
| interest=$100 | interest=$95 | 5.3% - not flagged |
| wages=$50000 | wages=$0 | new income - FLAGGED |
  </behavior>
  <implementation>
**TDD Cycle:**

**RED Phase:** Write failing tests first
1. test_aggregate_income_single_w2
2. test_aggregate_income_multiple_w2
3. test_aggregate_income_mixed_documents
4. test_standard_deduction_single
5. test_standard_deduction_mfj
6. test_itemized_beats_standard
7. test_standard_beats_itemized
8. test_child_tax_credit_basic
9. test_child_tax_credit_phaseout
10. test_education_credit_aoc
11. test_savers_credit
12. test_eitc_basic_eligibility
13. test_credits_reduces_tax
14. test_tax_10_percent_bracket_only
15. test_tax_crosses_brackets
16. test_tax_high_income
17. test_variance_flags_10_percent
18. test_variance_ignores_small_changes
19. test_variance_new_income_source

**GREEN Phase:** Implement functions
- IncomeSummary dataclass
- DeductionResult dataclass
- TaxSituation dataclass
- CreditsResult dataclass
- CreditItem dataclass
- TaxResult dataclass (extended with credits_applied, final_liability)
- VarianceItem dataclass
- aggregate_income()
- get_standard_deduction()
- calculate_deductions()
- evaluate_credits()
- calculate_tax()
- compare_years()

**Data structures:**
```python
@dataclass
class IncomeSummary:
    total_wages: Decimal
    total_interest: Decimal
    total_dividends: Decimal
    total_qualified_dividends: Decimal
    total_nec: Decimal
    total_other: Decimal
    total_income: Decimal
    federal_withholding: Decimal

@dataclass
class DeductionResult:
    method: str  # "standard" or "itemized"
    amount: Decimal
    standard_amount: Decimal
    itemized_amount: Decimal

@dataclass
class TaxSituation:
    agi: Decimal
    filing_status: str
    tax_year: int
    num_qualifying_children: int = 0
    education_expenses: Decimal = Decimal("0")
    retirement_contributions: Decimal = Decimal("0")
    earned_income: Decimal = Decimal("0")

@dataclass
class CreditItem:
    name: str
    amount: Decimal
    refundable: bool
    form: str  # e.g., "Schedule 8812", "Form 8863"

@dataclass
class CreditsResult:
    credits: list[CreditItem]
    total_nonrefundable: Decimal
    total_refundable: Decimal
    total_credits: Decimal

@dataclass
class TaxResult:
    gross_tax: Decimal
    bracket_breakdown: list[dict]  # [{bracket, rate, tax_in_bracket}]
    effective_rate: Decimal
    credits_applied: Decimal = Decimal("0")
    final_liability: Decimal = Decimal("0")  # gross_tax - credits (min 0)
    refundable_credits: Decimal = Decimal("0")

@dataclass
class VarianceItem:
    field: str
    current_value: Decimal
    prior_value: Decimal
    variance_pct: Decimal
    direction: str  # "increase" or "decrease"
```

**Credits evaluation logic:**
```python
def evaluate_credits(situation: TaxSituation) -> CreditsResult:
    credits = []

    # Child Tax Credit
    if situation.num_qualifying_children > 0:
        ctc = _calculate_child_tax_credit(situation)
        if ctc > 0:
            credits.append(CreditItem("Child Tax Credit", ctc, False, "Schedule 8812"))

    # Education Credits (AOC or LLC - mutually exclusive per student)
    if situation.education_expenses > 0:
        edu_credit = _calculate_education_credit(situation)
        if edu_credit.amount > 0:
            credits.append(edu_credit)

    # Saver's Credit
    if situation.retirement_contributions > 0:
        savers = _calculate_savers_credit(situation)
        if savers > 0:
            credits.append(CreditItem("Saver's Credit", savers, False, "Form 8880"))

    # EITC (simplified)
    if situation.earned_income > 0:
        eitc = _calculate_eitc(situation)
        if eitc > 0:
            credits.append(CreditItem("Earned Income Credit", eitc, True, "Schedule EIC"))

    return CreditsResult(
        credits=credits,
        total_nonrefundable=sum(c.amount for c in credits if not c.refundable),
        total_refundable=sum(c.amount for c in credits if c.refundable),
        total_credits=sum(c.amount for c in credits),
    )
```

Store credit thresholds and rates as constants indexed by (year, filing_status).
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for calculator including credits</name>
  <files>src/agents/__init__.py, src/agents/personal_tax/__init__.py, tests/agents/__init__.py, tests/agents/personal_tax/__init__.py, tests/agents/personal_tax/test_calculator.py</files>
  <action>
Create directory structure and write comprehensive tests BEFORE implementation.

**Directory setup:**
- src/agents/__init__.py
- src/agents/personal_tax/__init__.py
- tests/agents/__init__.py
- tests/agents/personal_tax/__init__.py

**test_calculator.py tests:**

```python
# Income aggregation tests
def test_aggregate_income_single_w2():
    """Single W-2 should produce correct totals."""
    w2 = W2Data(wages_tips_compensation=Decimal("50000"), ...)
    result = aggregate_income([w2])
    assert result.total_wages == Decimal("50000")
    assert result.total_income == Decimal("50000")

def test_aggregate_income_multiple_w2():
    """Multiple W-2s should sum wages."""
    ...

def test_aggregate_income_mixed_documents():
    """Mix of W-2 and 1099s should categorize correctly."""
    ...

# Deduction tests
def test_standard_deduction_single_2024():
    """Single filer 2024 standard deduction is $14,600."""
    result = calculate_deductions(IncomeSummary(...), "single", 2024)
    assert result.standard_amount == Decimal("14600")

def test_standard_deduction_mfj_2024():
    """MFJ 2024 standard deduction is $29,200."""
    ...

def test_itemized_beats_standard():
    """Higher itemized should be selected."""
    result = calculate_deductions(..., itemized_total=Decimal("35000"))
    assert result.method == "itemized"
    assert result.amount == Decimal("35000")

# Credits tests (PTAX-05)
def test_child_tax_credit_basic():
    """CTC is $2,000 per qualifying child under 17."""
    situation = TaxSituation(
        agi=Decimal("100000"),
        filing_status="single",
        tax_year=2024,
        num_qualifying_children=2,
    )
    result = evaluate_credits(situation)
    ctc = next((c for c in result.credits if c.name == "Child Tax Credit"), None)
    assert ctc is not None
    assert ctc.amount == Decimal("4000")

def test_child_tax_credit_phaseout():
    """CTC phases out at $200k single, $400k MFJ."""
    situation = TaxSituation(
        agi=Decimal("450000"),
        filing_status="mfj",
        tax_year=2024,
        num_qualifying_children=1,
    )
    result = evaluate_credits(situation)
    ctc = next((c for c in result.credits if c.name == "Child Tax Credit"), None)
    assert ctc is None or ctc.amount == Decimal("0")

def test_education_credit_aoc():
    """AOC up to $2,500 for first $4k expenses."""
    situation = TaxSituation(
        agi=Decimal("50000"),
        filing_status="single",
        tax_year=2024,
        education_expenses=Decimal("4000"),
    )
    result = evaluate_credits(situation)
    edu = next((c for c in result.credits if "Education" in c.name or "Opportunity" in c.name), None)
    assert edu is not None
    assert edu.amount == Decimal("2500")

def test_savers_credit():
    """Saver's Credit based on AGI and contribution."""
    situation = TaxSituation(
        agi=Decimal("40000"),
        filing_status="mfj",
        tax_year=2024,
        retirement_contributions=Decimal("2000"),
    )
    result = evaluate_credits(situation)
    savers = next((c for c in result.credits if c.name == "Saver's Credit"), None)
    assert savers is not None
    assert savers.amount == Decimal("400")  # 20% rate for MFJ AGI $41k-$46k

def test_eitc_basic_eligibility():
    """EITC for low-income earner."""
    situation = TaxSituation(
        agi=Decimal("20000"),
        filing_status="single",
        tax_year=2024,
        earned_income=Decimal("18000"),
        num_qualifying_children=0,
    )
    result = evaluate_credits(situation)
    eitc = next((c for c in result.credits if c.name == "Earned Income Credit"), None)
    assert eitc is not None
    assert eitc.refundable == True
    assert eitc.amount > Decimal("0")

def test_credits_no_children_no_education():
    """No credits if no qualifying situations."""
    situation = TaxSituation(
        agi=Decimal("150000"),
        filing_status="single",
        tax_year=2024,
    )
    result = evaluate_credits(situation)
    assert result.total_credits == Decimal("0")

# Tax calculation tests
def test_tax_10_percent_bracket_only():
    """Income under $11,600 is 10%."""
    result = calculate_tax(Decimal("10000"), "single", 2024)
    assert result.gross_tax == Decimal("1000")

def test_tax_crosses_brackets():
    """Income crossing brackets uses marginal rates."""
    # $50,000 taxable: 10% up to 11600, 12% up to 47150, 22% rest
    result = calculate_tax(Decimal("50000"), "single", 2024)
    expected = Decimal("1160") + Decimal("4266") + Decimal("627.00")  # Approx
    assert abs(result.gross_tax - expected) < Decimal("10")  # Within $10

# Variance tests
def test_variance_flags_10_percent_increase():
    """10%+ increase should be flagged."""
    variances = compare_years(
        {"wages": Decimal("80000")},
        {"wages": Decimal("70000")},
    )
    assert len(variances) == 1
    assert variances[0].direction == "increase"

def test_variance_ignores_small_changes():
    """Under 10% change not flagged."""
    variances = compare_years(
        {"wages": Decimal("75000")},
        {"wages": Decimal("70000")},
    )
    assert len(variances) == 0
```

Tests should FAIL because calculator.py doesn't exist yet.
  </action>
  <verify>
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v 2>&1 | head -30
# Should show import errors or test failures (RED phase)
```
  </verify>
  <done>Tests written including credits tests, all fail due to missing implementation (RED phase complete)</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement calculator with credits to pass tests</name>
  <files>src/agents/personal_tax/calculator.py</files>
  <action>
Implement calculator.py with all functions including evaluate_credits to make tests pass.

**Constants (store at module level):**
```python
# 2024 Standard Deductions
STANDARD_DEDUCTIONS = {
    (2024, "single"): Decimal("14600"),
    (2024, "mfj"): Decimal("29200"),
    (2024, "mfs"): Decimal("14600"),
    (2024, "hoh"): Decimal("21900"),
    # Add 2023 for prior year
    (2023, "single"): Decimal("13850"),
    (2023, "mfj"): Decimal("27700"),
    (2023, "mfs"): Decimal("13850"),
    (2023, "hoh"): Decimal("20800"),
}

# 2024 Tax Brackets (Single)
TAX_BRACKETS = {
    (2024, "single"): [
        (Decimal("11600"), Decimal("0.10")),
        (Decimal("47150"), Decimal("0.12")),
        (Decimal("100525"), Decimal("0.22")),
        (Decimal("191950"), Decimal("0.24")),
        (Decimal("243725"), Decimal("0.32")),
        (Decimal("609350"), Decimal("0.35")),
        (None, Decimal("0.37")),  # No upper limit
    ],
    (2024, "mfj"): [
        (Decimal("23200"), Decimal("0.10")),
        (Decimal("94300"), Decimal("0.12")),
        (Decimal("201050"), Decimal("0.22")),
        (Decimal("383900"), Decimal("0.24")),
        (Decimal("487450"), Decimal("0.32")),
        (Decimal("731200"), Decimal("0.35")),
        (None, Decimal("0.37")),
    ],
    # Add remaining filing statuses
}

# Child Tax Credit thresholds (2024)
CTC_AMOUNT = Decimal("2000")
CTC_PHASEOUT_SINGLE = Decimal("200000")
CTC_PHASEOUT_MFJ = Decimal("400000")
CTC_PHASEOUT_RATE = Decimal("50")  # $50 reduction per $1000 over threshold

# Saver's Credit rates by AGI (2024)
SAVERS_CREDIT_RATES = {
    (2024, "single"): [
        (Decimal("23000"), Decimal("0.50")),   # 50% up to $23k
        (Decimal("25000"), Decimal("0.20")),   # 20% up to $25k
        (Decimal("38250"), Decimal("0.10")),   # 10% up to $38,250
    ],
    (2024, "mfj"): [
        (Decimal("46000"), Decimal("0.50")),
        (Decimal("50000"), Decimal("0.20")),
        (Decimal("76500"), Decimal("0.10")),
    ],
}
SAVERS_CREDIT_MAX_CONTRIBUTION = Decimal("2000")  # Max contribution considered

# EITC simplified thresholds (2024, no children)
EITC_MAX_NO_CHILDREN = Decimal("632")
EITC_INCOME_LIMIT_SINGLE_NO_CHILDREN = Decimal("18591")
```

**Implementation:**

1. **aggregate_income(documents: list) -> IncomeSummary**
   - Iterate documents, categorize by type
   - Sum each category
   - Calculate total_income as sum of all categories

2. **get_standard_deduction(filing_status: str, tax_year: int) -> Decimal**
   - Lookup in STANDARD_DEDUCTIONS
   - Raise ValueError if not found

3. **calculate_deductions(income: IncomeSummary, filing_status: str, tax_year: int, itemized_total: Decimal = 0) -> DeductionResult**
   - Get standard deduction
   - Compare with itemized
   - Return result with method and amount

4. **evaluate_credits(situation: TaxSituation) -> CreditsResult** (PTAX-05)
   - Calculate Child Tax Credit with phaseout
   - Calculate Education Credit (AOC: 100% of first $2k + 25% of next $2k)
   - Calculate Saver's Credit based on AGI tier
   - Calculate simplified EITC for no-child filers
   - Return CreditsResult with all applicable credits

5. **calculate_tax(taxable_income: Decimal, filing_status: str, tax_year: int) -> TaxResult**
   - Get brackets for year/status
   - Fill each bracket sequentially
   - Track breakdown by bracket
   - Calculate effective rate

6. **compare_years(current: dict, prior: dict, threshold: Decimal = 10) -> list[VarianceItem]**
   - For each field in current, compare to prior
   - Calculate percentage change
   - Flag if exceeds threshold
   - Handle new income (prior=0) as 100% increase

Update src/agents/personal_tax/__init__.py to export all functions and dataclasses including evaluate_credits, TaxSituation, CreditsResult, CreditItem.
  </action>
  <verify>
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v
# All tests should PASS (GREEN phase)
```
  </verify>
  <done>All calculator tests pass including credits tests (GREEN phase complete)</done>
</task>

<task type="auto">
  <name>Task 3: REFACTOR - Clean up and add edge case tests</name>
  <files>src/agents/personal_tax/calculator.py, tests/agents/personal_tax/test_calculator.py</files>
  <action>
Refactor implementation and add additional edge case tests.

**Refactoring opportunities:**
- Extract bracket calculation into helper function
- Extract credit phaseout logic into helper
- Add type hints throughout
- Add docstrings with examples
- Ensure Decimal precision (2 decimal places for money)

**Additional edge case tests:**
- test_aggregate_income_empty_list -> returns zero totals
- test_aggregate_income_with_withholding -> sums federal_withholding
- test_deduction_unknown_filing_status -> raises ValueError
- test_tax_zero_income -> returns zero tax
- test_tax_at_bracket_boundary -> correct calculation
- test_variance_both_zero -> no variance
- test_variance_decrease -> direction="decrease"
- test_variance_custom_threshold -> respects threshold parameter
- test_ctc_partial_phaseout -> CTC reduces but not to zero
- test_aoc_partial_expenses -> AOC for less than $4k expenses
- test_savers_credit_above_limit -> no credit above AGI threshold
- test_eitc_above_limit -> no EITC above income limit
- test_multiple_credits_combined -> total_credits sums correctly

Run all tests to ensure refactoring didn't break anything.
  </action>
  <verify>
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v --tb=short
# All tests still pass, including new edge cases
```
  </verify>
  <done>Calculator refactored, 25+ tests passing including credits edge cases</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Calculator importable with credits:
```bash
uv run python -c "from src.agents.personal_tax import aggregate_income, calculate_deductions, calculate_tax, evaluate_credits, compare_years; print('Calculator OK')"
```

2. All tests pass:
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v
```

3. Manual calculation check:
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import calculate_tax, evaluate_credits, TaxSituation

# $50,000 single: should be about $6,053
result = calculate_tax(Decimal('50000'), 'single', 2024)
print(f'Tax on \$50,000: \${result.gross_tax:,.2f}')
print(f'Effective rate: {result.effective_rate * 100:.2f}%')

# Credits check
situation = TaxSituation(
    agi=Decimal('80000'),
    filing_status='single',
    tax_year=2024,
    num_qualifying_children=2,
)
credits = evaluate_credits(situation)
print(f'Total credits: \${credits.total_credits:,.2f}')
for c in credits.credits:
    print(f'  {c.name}: \${c.amount:,.2f}')
"
```
</verification>

<success_criteria>
- TDD cycle completed (RED -> GREEN -> REFACTOR)
- Income aggregation sums correctly by type
- Standard deduction lookup by filing status and year
- Itemized vs standard comparison selects higher
- Credits evaluated correctly (PTAX-05):
  - Child Tax Credit with phaseout
  - Education Credits (AOC)
  - Saver's Credit
  - EITC (simplified)
- Tax calculation uses correct marginal brackets
- Variance detection flags >10% changes
- 25+ tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/03-personal-tax-simple/03-05-SUMMARY.md`
</output>
