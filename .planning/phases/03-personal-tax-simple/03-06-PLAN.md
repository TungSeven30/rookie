---
phase: 03-personal-tax-simple
plan: 06
type: execute
wave: 5
depends_on: ["03-05"]
files_modified:
  - src/agents/personal_tax/output.py
autonomous: true

must_haves:
  truths:
    - "Drake worksheet (Excel) is generated with correct column ordering"
    - "W-2 data populates W-2 Income sheet with Drake-compatible columns"
    - "1099 data populates respective sheets"
    - "Summary sheet shows totals and tax liability"
    - "Preparer notes include Summary, Sources, Flags, Assumptions, Review Focus sections"
    - "Variances appear in Flags section of preparer notes"
  artifacts:
    - path: "src/agents/personal_tax/output.py"
      provides: "Drake worksheet and preparer notes generators"
      exports: ["generate_drake_worksheet", "generate_preparer_notes"]
      min_lines: 200
  key_links:
    - from: "src/agents/personal_tax/output.py"
      to: "openpyxl"
      via: "Excel generation"
      pattern: "from openpyxl import Workbook"
    - from: "src/agents/personal_tax/output.py"
      to: "src/agents/personal_tax/calculator.py"
      via: "Tax calculation results"
      pattern: "IncomeSummary|DeductionResult|TaxResult"
---

<objective>
Create output generators for Drake worksheet (Excel) and preparer notes (Markdown).

Purpose: These are the CPA-facing deliverables that the Personal Tax Agent produces. The Drake worksheet enables manual entry into Drake Tax Software, and preparer notes provide context for CPA review. Required for PTAX-13 (Drake worksheet) and PTAX-14 (preparer notes).

Output:
- src/agents/personal_tax/output.py with worksheet and notes generators
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-personal-tax-simple/03-RESEARCH.md
@src/documents/models.py
@src/agents/personal_tax/calculator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Drake worksheet generator</name>
  <files>src/agents/personal_tax/output.py</files>
  <action>
Create output.py with Drake worksheet generation using openpyxl.

**generate_drake_worksheet function:**
```python
def generate_drake_worksheet(
    client_name: str,
    tax_year: int,
    w2_data: list[W2Data],
    income_1099_int: list[Form1099INT],
    income_1099_div: list[Form1099DIV],
    income_1099_nec: list[Form1099NEC],
    income_summary: IncomeSummary,
    deduction_result: DeductionResult,
    tax_result: TaxResult,
    output_path: Path,
) -> Path:
    """Generate Drake-compatible Excel worksheet.

    Args:
        client_name: Client name for header
        tax_year: Tax year
        w2_data: List of extracted W-2 data
        income_1099_int: List of extracted 1099-INT data
        income_1099_div: List of extracted 1099-DIV data
        income_1099_nec: List of extracted 1099-NEC data
        income_summary: Aggregated income
        deduction_result: Deduction calculation
        tax_result: Tax calculation
        output_path: Where to save the xlsx file

    Returns:
        Path to generated file
    """
```

**Sheet structure:**

1. **Summary sheet:**
   - Client name, tax year
   - Total income, AGI, taxable income
   - Deduction method and amount
   - Total tax, withholding, refund/due

2. **W-2 Income sheet:**
   Headers (Drake column order):
   - Employer EIN
   - Employer Name
   - Box 1 Wages
   - Box 2 Fed W/H
   - Box 3 SS Wages
   - Box 4 SS Tax
   - Box 5 Medicare Wages
   - Box 6 Medicare Tax
   - Box 12 Code
   - Box 12 Amount
   - State
   - Box 16 State Wages
   - Box 17 State W/H

3. **1099-INT sheet:**
   Headers:
   - Payer Name
   - Payer TIN
   - Box 1 Interest
   - Box 2 Early W/D Penalty
   - Box 4 Fed W/H
   - Box 8 Tax-Exempt Interest

4. **1099-DIV sheet:**
   Headers:
   - Payer Name
   - Payer TIN
   - Box 1a Ordinary Dividends
   - Box 1b Qualified Dividends
   - Box 2a Capital Gains
   - Box 4 Fed W/H

5. **1099-NEC sheet:**
   Headers:
   - Payer Name
   - Payer TIN
   - Box 1 Nonemployee Comp
   - Box 4 Fed W/H

**Formatting:**
- Bold headers with center alignment
- Currency format for monetary cells
- Auto-fit column widths
- Freeze header row
  </action>
  <verify>
```bash
uv run python -c "
from src.agents.personal_tax.output import generate_drake_worksheet
from src.documents.models import W2Data
from src.agents.personal_tax.calculator import IncomeSummary, DeductionResult, TaxResult
from decimal import Decimal
from pathlib import Path
import tempfile

# Create test data
w2 = W2Data(
    employee_ssn='123-45-6789',
    employer_ein='12-3456789',
    employer_name='Test Corp',
    employee_name='John Doe',
    wages_tips_compensation=Decimal('50000'),
    federal_tax_withheld=Decimal('5000'),
    social_security_wages=Decimal('50000'),
    social_security_tax=Decimal('3100'),
    medicare_wages=Decimal('50000'),
    medicare_tax=Decimal('725'),
    confidence='HIGH'
)

income = IncomeSummary(
    total_wages=Decimal('50000'),
    total_interest=Decimal('0'),
    total_dividends=Decimal('0'),
    total_qualified_dividends=Decimal('0'),
    total_nec=Decimal('0'),
    total_other=Decimal('0'),
    total_income=Decimal('50000'),
    federal_withholding=Decimal('5000')
)

deduction = DeductionResult(
    method='standard',
    amount=Decimal('14600'),
    standard_amount=Decimal('14600'),
    itemized_amount=Decimal('0')
)

tax = TaxResult(
    total_tax=Decimal('4000'),
    bracket_breakdown=[],
    effective_rate=Decimal('0.08')
)

with tempfile.TemporaryDirectory() as tmpdir:
    path = generate_drake_worksheet(
        'John Doe',
        2024,
        [w2],
        [],
        [],
        [],
        income,
        deduction,
        tax,
        Path(tmpdir) / 'test.xlsx'
    )
    print(f'Generated: {path}')
    print(f'Exists: {path.exists()}')

print('Drake worksheet generator OK')
"
```
  </verify>
  <done>generate_drake_worksheet creates Excel file with Summary, W-2, 1099-INT, 1099-DIV, 1099-NEC sheets</done>
</task>

<task type="auto">
  <name>Task 2: Create preparer notes generator</name>
  <files>src/agents/personal_tax/output.py</files>
  <action>
Add preparer notes generation to output.py.

**generate_preparer_notes function:**
```python
def generate_preparer_notes(
    client_name: str,
    tax_year: int,
    income_summary: IncomeSummary,
    deduction_result: DeductionResult,
    tax_result: TaxResult,
    variances: list[VarianceItem],
    extractions: list[dict],  # [{document_type, filename, confidence}]
    filing_status: str,
    output_path: Path,
) -> Path:
    """Generate preparer notes in Markdown format.

    Required sections (per PTAX-14):
    - Summary: Income, deductions, tax, refund/due
    - Sources: Documents processed with confidence
    - Flags: Variances >10%, low confidence extractions
    - Assumptions: Filing status, deduction method
    - Review Focus: What CPA should verify

    Args:
        (see above)

    Returns:
        Path to generated Markdown file
    """
```

**Markdown structure:**
```markdown
# Preparer Notes: {client_name} - Tax Year {tax_year}

**Generated:** {timestamp}
**Overall Confidence:** {HIGH/MEDIUM/LOW based on extractions}

## Summary

**Filing Status:** {status}
**Total Income:** ${amount}
**Adjusted Gross Income:** ${amount}
**Taxable Income:** ${amount}
**Total Tax:** ${amount}
**Total Withholding:** ${amount}
**Refund/(Amount Due):** ${amount}

### Deduction Method
{Standard/Itemized} deduction selected.
- Standard deduction: ${amount}
- Itemized total: ${amount}

## Sources

Documents processed:
- {doc_type}: {filename} (Confidence: {level})
- ...

## Flags

### Variances from Prior Year (>10%)
{For each variance:}
- **{field}**: {direction} {pct}% (${prior} -> ${current})

{Or: "No significant variances from prior year."}

### Extraction Concerns
{Any MEDIUM/LOW confidence extractions}

## Assumptions

- Filing status: {status} (from prior year / client profile)
- {deduction method} deduction used because {reason}
- All documents in client folder were processed

## Review Focus

1. Verify W-2 Box 1 matches employer records
2. Confirm all 1099s received are included
{If variances: 3. Investigate flagged variances}
{If low confidence: 4. Review fields marked as uncertain}
```

Export function from __init__.py.
  </action>
  <verify>
```bash
uv run python -c "
from src.agents.personal_tax.output import generate_preparer_notes
from src.agents.personal_tax.calculator import IncomeSummary, DeductionResult, TaxResult, VarianceItem
from decimal import Decimal
from pathlib import Path
import tempfile

income = IncomeSummary(
    total_wages=Decimal('50000'),
    total_interest=Decimal('100'),
    total_dividends=Decimal('0'),
    total_qualified_dividends=Decimal('0'),
    total_nec=Decimal('0'),
    total_other=Decimal('0'),
    total_income=Decimal('50100'),
    federal_withholding=Decimal('5000')
)

deduction = DeductionResult(
    method='standard',
    amount=Decimal('14600'),
    standard_amount=Decimal('14600'),
    itemized_amount=Decimal('0')
)

tax = TaxResult(
    total_tax=Decimal('4000'),
    bracket_breakdown=[],
    effective_rate=Decimal('0.08')
)

variances = [
    VarianceItem(
        field='wages',
        current_value=Decimal('50000'),
        prior_value=Decimal('40000'),
        variance_pct=Decimal('25'),
        direction='increase'
    )
]

extractions = [
    {'document_type': 'W-2', 'filename': 'w2_employer.pdf', 'confidence': 'HIGH'},
    {'document_type': '1099-INT', 'filename': '1099int_bank.jpg', 'confidence': 'HIGH'},
]

with tempfile.TemporaryDirectory() as tmpdir:
    path = generate_preparer_notes(
        'John Doe',
        2024,
        income,
        deduction,
        tax,
        variances,
        extractions,
        'single',
        Path(tmpdir) / 'notes.md'
    )
    print(f'Generated: {path}')
    content = path.read_text()
    print('--- First 500 chars ---')
    print(content[:500])

print('Preparer notes generator OK')
"
```
  </verify>
  <done>generate_preparer_notes creates Markdown with Summary, Sources, Flags, Assumptions, Review Focus sections</done>
</task>

<task type="auto">
  <name>Task 3: Create output generator tests</name>
  <files>tests/agents/personal_tax/test_output.py</files>
  <action>
Create comprehensive tests for output generators.

**test_output.py tests:**

**Drake worksheet tests:**
- test_worksheet_creates_file -> file exists after generation
- test_worksheet_has_summary_sheet -> "Summary" sheet present
- test_worksheet_has_w2_sheet -> "W-2 Income" sheet present
- test_worksheet_has_1099_sheets -> All 1099 sheets present
- test_worksheet_w2_columns -> Headers match Drake format
- test_worksheet_w2_data_populated -> W2 data in correct columns
- test_worksheet_summary_totals -> Totals match input

**Preparer notes tests:**
- test_notes_creates_file -> file exists
- test_notes_has_summary_section -> "## Summary" present
- test_notes_has_sources_section -> "## Sources" present
- test_notes_has_flags_section -> "## Flags" present
- test_notes_has_assumptions_section -> "## Assumptions" present
- test_notes_has_review_focus_section -> "## Review Focus" present
- test_notes_includes_variances -> Variance items in Flags section
- test_notes_includes_documents -> Document list in Sources section
- test_notes_no_variances_message -> "No significant variances" when empty

Use pytest fixtures with tempfile for isolation.
  </action>
  <verify>
```bash
uv run pytest tests/agents/personal_tax/test_output.py -v
```
All tests pass.
  </verify>
  <done>20+ tests covering worksheet and notes generators pass</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Output functions importable:
```bash
uv run python -c "from src.agents.personal_tax import generate_drake_worksheet, generate_preparer_notes; print('Output OK')"
```

2. All tests pass:
```bash
uv run pytest tests/agents/personal_tax/test_output.py -v
```

3. Generated files are valid:
```bash
uv run python -c "
from openpyxl import load_workbook
import tempfile
from pathlib import Path
# (generate file as above, then load and verify)
print('File validation OK')
"
```
</verification>

<success_criteria>
- Drake worksheet has correct sheet structure and column ordering
- W-2 data populates correctly for manual Drake entry
- Preparer notes include all 5 required sections
- Variances appear in Flags section
- Documents list appears in Sources section
- 20+ unit tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/03-personal-tax-simple/03-06-SUMMARY.md`
</output>
