---
phase: 03-personal-tax-simple
plan: 08
type: execute
wave: 7
depends_on: ["03-02", "03-03", "03-04", "03-05", "03-06", "03-07"]
files_modified:
  - src/documents/models.py
  - src/documents/prompts.py
  - src/documents/extractor.py
  - src/documents/classifier.py
  - src/agents/personal_tax/calculator.py
  - src/agents/personal_tax/output.py
  - src/agents/personal_tax/agent.py
  - src/api/demo.py
  - frontend/src/components/UploadZone.tsx
  - frontend/src/api/demo.ts
  - frontend/src/types/api.ts
  - frontend/src/components/ResultsPanel.tsx
  - tests/documents/test_classifier.py
  - tests/documents/test_extractor.py
  - tests/agents/personal_tax/test_calculator.py
  - tests/api/test_demo.py
autonomous: true
---

<objective>
Add support for additional tax forms in the Phase 3 workflow with full tax integration:
1098, 1099-R, 1099-G, 1098-T, 5498, 1099-S. Add a user-selected form type
workflow to reduce classification ambiguity and improve review quality.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-personal-tax-simple/03-RESEARCH.md
@src/documents/models.py
@src/documents/prompts.py
@src/documents/extractor.py
@src/documents/classifier.py
@src/agents/personal_tax/calculator.py
@src/agents/personal_tax/output.py
@src/agents/personal_tax/agent.py
@src/api/demo.py
@frontend/src/components/UploadZone.tsx
@frontend/src/api/demo.ts
@frontend/src/types/api.ts
@frontend/src/components/ResultsPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend document types and models</name>
  <files>src/documents/models.py</files>
  <action>
Add new DocumentType enum values and Pydantic models:
- FORM_1098, FORM_1099_R, FORM_1099_G, FORM_1098_T, FORM_5498, FORM_1099_S

Define models with required fields and Decimal types. Include confidence and
uncertain_fields for each model. Use validate_tin where appropriate.

Form 1098 (Mortgage Interest):
- lender_name, lender_tin, borrower_name, borrower_tin
- mortgage_interest, points_paid, mortgage_insurance_premiums
- property_taxes_paid, refund_of_overpaid_interest
- outstanding_mortgage_principal

Form 1099-R (Retirement Distributions):
- payer_name, payer_tin, recipient_name, recipient_tin
- gross_distribution (box 1), taxable_amount (box 2a)
- taxable_amount_not_determined (box 2b flag)
- distribution_code (box 7), ira_sep_simple_flag (box 7)
- federal_tax_withheld (box 4)

Form 1099-G (Government Payments):
- payer_name, payer_tin, recipient_tin
- unemployment_compensation (box 1)
- state_tax_refund (box 2)
- federal_tax_withheld (box 4)
- state_tax_withheld (box 11)

Form 1098-T (Tuition Statement):
- institution_name, institution_tin, student_name, student_tin
- payments_received (box 1), scholarships (box 5)
- adjustments_prior_year (box 4/6)
- at_least_half_time (box 8), graduate_student (box 9)

Form 5498 (IRA Contributions):
- trustee_name, trustee_tin, participant_name, participant_tin
- traditional_ira_contribution (box 1)
- rollover_contribution (box 2)
- roth_ira_contribution (box 10)
- sep_contribution (box 8), simple_contribution (box 9)
- year_end_fmv (box 5), ira_type (box 7)

Form 1099-S (Real Estate Proceeds):
- filer_name, filer_tin, transferor_name, transferor_tin
- gross_proceeds (box 2), closing_date (box 1)
- property_address (box 3)

Update CRITICAL_FIELDS mapping for each new form to support escalation.
  </action>
  <verify>
```bash
uv run python -c "from src.documents.models import DocumentType; print([t.value for t in DocumentType])"
```
  </verify>
  <done>New models and document types exist with validation and metadata fields.</done>
</task>

<task type="auto">
  <name>Task 2: Update classifier and extraction prompts</name>
  <files>src/documents/classifier.py, src/documents/prompts.py, src/documents/extractor.py</files>
  <action>
Classifier:
- Extend CLASSIFICATION_PROMPT to recognize new forms with distinguishing cues.

Prompts:
- Add FORM_1098_PROMPT, FORM_1099_R_PROMPT, FORM_1099_G_PROMPT,
  FORM_1098_T_PROMPT, FORM_5498_PROMPT, FORM_1099_S_PROMPT.
- Require exact decimals, preserve cents, list uncertain_fields, and add
  "multiple_forms_detected" when multiple forms appear on one page.

Extractor:
- Add extract_1098(), extract_1099_r(), extract_1099_g(), extract_1098_t(),
  extract_5498(), extract_1099_s().
- Update extract_document router and ExtractionResult union.
  </action>
  <verify>
```bash
uv run python -c "from src.documents.extractor import extract_document; print('Extractor ready')"
```
  </verify>
  <done>Classifier and extractor recognize and route new forms.</done>
</task>

<task type="auto">
  <name>Task 3: User-selected form type upload flow</name>
  <files>frontend/src/components/UploadZone.tsx, frontend/src/api/demo.ts, frontend/src/types/api.ts, src/api/demo.py, src/agents/personal_tax/agent.py</files>
  <action>
Frontend:
- Add a per-file form selection dropdown.
- Extend upload payload to include a list of selected form types aligned with files.

Backend:
- Accept form_types in /api/demo/upload (optional list matching files).
- Store per-file user_selected_form_type in uploaded_document artifact content.

Agent:
- When user_selected_form_type is present, route extraction to that type.
- Run classifier for mismatch detection; if mismatch confidence is high,
  add escalation and preserve original classifier details.
  </action>
  <verify>
```bash
uv run python -c "print('Upload flow updated')"
```
  </verify>
  <done>User-selected form types drive extraction and mismatch warnings.</done>
</task>

<task type="auto">
  <name>Task 4: Tax logic integration for new forms</name>
  <files>src/agents/personal_tax/calculator.py</files>
  <action>
Extend IncomeSummary, DeductionResult, and TaxResult to include new categories.

Tax rules and escalation boundaries:
- 1099-R: add taxable_amount to ordinary income.
  - Escalate if taxable_amount_not_determined is true or taxable_amount missing.
  - Apply 10% early distribution penalty only for known codes (1 = penalty).
    Escalate for ambiguous codes or exceptions.
- 1099-G: add unemployment_compensation to income.
  - If state_tax_refund > 0 and prior_year_itemized unknown, escalate.
- 1098: compute itemized deductions (mortgage interest, points, PMI,
  property taxes). Apply SALT cap where applicable. Compare against standard
  deduction and use higher amount; store both values for notes.
- 1098-T: compute education credits (AOTC/LLC) using payments_received
  and scholarships. If eligibility data is missing (student status, years of
  AOTC claimed, felony status), escalate and do not apply credit.
- 5498: compute IRA deduction using traditional_ira_contribution and IRA type.
  Roth contributions are non-deductible. If coverage by retirement plan or
  MAGI data is missing for deduction limits, escalate.
- 1099-S: add proceeds to capital gains only if basis and primary residence
  data provided; otherwise escalate and exclude from tax.
  </action>
  <verify>
```bash
uv run python -c "from src.agents.personal_tax import calculator; print('Calculator updated')"
```
  </verify>
  <done>Calculator supports new forms with clear escalation rules.</done>
</task>

<task type="auto">
  <name>Task 5: Outputs, API payloads, and UI display</name>
  <files>src/agents/personal_tax/output.py, src/api/demo.py, frontend/src/components/ResultsPanel.tsx</files>
  <action>
- Update key_fields extraction to include new form fields.
- Extend preparer notes with clear sections per new form and any escalations.
- Update results payload to expose new key fields and user-selected form type.
- Update frontend display to show new key fields and mismatch warnings.
  </action>
  <verify>
```bash
uv run python -c "print('Outputs updated')"
```
  </verify>
  <done>Outputs and UI reflect new forms and review notes.</done>
</task>

<task type="auto">
  <name>Task 6: Tests</name>
  <files>tests/documents/test_classifier.py, tests/documents/test_extractor.py, tests/agents/personal_tax/test_calculator.py, tests/api/test_demo.py</files>
  <action>
Add tests for:
- New models validation and extraction routing.
- Classifier prompt coverage for new forms.
- Tax logic and escalation boundaries for each form.
- Upload flow with user-selected form types and mismatch handling.
  </action>
  <verify>
```bash
uv run pytest tests/documents tests/agents/personal_tax/test_calculator.py tests/api/test_demo.py -v
```
  </verify>
  <done>All tests for new forms and routing pass.</done>
</task>

</tasks>

<success_criteria>
- New document types are supported end-to-end.
- User-selected form type drives extraction and mismatch escalations.
- Tax results include new forms when data is sufficient.
- Missing data produces clear escalations instead of silent defaults.
</success_criteria>

<output>
After completion, create `.planning/phases/03-personal-tax-simple/03-08-SUMMARY.md`.
</output>
