# Plan 04-01: K-1 and 1099-B Document Models

---
phase: 04-personal-tax-complex
plan: 01
type: execute
wave: 1
depends_on: ["03-07"]
---

## Objective

Create Pydantic models for K-1 and 1099-B documents with validation and confidence scoring.

**Purpose:** These models define the data structures for complex tax documents that feed into Schedule C, E, and D calculations.

**Output:**
- FormK1 model in src/documents/models.py
- Form1099B model in src/documents/models.py
- Updated DocumentType enum
- Updated CRITICAL_FIELDS mapping
- Updated classifier prompt

## Tasks

### Task 1: Add Document Types to Enum

**Files:** src/documents/models.py

**Action:**
Add new document types to DocumentType enum:
```python
class DocumentType(str, Enum):
    # ... existing types ...
    FORM_K1 = "K-1"
    FORM_1099_B = "1099-B"
    FORM_1095_A = "1095-A"  # For Form 8962
```

**Verify:**
```bash
uv run python -c "from src.documents.models import DocumentType; print(DocumentType.FORM_K1.value)"
```

**Done:** DocumentType enum includes K-1, 1099-B, 1095-A

---

### Task 2: Create FormK1 Model

**Files:** src/documents/models.py

**Action:**
Create FormK1 Pydantic model for Schedule K-1 (Form 1065/1120-S):

```python
class FormK1(BaseModel):
    """Schedule K-1 data from Partnership (1065) or S-Corp (1120-S)."""
    
    # Entity information (Part I)
    entity_name: str
    entity_ein: str
    entity_type: str  # "partnership" or "s_corp"
    tax_year: int
    
    # Partner/Shareholder information (Part II)
    recipient_name: str
    recipient_tin: str
    ownership_percentage: Decimal
    
    # Capital account (Part II, Item L) - for basis tracking
    capital_account_beginning: Decimal | None = None
    capital_account_ending: Decimal | None = None
    current_year_increase: Decimal | None = None
    current_year_decrease: Decimal | None = None
    
    # Debt basis (partnerships) - from K-1 supplemental
    share_of_recourse_liabilities: Decimal | None = None
    share_of_nonrecourse_liabilities: Decimal | None = None
    share_of_qualified_nonrecourse: Decimal | None = None
    
    # Income items (Part III)
    ordinary_business_income: Decimal = Decimal("0")  # Box 1
    net_rental_real_estate: Decimal = Decimal("0")    # Box 2
    other_rental_income: Decimal = Decimal("0")       # Box 3
    guaranteed_payments: Decimal = Decimal("0")       # Box 4
    interest_income: Decimal = Decimal("0")           # Box 5
    dividend_income: Decimal = Decimal("0")           # Box 6
    royalties: Decimal = Decimal("0")                 # Box 7
    net_short_term_capital_gain: Decimal = Decimal("0")  # Box 8
    net_long_term_capital_gain: Decimal = Decimal("0")   # Box 9
    net_section_1231_gain: Decimal = Decimal("0")    # Box 10
    other_income: Decimal = Decimal("0")             # Box 11
    
    # Deductions
    section_179_deduction: Decimal = Decimal("0")    # Box 12
    other_deductions: Decimal = Decimal("0")         # Box 13
    
    # Self-employment
    self_employment_earnings: Decimal = Decimal("0") # Box 14
    
    # Credits and foreign (simplified)
    credits: Decimal = Decimal("0")                  # Box 15
    foreign_transactions: Decimal = Decimal("0")     # Box 16 (for escalation)
    
    # Distributions
    distributions: Decimal = Decimal("0")            # Box 19
    
    # Metadata
    confidence: ConfidenceLevel = ConfidenceLevel.HIGH
    uncertain_fields: list[str] = Field(default_factory=list)  # Use Field for mutable default
    
    @field_validator("entity_ein", mode="before")
    @classmethod
    def validate_entity_ein(cls, value: str) -> str:
        return validate_ein(value)
    
    @field_validator("recipient_tin", mode="before")
    @classmethod
    def validate_recipient_tin(cls, value: str) -> str:
        return validate_tin(value)
    
    @property
    def requires_basis_escalation(self) -> bool:
        """
        Check if basis limitation may affect loss deductibility.
        
        Escalate if:
        - Net K-1 loss > $10k AND no capital account info
        - This prevents silent disallowance of legitimate losses
        """
        net_loss = self.ordinary_business_income + self.net_rental_real_estate
        has_significant_loss = net_loss < Decimal("-10000")
        missing_basis_info = self.capital_account_ending is None
        return has_significant_loss and missing_basis_info
    
    @property
    def total_k1_income(self) -> Decimal:
        """Sum of all income items from K-1."""
        return (
            self.ordinary_business_income + self.net_rental_real_estate +
            self.other_rental_income + self.guaranteed_payments +
            self.interest_income + self.dividend_income + self.royalties +
            self.net_short_term_capital_gain + self.net_long_term_capital_gain +
            self.net_section_1231_gain + self.other_income
        )
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.documents.models import FormK1
k1 = FormK1(
    entity_name='ABC Partnership',
    entity_ein='12-3456789',
    entity_type='partnership',
    tax_year=2024,
    recipient_name='John Smith',
    recipient_tin='123-45-6789',
    ownership_percentage=Decimal('25.0'),
    ordinary_business_income=Decimal('50000'),
)
print(f'K-1 created: {k1.entity_name}, income={k1.ordinary_business_income}')
"
```

**Done:** FormK1 model created with all K-1 boxes and validation

---

### Task 3: Create Form1099B Model

**Files:** src/documents/models.py

**Action:**
Create Form1099B Pydantic model for broker transactions:

```python
class Form1099B(BaseModel):
    """Form 1099-B Proceeds from Broker and Barter Exchange Transactions."""
    
    # Payer/Recipient
    payer_name: str
    payer_tin: str
    recipient_tin: str
    account_number: str | None = None
    
    # Transaction details
    description: str  # Security name/description
    date_acquired: str | None = None  # May be "Various"
    date_sold: str
    proceeds: Decimal  # Box 1d
    cost_basis: Decimal | None = None  # Box 1e (may be blank)
    
    # Gain/loss calculation
    gain_loss: Decimal | None = None  # Calculated or reported
    wash_sale_loss_disallowed: Decimal = Decimal("0")  # Box 1g
    
    # Classification
    is_short_term: bool = False  # Box 2: held â‰¤1 year
    is_long_term: bool = False   # Box 3: held >1 year
    basis_reported_to_irs: bool = True  # Box 12
    
    # Special types
    is_collectibles: bool = False
    is_qof: bool = False  # Qualified Opportunity Fund
    
    # Metadata
    confidence: ConfidenceLevel = ConfidenceLevel.HIGH
    uncertain_fields: list[str] = Field(default_factory=list)  # Use Field for mutable default
    
    @field_validator("payer_tin", "recipient_tin", mode="before")
    @classmethod
    def validate_tins(cls, value: str) -> str:
        return validate_tin(value)
    
    @property
    def requires_basis_escalation(self) -> bool:
        """Check if transaction needs basis escalation (not reported to IRS and missing)."""
        return self.cost_basis is None and not self.basis_reported_to_irs
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.documents.models import Form1099B
b = Form1099B(
    payer_name='Fidelity Investments',
    payer_tin='12-3456789',
    recipient_tin='123-45-6789',
    description='AAPL - Apple Inc',
    date_sold='2024-06-15',
    proceeds=Decimal('10000'),
    cost_basis=Decimal('8000'),
    is_long_term=True,
)
print(f'1099-B: {b.description}, proceeds={b.proceeds}')
"
```

**Done:** Form1099B model created with transaction fields

---

### Task 3b: Create Form1099BSummary Model (Aggregated)

**Files:** src/documents/models.py

**Action:**
Create Form1099BSummary for high-volume broker statements (50+ transactions):

```python
class Form1099BSummary(BaseModel):
    """
    Aggregated 1099-B summary for high-volume broker statements.
    
    When a broker statement has >50 transactions, extract category totals
    instead of individual transactions. This matches IRS Form 8949 categories.
    """
    
    # Payer info (same for all transactions)
    payer_name: str
    payer_tin: str
    recipient_tin: str
    
    # Category A: Short-term, basis reported to IRS
    cat_a_proceeds: Decimal = Decimal("0")
    cat_a_cost_basis: Decimal = Decimal("0")
    cat_a_adjustments: Decimal = Decimal("0")
    cat_a_gain_loss: Decimal = Decimal("0")
    cat_a_transaction_count: int = 0
    
    # Category B: Short-term, basis NOT reported to IRS
    cat_b_proceeds: Decimal = Decimal("0")
    cat_b_cost_basis: Decimal | None = None  # May need client input
    cat_b_adjustments: Decimal = Decimal("0")
    cat_b_transaction_count: int = 0
    
    # Category D: Long-term, basis reported to IRS
    cat_d_proceeds: Decimal = Decimal("0")
    cat_d_cost_basis: Decimal = Decimal("0")
    cat_d_adjustments: Decimal = Decimal("0")
    cat_d_gain_loss: Decimal = Decimal("0")
    cat_d_transaction_count: int = 0
    
    # Category E: Long-term, basis NOT reported to IRS
    cat_e_proceeds: Decimal = Decimal("0")
    cat_e_cost_basis: Decimal | None = None
    cat_e_adjustments: Decimal = Decimal("0")
    cat_e_transaction_count: int = 0
    
    # Wash sale totals (summed across all categories)
    total_wash_sale_disallowed: Decimal = Decimal("0")
    
    # Collectibles and other special categories
    collectibles_gain: Decimal = Decimal("0")
    section_1202_gain: Decimal = Decimal("0")
    
    # Metadata
    confidence: ConfidenceLevel = ConfidenceLevel.HIGH
    total_transaction_count: int = 0
    
    @property
    def has_missing_basis(self) -> bool:
        """Check if any non-reported categories need basis input."""
        return (
            (self.cat_b_transaction_count > 0 and self.cat_b_cost_basis is None) or
            (self.cat_e_transaction_count > 0 and self.cat_e_cost_basis is None)
        )
    
    @property
    def total_short_term_gain_loss(self) -> Decimal:
        """Total short-term gain/loss from categories A and B."""
        cat_a = self.cat_a_gain_loss
        cat_b = (self.cat_b_proceeds - (self.cat_b_cost_basis or Decimal("0")) 
                 if self.cat_b_cost_basis else Decimal("0"))
        return cat_a + cat_b
    
    @property
    def total_long_term_gain_loss(self) -> Decimal:
        """Total long-term gain/loss from categories D and E."""
        cat_d = self.cat_d_gain_loss
        cat_e = (self.cat_e_proceeds - (self.cat_e_cost_basis or Decimal("0"))
                 if self.cat_e_cost_basis else Decimal("0"))
        return cat_d + cat_e
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.documents.models import Form1099BSummary
summary = Form1099BSummary(
    payer_name='Fidelity Investments',
    payer_tin='12-3456789',
    recipient_tin='123-45-6789',
    cat_a_proceeds=Decimal('50000'),
    cat_a_cost_basis=Decimal('45000'),
    cat_a_gain_loss=Decimal('5000'),
    cat_a_transaction_count=75,
    cat_d_proceeds=Decimal('100000'),
    cat_d_cost_basis=Decimal('80000'),
    cat_d_gain_loss=Decimal('20000'),
    cat_d_transaction_count=120,
    total_transaction_count=195,
)
print(f'Summary: {summary.total_transaction_count} transactions')
print(f'ST gain: {summary.total_short_term_gain_loss}')
print(f'LT gain: {summary.total_long_term_gain_loss}')
"
```

**Done:** Form1099BSummary model for aggregated broker statements

---

### Task 4: Update CRITICAL_FIELDS

**Files:** src/documents/confidence.py

**Action:**
Add critical fields for new document types:

```python
CRITICAL_FIELDS: dict[DocumentType, list[str]] = {
    # ... existing entries ...
    DocumentType.FORM_K1: [
        "entity_ein",
        "recipient_tin",
        "entity_type",
        "ordinary_business_income",
    ],
    DocumentType.FORM_1099_B: [
        "payer_tin",
        "recipient_tin",
        "proceeds",
        # NOTE: cost_basis is conditionally critical based on basis_reported_to_irs
        # If basis_reported_to_irs=False, missing cost_basis is expected (escalate, don't fail)
        # See confidence.py for conditional logic implementation
    ],
    DocumentType.FORM_1095_A: [
        "recipient_tin",
        "annual_slcsp_premium",  # Or check len(monthly_data) > 0
        "annual_advance_ptc",
    ],
}
```

Also add conditional critical field logic for 1099-B cost_basis:

```python
def get_critical_fields_for_1099b(form: Form1099B) -> list[str]:
    """Get critical fields for 1099-B, considering basis_reported_to_irs."""
    base_fields = ["payer_tin", "recipient_tin", "proceeds"]
    
    # cost_basis is only critical if it was reported to IRS
    # If basis_reported_to_irs=False, missing basis is expected and should escalate,
    # not be treated as extraction failure
    if form.basis_reported_to_irs:
        base_fields.append("cost_basis")
    
    return base_fields
```

**Verify:**
```bash
uv run python -c "
from src.documents.confidence import CRITICAL_FIELDS
from src.documents.models import DocumentType
print(f'K-1 critical: {CRITICAL_FIELDS[DocumentType.FORM_K1]}')
print(f'1099-B critical: {CRITICAL_FIELDS[DocumentType.FORM_1099_B]}')
"
```

**Done:** CRITICAL_FIELDS includes K-1 and 1099-B entries with conditional cost_basis logic

---

### Task 5: Update Classifier Prompt

**Files:** src/documents/classifier.py

**Action:**
Update CLASSIFICATION_PROMPT to recognize K-1 and 1099-B:

Add to document type descriptions:
```
- K-1: Schedule K-1 from Partnership (Form 1065) or S-Corporation (Form 1120-S). 
  Contains entity information, partner/shareholder details, and boxes for various 
  types of income, deductions, and credits. Look for "Schedule K-1" header.
  
- 1099-B: Proceeds from Broker and Barter Exchange Transactions. Shows stock/security 
  sales with dates acquired/sold, proceeds, cost basis, and gain/loss. Look for 
  "1099-B" and broker name.
  
- 1095-A: Health Insurance Marketplace Statement. Shows monthly premiums, SLCSP amounts,
  and advance payments. Look for "1095-A" and Marketplace coverage information.
```

**Verify:**
```bash
uv run python -c "
from src.documents.classifier import CLASSIFICATION_PROMPT
assert 'K-1' in CLASSIFICATION_PROMPT
assert '1099-B' in CLASSIFICATION_PROMPT
print('Classifier prompt updated')
"
```

**Done:** Classifier recognizes K-1 and 1099-B documents

---

### Task 6: Create Model Tests

**Files:** tests/documents/test_models.py

**Action:**
Add tests for FormK1 and Form1099B models:

```python
class TestFormK1:
    """Tests for FormK1 model."""
    
    def test_k1_basic_creation(self):
        """K-1 can be created with required fields."""
        ...
    
    def test_k1_ein_validation(self):
        """K-1 validates entity EIN format."""
        ...
    
    def test_k1_recipient_tin_validation(self):
        """K-1 validates recipient TIN format."""
        ...
    
    def test_k1_default_income_values(self):
        """K-1 income fields default to zero."""
        ...
    
    def test_k1_entity_types(self):
        """K-1 accepts partnership and s_corp entity types."""
        ...


class TestForm1099B:
    """Tests for Form1099B model."""
    
    def test_1099b_basic_creation(self):
        """1099-B can be created with required fields."""
        ...
    
    def test_1099b_tin_validation(self):
        """1099-B validates TIN formats."""
        ...
    
    def test_1099b_optional_cost_basis(self):
        """1099-B allows None for cost basis (not reported)."""
        ...
    
    def test_1099b_short_long_term(self):
        """1099-B tracks short-term vs long-term."""
        ...
```

**Verify:**
```bash
uv run pytest tests/documents/test_models.py -v -k "K1 or 1099B" --tb=short
```
All new tests pass.

**Done:** 15+ tests for K-1 and 1099-B models pass

---

### Task 7: Update Module Exports

**Files:** src/documents/__init__.py

**Action:**
Export new models:

```python
from src.documents.models import (
    # ... existing exports ...
    FormK1,
    Form1099B,
)

__all__ = [
    # ... existing exports ...
    "FormK1",
    "Form1099B",
]
```

**Verify:**
```bash
uv run python -c "from src.documents import FormK1, Form1099B; print('Exports OK')"
```

**Done:** FormK1 and Form1099B exported from documents module

---

## Success Criteria

- [ ] DocumentType enum includes FORM_K1, FORM_1099_B, FORM_1095_A
- [ ] FormK1 model with all K-1 boxes and TIN validation
- [ ] Form1099B model with transaction fields
- [ ] CRITICAL_FIELDS updated for confidence scoring
- [ ] Classifier prompt recognizes new document types
- [ ] 15+ model tests passing
- [ ] All existing Phase 3 tests still pass

## Commit

After all tasks complete:
```bash
git add -A
git commit -m "feat(04-01): add K-1 and 1099-B document models"
```
