# Plan 04-02: K-1 and 1099-B Extractors

---
phase: 04-personal-tax-complex
plan: 02
type: execute
wave: 1
depends_on: ["04-01"]
---

## Objective

Create Vision API extraction prompts and functions for K-1 and 1099-B documents.

**Purpose:** Enable automated extraction of K-1 and 1099-B data from scanned documents using the same pattern established in Phase 3.

**Output:**
- FORM_K1_PROMPT for extraction
- FORM_1099_B_PROMPT for extraction
- extract_k1() function
- extract_1099_b() function
- Mock functions for testing

## Tasks

### Task 1: Create K-1 Extraction Prompt

**Files:** src/documents/prompts.py

**Action:**
Create FORM_K1_PROMPT with detailed field mappings:

```python
FORM_K1_PROMPT = """
You are extracting data from a Schedule K-1 (Form 1065 or Form 1120-S).
Return a JSON object with the following fields:

PART I - ENTITY INFORMATION:
- entity_name: Name of partnership or S-corporation
- entity_ein: Entity's Employer Identification Number (XX-XXXXXXX format)
- entity_type: "partnership" (Form 1065) or "s_corp" (Form 1120-S)
- tax_year: The tax year this K-1 is for (YYYY format)

PART II - PARTNER/SHAREHOLDER INFORMATION:
- recipient_name: Partner or shareholder name
- recipient_tin: Partner/shareholder's TIN (SSN or EIN)
- ownership_percentage: Percentage of ownership (as decimal, e.g., 25.5 for 25.5%)

PART III - SHARE OF INCOME, DEDUCTIONS, CREDITS:
- ordinary_business_income: Box 1 - Ordinary business income (loss)
- net_rental_real_estate: Box 2 - Net rental real estate income (loss)
- other_rental_income: Box 3 - Other net rental income (loss)
- guaranteed_payments: Box 4 - Guaranteed payments (partnerships only)
- interest_income: Box 5 - Interest income
- dividend_income: Box 6a/6b - Dividends (total amount)
- royalties: Box 7 - Royalties
- net_short_term_capital_gain: Box 8 - Net short-term capital gain (loss)
- net_long_term_capital_gain: Box 9a - Net long-term capital gain (loss)
- net_section_1231_gain: Box 10 - Net section 1231 gain (loss)
- other_income: Box 11 - Other income (loss) - sum of all codes
- section_179_deduction: Box 12 - Section 179 deduction
- other_deductions: Box 13 - Other deductions - sum of all codes
- self_employment_earnings: Box 14 - Self-employment earnings (loss)
- credits: Box 15 - Credits (total of all credit types)
- foreign_transactions: Box 16 - Foreign transactions (total amount)
- distributions: Box 19 - Distributions

For all amounts:
- Use negative numbers for losses
- Enter 0 if box is blank or not applicable
- Look for totals, not individual codes within boxes

Return JSON format exactly matching the field names above.
Also return:
- uncertain_fields: Array of field names with low confidence
"""
```

**Verify:**
```bash
uv run python -c "
from src.documents.prompts import FORM_K1_PROMPT
assert 'ordinary_business_income' in FORM_K1_PROMPT
assert 'Box 1' in FORM_K1_PROMPT
print('K-1 prompt ready')
"
```

**Done:** FORM_K1_PROMPT created with all box mappings

---

### Task 2: Create 1099-B Extraction Prompt

**Files:** src/documents/prompts.py

**Action:**
Create FORM_1099_B_PROMPT:

```python
FORM_1099_B_PROMPT = """
You are extracting data from a Form 1099-B (Proceeds from Broker Transactions).
This form may have one or multiple transactions. Extract each transaction separately.

For EACH transaction, extract:

PAYER INFORMATION:
- payer_name: Broker/financial institution name
- payer_tin: Broker's TIN (EIN)
- account_number: Account number (if shown)

RECIPIENT:
- recipient_tin: Recipient's SSN or TIN

TRANSACTION DETAILS:
- description: Box 1a - Description of property (stock name, CUSIP, etc.)
- date_acquired: Box 1b - Date acquired (YYYY-MM-DD or "Various")
- date_sold: Box 1c - Date sold or disposed (YYYY-MM-DD)
- proceeds: Box 1d - Proceeds (gross amount)
- cost_basis: Box 1e - Cost or other basis (may be blank if not reported to IRS)
- wash_sale_loss_disallowed: Box 1g - Wash sale loss disallowed
- gain_loss: Box 1h - Gain or loss (if reported)

CLASSIFICATION:
- is_short_term: True if Box 2 is checked (held 1 year or less)
- is_long_term: True if Box 3 is checked (held more than 1 year)
- basis_reported_to_irs: True if Box 12 is checked

SPECIAL:
- is_collectibles: True if this is a collectibles transaction
- is_qof: True if this is a Qualified Opportunity Fund investment

For each transaction on the form, return a separate object in a JSON array.
If the form shows summary/totals, ignore those and extract individual transactions.

Return:
- transactions: Array of transaction objects, each with:
  - All fields above
  - uncertain_fields: Array of field names with low confidence FOR THIS TRANSACTION
- form_level_uncertain_fields: Array of fields uncertain at the form level (payer_name, etc.)

NOTE: Track uncertainty per-transaction using "uncertain_fields" (matching the Form1099B model field name).
"""
```

**Verify:**
```bash
uv run python -c "
from src.documents.prompts import FORM_1099_B_PROMPT
assert 'proceeds' in FORM_1099_B_PROMPT
assert 'Box 1d' in FORM_1099_B_PROMPT
print('1099-B prompt ready')
"
```

**Done:** FORM_1099_B_PROMPT created for transaction extraction

---

### Task 3: Implement extract_k1() Function

**Files:** src/documents/extractor.py

**Action:**
Create extract_k1() using established pattern:

```python
async def extract_k1(
    client: anthropic.AsyncAnthropic,
    image_data: bytes,
    mock: bool = False,
) -> FormK1:
    """
    Extract Schedule K-1 data from image.
    
    Args:
        client: Anthropic API client
        image_data: Document image bytes
        mock: Use mock extraction for testing
        
    Returns:
        FormK1 model with extracted data
        
    Raises:
        ExtractionError: If extraction fails
    """
    if mock:
        return _mock_k1()
    
    response = await _extract_with_vision(
        client=client,
        image_data=image_data,
        prompt=FORM_K1_PROMPT,
        response_model=FormK1,
    )
    
    return response
```

**Verify:**
```bash
uv run python -c "
import asyncio
from src.documents.extractor import extract_k1

async def test():
    result = await extract_k1(None, b'', mock=True)
    print(f'Mock K-1: {result.entity_name}, income={result.ordinary_business_income}')

asyncio.run(test())
"
```

**Done:** extract_k1() function implemented

---

### Task 4: Implement extract_1099_b() Function

**Files:** src/documents/extractor.py

**Action:**
Create extract_1099_b() that returns multiple transactions:

```python
async def extract_1099_b(
    client: anthropic.AsyncAnthropic,
    image_data: bytes,
    mock: bool = False,
) -> list[Form1099B]:
    """
    Extract Form 1099-B transactions from image.
    
    A single 1099-B form may contain multiple transactions.
    
    Args:
        client: Anthropic API client
        image_data: Document image bytes
        mock: Use mock extraction for testing
        
    Returns:
        List of Form1099B models for each transaction
        
    Raises:
        ExtractionError: If extraction fails
    """
    if mock:
        return _mock_1099_b()
    
    # Custom extraction for multi-transaction form
    response = await _extract_with_vision(
        client=client,
        image_data=image_data,
        prompt=FORM_1099_B_PROMPT,
        response_model=Form1099BExtraction,  # Wrapper model
    )
    
    return response.transactions
```

Create wrapper model for extraction:

```python
class Form1099BExtraction(BaseModel):
    """Wrapper for 1099-B multi-transaction extraction."""
    transactions: list[Form1099B]
    form_level_uncertain_fields: list[str] = Field(default_factory=list)

# NOTE: Each Form1099B should have its own uncertain_fields
# to track per-transaction uncertainty (e.g., cost_basis missing on one transaction)
```

**Verify:**
```bash
uv run python -c "
import asyncio
from src.documents.extractor import extract_1099_b

async def test():
    results = await extract_1099_b(None, b'', mock=True)
    print(f'Mock 1099-Bs: {len(results)} transactions')
    for t in results:
        print(f'  - {t.description}: proceeds={t.proceeds}')

asyncio.run(test())
"
```

**Done:** extract_1099_b() function returns list of transactions

---

### Task 5: Create Mock Functions

**Files:** src/documents/extractor.py

**Action:**
Create mock functions for testing:

```python
def _mock_k1() -> FormK1:
    """Return mock K-1 for testing."""
    return FormK1(
        entity_name="Demo Partnership LLC",
        entity_ein="12-3456789",
        entity_type="partnership",
        tax_year=2024,
        recipient_name="John Q. Taxpayer",
        recipient_tin="123-45-6789",
        ownership_percentage=Decimal("25.0"),
        ordinary_business_income=Decimal("45000"),
        guaranteed_payments=Decimal("12000"),
        interest_income=Decimal("500"),
        dividend_income=Decimal("1200"),
        net_long_term_capital_gain=Decimal("3500"),
        distributions=Decimal("15000"),
        self_employment_earnings=Decimal("57000"),
        confidence=ConfidenceLevel.HIGH,
    )


def _mock_1099_b() -> list[Form1099B]:
    """Return mock 1099-B transactions for testing."""
    return [
        Form1099B(
            payer_name="Fidelity Investments",
            payer_tin="12-3456789",
            recipient_tin="123-45-6789",
            account_number="X12345",
            description="AAPL - Apple Inc (100 shares)",
            date_acquired="2023-01-15",
            date_sold="2024-06-20",
            proceeds=Decimal("19500"),
            cost_basis=Decimal("15000"),
            is_long_term=True,
            confidence=ConfidenceLevel.HIGH,
        ),
        Form1099B(
            payer_name="Fidelity Investments",
            payer_tin="12-3456789",
            recipient_tin="123-45-6789",
            account_number="X12345",
            description="MSFT - Microsoft Corp (50 shares)",
            date_acquired="2024-03-01",
            date_sold="2024-09-15",
            proceeds=Decimal("21000"),
            cost_basis=Decimal("18500"),
            is_short_term=True,
            confidence=ConfidenceLevel.HIGH,
        ),
    ]
```

**Verify:**
```bash
uv run python -c "
from src.documents.extractor import _mock_k1, _mock_1099_b
k1 = _mock_k1()
print(f'Mock K-1: {k1.ordinary_business_income}')
b_list = _mock_1099_b()
print(f'Mock 1099-Bs: {len(b_list)} transactions')
"
```

**Done:** Mock functions return realistic test data

---

### Task 6: Update extract_document() Router

**Files:** src/documents/extractor.py

**Action:**
Add new document types to extraction router:

```python
async def extract_document(
    client: anthropic.AsyncAnthropic,
    doc_type: DocumentType,
    image_data: bytes,
    mock: bool = False,
) -> BaseModel:
    """
    Route document extraction based on type.
    """
    extractors = {
        # ... existing extractors ...
        DocumentType.FORM_K1: extract_k1,
        DocumentType.FORM_1099_B: extract_1099_b,
    }
    
    extractor = extractors.get(doc_type)
    if not extractor:
        raise ValueError(f"No extractor for document type: {doc_type}")
    
    return await extractor(client, image_data, mock=mock)
```

**Verify:**
```bash
uv run python -c "
import asyncio
from src.documents.models import DocumentType
from src.documents.extractor import extract_document

async def test():
    result = await extract_document(None, DocumentType.FORM_K1, b'', mock=True)
    print(f'Routed K-1: {result.entity_name}')

asyncio.run(test())
"
```

**Done:** Router handles K-1 and 1099-B extraction

---

### Task 7: Create Extractor Tests

**Files:** tests/documents/test_extractor.py

**Action:**
Add tests for new extractors:

```python
class TestK1Extractor:
    """Tests for K-1 extraction."""
    
    @pytest.mark.asyncio
    async def test_extract_k1_mock(self):
        """K-1 extraction returns valid FormK1 in mock mode."""
        result = await extract_k1(None, b"", mock=True)
        assert isinstance(result, FormK1)
        assert result.entity_type in ["partnership", "s_corp"]
        assert result.ordinary_business_income >= 0
    
    @pytest.mark.asyncio
    async def test_extract_k1_has_required_fields(self):
        """K-1 extraction includes all required fields."""
        result = await extract_k1(None, b"", mock=True)
        assert result.entity_name
        assert result.entity_ein
        assert result.recipient_tin
        assert result.tax_year
    
    @pytest.mark.asyncio
    async def test_extract_k1_confidence(self):
        """K-1 extraction includes confidence level."""
        result = await extract_k1(None, b"", mock=True)
        assert result.confidence in ConfidenceLevel


class TestForm1099BExtractor:
    """Tests for 1099-B extraction."""
    
    @pytest.mark.asyncio
    async def test_extract_1099_b_mock(self):
        """1099-B extraction returns list of transactions."""
        result = await extract_1099_b(None, b"", mock=True)
        assert isinstance(result, list)
        assert len(result) >= 1
        assert all(isinstance(t, Form1099B) for t in result)
    
    @pytest.mark.asyncio
    async def test_extract_1099_b_transaction_fields(self):
        """1099-B transactions have required fields."""
        result = await extract_1099_b(None, b"", mock=True)
        for t in result:
            assert t.payer_name
            assert t.description
            assert t.date_sold
            assert t.proceeds > 0
    
    @pytest.mark.asyncio
    async def test_extract_1099_b_term_classification(self):
        """1099-B transactions have short/long term classification."""
        result = await extract_1099_b(None, b"", mock=True)
        for t in result:
            # At least one should be true, but not both
            assert t.is_short_term != t.is_long_term or (not t.is_short_term and not t.is_long_term)


class TestDocumentRouter:
    """Tests for extract_document router."""
    
    @pytest.mark.asyncio
    async def test_router_k1(self):
        """Router handles K-1 documents."""
        result = await extract_document(None, DocumentType.FORM_K1, b"", mock=True)
        assert isinstance(result, FormK1)
    
    @pytest.mark.asyncio
    async def test_router_1099_b(self):
        """Router handles 1099-B documents."""
        result = await extract_document(None, DocumentType.FORM_1099_B, b"", mock=True)
        assert isinstance(result, list)
```

**Verify:**
```bash
uv run pytest tests/documents/test_extractor.py -v -k "K1 or 1099" --tb=short
```
All tests pass.

**Done:** Extractor tests for K-1 and 1099-B pass

---

## Success Criteria

- [ ] FORM_K1_PROMPT with all box mappings
- [ ] FORM_1099_B_PROMPT for multi-transaction forms
- [ ] extract_k1() returns FormK1 model
- [ ] extract_1099_b() returns list of Form1099B
- [ ] Mock functions return realistic test data
- [ ] extract_document() router updated
- [ ] All extractor tests pass
- [ ] All Phase 3 tests still pass

## Commit

After all tasks complete:
```bash
git add -A
git commit -m "feat(04-02): add K-1 and 1099-B extractors with prompts"
```
