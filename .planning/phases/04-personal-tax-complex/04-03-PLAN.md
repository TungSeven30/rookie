# Plan 04-03: Schedule C Calculator and Self-Employment Tax

---
phase: 04-personal-tax-complex
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
---

## Objective

Implement Schedule C (Profit or Loss from Business) and Schedule SE (Self-Employment Tax) calculations.

**Purpose:** Enable calculation of net business income and self-employment tax for sole proprietors and single-member LLCs.

**Output:**
- ScheduleCData dataclass
- ScheduleCExpenses dataclass
- calculate_schedule_c() function
- calculate_self_employment_tax() function
- Extended IncomeSummary with business income fields

## Tasks

### Task 1: Create Schedule C Expense Categories

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create ScheduleCExpenses dataclass with IRS expense categories (Lines 8-27):

```python
@dataclass
class ScheduleCExpenses:
    """Schedule C expense categories (Lines 8-27)."""
    
    advertising: Decimal = Decimal("0")                    # Line 8
    car_truck: Decimal = Decimal("0")                      # Line 9
    commissions_fees: Decimal = Decimal("0")               # Line 10
    contract_labor: Decimal = Decimal("0")                 # Line 11
    depletion: Decimal = Decimal("0")                      # Line 12
    depreciation: Decimal = Decimal("0")                   # Line 13
    employee_benefits: Decimal = Decimal("0")              # Line 14
    insurance: Decimal = Decimal("0")                      # Line 15
    interest_mortgage: Decimal = Decimal("0")              # Line 16a
    interest_other: Decimal = Decimal("0")                 # Line 16b
    legal_professional: Decimal = Decimal("0")             # Line 17
    office_expense: Decimal = Decimal("0")                 # Line 18
    pension_profit_sharing: Decimal = Decimal("0")         # Line 19
    rent_vehicles_machinery: Decimal = Decimal("0")        # Line 20a
    rent_other: Decimal = Decimal("0")                     # Line 20b
    repairs_maintenance: Decimal = Decimal("0")            # Line 21
    supplies: Decimal = Decimal("0")                       # Line 22
    taxes_licenses: Decimal = Decimal("0")                 # Line 23
    travel: Decimal = Decimal("0")                         # Line 24a
    deductible_meals: Decimal = Decimal("0")               # Line 24b
    utilities: Decimal = Decimal("0")                      # Line 25
    wages: Decimal = Decimal("0")                          # Line 26
    other_expenses: Decimal = Decimal("0")                 # Line 27
    
    @property
    def total(self) -> Decimal:
        """Sum of all expense categories."""
        return (
            self.advertising + self.car_truck + self.commissions_fees +
            self.contract_labor + self.depletion + self.depreciation +
            self.employee_benefits + self.insurance + self.interest_mortgage +
            self.interest_other + self.legal_professional + self.office_expense +
            self.pension_profit_sharing + self.rent_vehicles_machinery +
            self.rent_other + self.repairs_maintenance + self.supplies +
            self.taxes_licenses + self.travel + self.deductible_meals +
            self.utilities + self.wages + self.other_expenses
        )
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import ScheduleCExpenses
exp = ScheduleCExpenses(
    advertising=Decimal('500'),
    supplies=Decimal('1200'),
    utilities=Decimal('3000'),
)
print(f'Total expenses: {exp.total}')
"
```

**Done:** ScheduleCExpenses dataclass with all IRS categories

---

### Task 2: Create ScheduleCData Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create ScheduleCData for complete Schedule C data:

```python
@dataclass
class ScheduleCData:
    """Schedule C (Profit or Loss from Business) data."""
    
    # Business identification
    business_name: str
    business_activity: str
    principal_business_code: str  # 6-digit NAICS code
    employer_id: str | None = None
    
    # Accounting method
    accounting_method: str = "cash"  # cash, accrual, or other
    
    # Income (Part I)
    gross_receipts: Decimal = Decimal("0")         # Line 1
    returns_allowances: Decimal = Decimal("0")     # Line 2
    cost_of_goods_sold: Decimal = Decimal("0")     # Line 4
    other_income: Decimal = Decimal("0")           # Line 6
    
    # Expenses (Part II)
    expenses: ScheduleCExpenses = field(default_factory=ScheduleCExpenses)
    
    # Home office (if applicable)
    home_office_deduction: Decimal = Decimal("0")  # From Form 8829
    
    @property
    def gross_income(self) -> Decimal:
        """Line 3: Gross receipts minus returns."""
        return self.gross_receipts - self.returns_allowances
    
    @property
    def gross_profit(self) -> Decimal:
        """Line 5: Gross income minus COGS."""
        return self.gross_income - self.cost_of_goods_sold
    
    @property
    def total_income(self) -> Decimal:
        """Line 7: Gross profit plus other income."""
        return self.gross_profit + self.other_income
    
    @property
    def total_expenses(self) -> Decimal:
        """Line 28: Total expenses."""
        return self.expenses.total + self.home_office_deduction
    
    @property
    def net_profit_or_loss(self) -> Decimal:
        """Line 31: Net profit (or loss)."""
        return self.total_income - self.total_expenses
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import ScheduleCData, ScheduleCExpenses
sch_c = ScheduleCData(
    business_name='Consulting LLC',
    business_activity='Management Consulting',
    principal_business_code='541611',
    gross_receipts=Decimal('150000'),
    expenses=ScheduleCExpenses(
        office_expense=Decimal('3000'),
        supplies=Decimal('2000'),
        legal_professional=Decimal('5000'),
    ),
)
print(f'Net profit: {sch_c.net_profit_or_loss}')
"
```

**Done:** ScheduleCData with income and expense calculations

---

### Task 3: Implement calculate_schedule_c()

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create calculate_schedule_c() function:

```python
def calculate_schedule_c(
    data: ScheduleCData,
) -> dict[str, Decimal]:
    """
    Calculate Schedule C net profit and key figures.
    
    Args:
        data: ScheduleCData with business income and expenses
        
    Returns:
        Dict with line-by-line calculation results:
        - gross_income (Line 3)
        - gross_profit (Line 5)
        - total_income (Line 7)
        - total_expenses (Line 28)
        - net_profit_or_loss (Line 31)
        - qualified_business_income (for QBI deduction)
    """
    result = {
        "gross_income": data.gross_income,
        "gross_profit": data.gross_profit,
        "total_income": data.total_income,
        "total_expenses": data.total_expenses,
        "net_profit_or_loss": data.net_profit_or_loss,
    }
    
    # QBI is generally net profit minus SE tax deduction (calculated later)
    # For now, return net profit as qualified business income
    result["qualified_business_income"] = max(Decimal("0"), data.net_profit_or_loss)
    
    return result
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import (
    ScheduleCData, ScheduleCExpenses, calculate_schedule_c
)
sch_c = ScheduleCData(
    business_name='Test Business',
    business_activity='Consulting',
    principal_business_code='541611',
    gross_receipts=Decimal('100000'),
    cost_of_goods_sold=Decimal('20000'),
    expenses=ScheduleCExpenses(
        office_expense=Decimal('5000'),
        travel=Decimal('3000'),
    ),
)
result = calculate_schedule_c(sch_c)
print(f'Net profit: {result[\"net_profit_or_loss\"]}')
print(f'QBI: {result[\"qualified_business_income\"]}')
"
```

**Done:** calculate_schedule_c() returns all Schedule C figures

---

### Task 4: Create SelfEmploymentTax Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create SelfEmploymentTax dataclass for results:

```python
@dataclass
class SelfEmploymentTax:
    """Self-employment tax calculation result (Schedule SE)."""
    
    # Net earnings from self-employment
    net_earnings: Decimal
    
    # Tax components
    social_security_tax: Decimal
    medicare_tax: Decimal
    additional_medicare_tax: Decimal
    
    # Totals
    total_se_tax: Decimal
    deductible_portion: Decimal  # 50% of SE tax
    
    # Thresholds used
    social_security_wage_base: Decimal
    additional_medicare_threshold: Decimal
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import SelfEmploymentTax
se = SelfEmploymentTax(
    net_earnings=Decimal('100000'),
    social_security_tax=Decimal('10000'),
    medicare_tax=Decimal('2900'),
    additional_medicare_tax=Decimal('0'),
    total_se_tax=Decimal('12900'),
    deductible_portion=Decimal('6450'),
    social_security_wage_base=Decimal('168600'),
    additional_medicare_threshold=Decimal('200000'),
)
print(f'SE Tax: {se.total_se_tax}, Deductible: {se.deductible_portion}')
"
```

**Done:** SelfEmploymentTax dataclass created

---

### Task 5: Implement calculate_self_employment_tax()

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create calculate_self_employment_tax() with 2024 rates:

```python
def calculate_self_employment_tax(
    net_self_employment_earnings: Decimal,
    filing_status: FilingStatus,
    tax_year: int = 2024,
) -> SelfEmploymentTax:
    """
    Calculate self-employment tax (Schedule SE).
    
    2024 Rates:
    - 12.4% Social Security on net earnings up to $168,600
    - 2.9% Medicare on all net earnings
    - Additional 0.9% Medicare on earnings > $200k (single) / $250k (MFJ)
    
    Args:
        net_self_employment_earnings: Net earnings from Schedule C or K-1
        filing_status: For determining additional Medicare threshold
        tax_year: Tax year for rates/limits
        
    Returns:
        SelfEmploymentTax with breakdown
    """
    # 2024 thresholds
    SS_RATE = Decimal("0.124")
    MEDICARE_RATE = Decimal("0.029")
    ADDITIONAL_MEDICARE_RATE = Decimal("0.009")
    SS_WAGE_BASE = Decimal("168600")
    
    # Additional Medicare threshold by filing status
    ADDITIONAL_MEDICARE_THRESHOLD = {
        FilingStatus.SINGLE: Decimal("200000"),
        FilingStatus.MARRIED_FILING_JOINTLY: Decimal("250000"),
        FilingStatus.MARRIED_FILING_SEPARATELY: Decimal("125000"),
        FilingStatus.HEAD_OF_HOUSEHOLD: Decimal("200000"),
        FilingStatus.QUALIFYING_WIDOW: Decimal("200000"),
    }
    
    # Net earnings = 92.35% of net self-employment income
    net_earnings = net_self_employment_earnings * Decimal("0.9235")
    net_earnings = max(Decimal("0"), net_earnings)
    
    # Social Security (12.4% up to wage base)
    ss_taxable = min(net_earnings, SS_WAGE_BASE)
    social_security_tax = ss_taxable * SS_RATE
    
    # Medicare (2.9% on all)
    medicare_tax = net_earnings * MEDICARE_RATE
    
    # Additional Medicare (0.9% over threshold)
    threshold = ADDITIONAL_MEDICARE_THRESHOLD.get(
        filing_status, Decimal("200000")
    )
    additional_earnings = max(Decimal("0"), net_earnings - threshold)
    additional_medicare_tax = additional_earnings * ADDITIONAL_MEDICARE_RATE
    
    # Total and deductible
    total_se_tax = social_security_tax + medicare_tax + additional_medicare_tax
    deductible_portion = total_se_tax * Decimal("0.5")
    
    return SelfEmploymentTax(
        net_earnings=net_earnings,
        social_security_tax=social_security_tax.quantize(Decimal("0.01")),
        medicare_tax=medicare_tax.quantize(Decimal("0.01")),
        additional_medicare_tax=additional_medicare_tax.quantize(Decimal("0.01")),
        total_se_tax=total_se_tax.quantize(Decimal("0.01")),
        deductible_portion=deductible_portion.quantize(Decimal("0.01")),
        social_security_wage_base=SS_WAGE_BASE,
        additional_medicare_threshold=threshold,
    )
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import (
    calculate_self_employment_tax, FilingStatus
)
# Test with $100k SE income
result = calculate_self_employment_tax(
    Decimal('100000'),
    FilingStatus.SINGLE,
)
print(f'Net earnings: {result.net_earnings}')
print(f'SS Tax: {result.social_security_tax}')
print(f'Medicare: {result.medicare_tax}')
print(f'Total SE Tax: {result.total_se_tax}')
print(f'Deductible: {result.deductible_portion}')
"
```

Expected output (approximately):
- Net earnings: $92,350
- SS Tax: $11,451.40
- Medicare: $2,678.15
- Total SE Tax: $14,129.55
- Deductible: $7,064.78

**Done:** calculate_self_employment_tax() with proper rates

---

### Task 6: Extend IncomeSummary

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Add business income fields to IncomeSummary:

```python
@dataclass
class IncomeSummary:
    """Summary of all income sources."""
    
    # Existing Phase 3 fields (keep naming consistent)...
    total_wages: Decimal = Decimal("0")
    total_interest: Decimal = Decimal("0")
    total_dividends: Decimal = Decimal("0")
    qualified_dividends: Decimal = Decimal("0")
    total_nec: Decimal = Decimal("0")
    total_other: Decimal = Decimal("0")
    total_income: Decimal = Decimal("0")
    # ...
    
    # NEW: Business income fields (Phase 4)
    schedule_c_profit: Decimal = Decimal("0")       # Net profit from Schedule C
    k1_ordinary_income: Decimal = Decimal("0")      # K-1 Box 1
    k1_guaranteed_payments: Decimal = Decimal("0")  # K-1 Box 4
    self_employment_income: Decimal = Decimal("0")  # Total SE income (Schedule C + K-1 Box 14)
    
    # Self-employment tax
    se_tax: Decimal = Decimal("0")
    se_tax_deduction: Decimal = Decimal("0")        # Above-the-line deduction (50% of SE tax)
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import IncomeSummary
summary = IncomeSummary(
    total_wages=Decimal('50000'),  # Match Phase 3 naming
    schedule_c_profit=Decimal('75000'),
    self_employment_income=Decimal('75000'),
    se_tax=Decimal('10000'),
    se_tax_deduction=Decimal('5000'),
)
print(f'Total Wages: {summary.total_wages}')
print(f'Schedule C: {summary.schedule_c_profit}')
print(f'SE Tax Deduction: {summary.se_tax_deduction}')
"
```

**Done:** IncomeSummary extended with business income fields (using Phase 3 naming)

---

### Task 7: Update aggregate_income()

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Update aggregate_income() to accept Schedule C data:

```python
def aggregate_income(
    forms_w2: list[FormW2],
    forms_1099_int: list[Form1099INT] | None = None,
    forms_1099_div: list[Form1099DIV] | None = None,
    forms_1099_misc: list[Form1099MISC] | None = None,
    forms_1099_nec: list[Form1099NEC] | None = None,
    # NEW: Business documents
    schedule_c_data: list[ScheduleCData] | None = None,
    forms_k1: list[FormK1] | None = None,
    filing_status: FilingStatus = FilingStatus.SINGLE,
) -> IncomeSummary:
    """
    Aggregate income from all document sources.
    
    Args:
        ... existing args ...
        schedule_c_data: List of Schedule C business data
        forms_k1: List of K-1 forms
        filing_status: For SE tax calculation
        
    Returns:
        IncomeSummary with all income aggregated
    """
    # ... existing aggregation ...
    
    # Aggregate Schedule C
    schedule_c_profit = Decimal("0")
    if schedule_c_data:
        for sch_c in schedule_c_data:
            schedule_c_profit += sch_c.net_profit_or_loss
    
    # Aggregate K-1 income
    # NOTE: K-1 ordinary income (Box 1) is NOT the same as SE income
    # - SE income comes from Box 14 (self_employment_earnings)
    # - S-corp K-1s do NOT have SE tax (wages already taxed via W-2)
    # - Guaranteed payments (Box 4) are subject to SE tax for partnerships
    k1_ordinary = Decimal("0")
    k1_guaranteed = Decimal("0")
    k1_se_earnings = Decimal("0")  # Box 14 only
    if forms_k1:
        for k1 in forms_k1:
            k1_ordinary += k1.ordinary_business_income
            k1_guaranteed += k1.guaranteed_payments
            # Only use Box 14 for SE tax, and only for partnerships (not S-corps)
            if k1.entity_type == "partnership":
                k1_se_earnings += k1.self_employment_earnings  # Box 14
    
    # Calculate total self-employment income
    # SE income = Schedule C net profit + K-1 Box 14 (partnerships only)
    # NOTE: Guaranteed payments are INCLUDED in Box 14 when subject to SE tax
    self_employment_income = schedule_c_profit + k1_se_earnings
    
    # Calculate self-employment tax if applicable
    se_result = None
    if self_employment_income > Decimal("0"):
        se_result = calculate_self_employment_tax(
            self_employment_income,
            filing_status,
        )
    
    return IncomeSummary(
        # ... existing fields ...
        schedule_c_profit=schedule_c_profit,
        k1_ordinary_income=k1_ordinary,
        k1_guaranteed_payments=k1_guaranteed,
        self_employment_income=self_employment_income,
        se_tax=se_result.total_se_tax if se_result else Decimal("0"),
        se_tax_deduction=se_result.deductible_portion if se_result else Decimal("0"),
    )
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import (
    aggregate_income, ScheduleCData, ScheduleCExpenses, FilingStatus
)
sch_c = ScheduleCData(
    business_name='Test',
    business_activity='Consulting',
    principal_business_code='541611',
    gross_receipts=Decimal('100000'),
    expenses=ScheduleCExpenses(office_expense=Decimal('10000')),
)
summary = aggregate_income(
    forms_w2=[],
    schedule_c_data=[sch_c],
    filing_status=FilingStatus.SINGLE,
)
print(f'Schedule C profit: {summary.schedule_c_profit}')
print(f'SE tax: {summary.se_tax}')
print(f'SE deduction: {summary.se_tax_deduction}')
"
```

**Done:** aggregate_income() includes Schedule C and K-1 data

---

### Task 8: Create Schedule C Tests

**Files:** tests/agents/personal_tax/test_calculator.py

**Action:**
Add comprehensive tests for Schedule C and SE tax:

```python
class TestScheduleC:
    """Tests for Schedule C calculations."""
    
    def test_schedule_c_net_profit(self):
        """Schedule C calculates net profit correctly."""
        sch_c = ScheduleCData(
            business_name="Test Business",
            business_activity="Consulting",
            principal_business_code="541611",
            gross_receipts=Decimal("100000"),
            cost_of_goods_sold=Decimal("20000"),
            expenses=ScheduleCExpenses(
                office_expense=Decimal("5000"),
                supplies=Decimal("2000"),
            ),
        )
        result = calculate_schedule_c(sch_c)
        assert result["net_profit_or_loss"] == Decimal("73000")
    
    def test_schedule_c_with_loss(self):
        """Schedule C handles business loss."""
        sch_c = ScheduleCData(
            business_name="Startup",
            business_activity="Tech",
            principal_business_code="541511",
            gross_receipts=Decimal("10000"),
            expenses=ScheduleCExpenses(
                office_expense=Decimal("15000"),
            ),
        )
        result = calculate_schedule_c(sch_c)
        assert result["net_profit_or_loss"] == Decimal("-5000")
        assert result["qualified_business_income"] == Decimal("0")


class TestSelfEmploymentTax:
    """Tests for self-employment tax calculations."""
    
    def test_se_tax_basic(self):
        """SE tax calculated correctly for typical income."""
        result = calculate_self_employment_tax(
            Decimal("100000"),
            FilingStatus.SINGLE,
        )
        # Net = 100000 * 0.9235 = 92350
        # SS = 92350 * 0.124 = 11451.40
        # Med = 92350 * 0.029 = 2678.15
        # Total = 14129.55
        assert result.net_earnings == Decimal("92350")
        assert result.social_security_tax == Decimal("11451.40")
        assert result.total_se_tax == Decimal("14129.55")
    
    def test_se_tax_above_ss_wage_base(self):
        """SE tax respects Social Security wage base."""
        result = calculate_self_employment_tax(
            Decimal("200000"),
            FilingStatus.SINGLE,
        )
        # SS capped at wage base
        assert result.social_security_tax <= Decimal("168600") * Decimal("0.124")
    
    def test_se_tax_additional_medicare(self):
        """Additional Medicare applies above threshold."""
        result = calculate_self_employment_tax(
            Decimal("250000"),
            FilingStatus.SINGLE,
        )
        assert result.additional_medicare_tax > Decimal("0")
    
    def test_se_tax_deductible_portion(self):
        """SE tax deduction is 50% of total."""
        result = calculate_self_employment_tax(
            Decimal("100000"),
            FilingStatus.SINGLE,
        )
        assert result.deductible_portion == result.total_se_tax * Decimal("0.5")
```

**Verify:**
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v -k "ScheduleC or SelfEmployment" --tb=short
```
All tests pass.

**Done:** 15+ tests for Schedule C and SE tax pass

---

## Success Criteria

- [ ] ScheduleCExpenses with all IRS expense categories
- [ ] ScheduleCData with income and expense calculations
- [ ] calculate_schedule_c() returns all line items
- [ ] SelfEmploymentTax dataclass with breakdown
- [ ] calculate_self_employment_tax() with correct 2024 rates
- [ ] IncomeSummary extended with business fields
- [ ] aggregate_income() handles Schedule C and K-1
- [ ] K-1 SE tax uses Box 14 (not Box 1 + Box 4)
- [ ] S-corp K-1s excluded from SE tax calculation
- [ ] Test: K-1 with Box 14 SE earnings calculates correctly
- [ ] All Schedule C and SE tests pass
- [ ] All Phase 3 tests still pass

## Commit

After all tasks complete:
```bash
git add -A
git commit -m "feat(04-03): add Schedule C and self-employment tax calculator"
```
