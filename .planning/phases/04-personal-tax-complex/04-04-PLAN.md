# Plan 04-04: Schedule E Calculator (Rental Income)

---
phase: 04-personal-tax-complex
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
---

## Objective

Implement Schedule E Part I calculations for rental real estate income and expenses.

**Purpose:** Enable calculation of net rental income/loss with passive activity loss limitations.

**Output:**
- RentalProperty dataclass
- ScheduleEData dataclass
- calculate_schedule_e() function
- Passive activity loss limitation handling
- Extended IncomeSummary with rental income fields

## Tasks

### Task 1: Create RentalExpenses Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create RentalExpenses dataclass with Schedule E expense categories:

```python
@dataclass
class RentalExpenses:
    """Rental property expense categories (Schedule E Part I)."""
    
    advertising: Decimal = Decimal("0")               # Line 5
    auto_travel: Decimal = Decimal("0")               # Line 6
    cleaning_maintenance: Decimal = Decimal("0")      # Line 7
    commissions: Decimal = Decimal("0")               # Line 8
    insurance: Decimal = Decimal("0")                 # Line 9
    legal_professional: Decimal = Decimal("0")        # Line 10
    management_fees: Decimal = Decimal("0")           # Line 11
    mortgage_interest: Decimal = Decimal("0")         # Line 12
    other_interest: Decimal = Decimal("0")            # Line 13
    repairs: Decimal = Decimal("0")                   # Line 14
    supplies: Decimal = Decimal("0")                  # Line 15
    taxes: Decimal = Decimal("0")                     # Line 16
    utilities: Decimal = Decimal("0")                 # Line 17
    depreciation: Decimal = Decimal("0")              # Line 18
    other_expenses: Decimal = Decimal("0")            # Line 19
    
    @property
    def total(self) -> Decimal:
        """Line 20: Total expenses."""
        return (
            self.advertising + self.auto_travel + self.cleaning_maintenance +
            self.commissions + self.insurance + self.legal_professional +
            self.management_fees + self.mortgage_interest + self.other_interest +
            self.repairs + self.supplies + self.taxes + self.utilities +
            self.depreciation + self.other_expenses
        )
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import RentalExpenses
exp = RentalExpenses(
    mortgage_interest=Decimal('8000'),
    taxes=Decimal('3000'),
    insurance=Decimal('1500'),
    repairs=Decimal('2000'),
    depreciation=Decimal('5000'),
)
print(f'Total rental expenses: {exp.total}')
"
```

**Done:** RentalExpenses with Schedule E categories

---

### Task 2: Create RentalProperty Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create RentalProperty for a single rental unit:

```python
@dataclass
class RentalProperty:
    """Single rental property data for Schedule E Part I."""
    
    # Property identification
    property_address: str
    property_type: str  # Single Family, Multi-Family, Vacation, etc.
    
    # Rental days (for determining personal use)
    fair_rental_days: int
    personal_use_days: int = 0
    
    # Income
    rental_income: Decimal = Decimal("0")   # Line 3
    
    # Expenses
    expenses: RentalExpenses = field(default_factory=RentalExpenses)
    
    # QBI election
    qbi_eligible: bool = True  # Rental can qualify for QBI under safe harbor
    
    @property
    def is_personal_use_property(self) -> bool:
        """Check if property fails rental test due to personal use."""
        # Personal use >14 days OR >10% of rental days
        if self.fair_rental_days == 0:
            return True
        max_personal = max(14, self.fair_rental_days * Decimal("0.10"))
        return self.personal_use_days > max_personal
    
    @property
    def net_income_loss(self) -> Decimal:
        """Net rental income or loss before limitations."""
        return self.rental_income - self.expenses.total
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import RentalProperty, RentalExpenses
prop = RentalProperty(
    property_address='123 Main St, Austin TX',
    property_type='Single Family',
    fair_rental_days=365,
    rental_income=Decimal('24000'),
    expenses=RentalExpenses(
        mortgage_interest=Decimal('8000'),
        taxes=Decimal('3000'),
        depreciation=Decimal('5000'),
    ),
)
print(f'Net rental: {prop.net_income_loss}')
print(f'Personal use: {prop.is_personal_use_property}')
"
```

**Done:** RentalProperty dataclass with income/expense tracking

---

### Task 3: Create ScheduleEData Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create ScheduleEData for all Schedule E Part I properties:

```python
@dataclass
class ScheduleEData:
    """Schedule E Part I - Rental Real Estate data."""
    
    properties: list[RentalProperty] = field(default_factory=list)
    
    # Active participation (for $25k loss allowance)
    actively_participates: bool = True
    is_real_estate_professional: bool = False
    
    # Prior year suspended losses
    prior_year_suspended_loss: Decimal = Decimal("0")
    
    @property
    def total_rental_income(self) -> Decimal:
        """Sum of all rental income."""
        return sum(p.rental_income for p in self.properties)
    
    @property
    def total_expenses(self) -> Decimal:
        """Sum of all expenses."""
        return sum(p.expenses.total for p in self.properties)
    
    @property
    def net_before_limitations(self) -> Decimal:
        """Net rental income/loss before passive limitations."""
        return sum(p.net_income_loss for p in self.properties)
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import (
    ScheduleEData, RentalProperty, RentalExpenses
)
sch_e = ScheduleEData(
    properties=[
        RentalProperty(
            property_address='123 Main St',
            property_type='Single Family',
            fair_rental_days=365,
            rental_income=Decimal('24000'),
            expenses=RentalExpenses(taxes=Decimal('3000')),
        ),
        RentalProperty(
            property_address='456 Oak Ave',
            property_type='Condo',
            fair_rental_days=365,
            rental_income=Decimal('18000'),
            expenses=RentalExpenses(taxes=Decimal('2000')),
        ),
    ],
)
print(f'Total income: {sch_e.total_rental_income}')
print(f'Net: {sch_e.net_before_limitations}')
"
```

**Done:** ScheduleEData aggregates multiple properties

---

### Task 4: Create ScheduleEResult Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create ScheduleEResult for calculation output:

```python
@dataclass
class ScheduleEResult:
    """Result of Schedule E calculation."""
    
    # Gross figures
    total_rental_income: Decimal
    total_expenses: Decimal
    net_before_limitations: Decimal
    
    # Passive activity limitations
    loss_limited: bool
    allowed_loss: Decimal
    suspended_loss: Decimal
    
    # Final figures
    net_rental_income_loss: Decimal   # Amount to include in AGI
    qbi_rental_income: Decimal        # Qualified business income from rentals
    
    # Per-property breakdown
    property_results: list[dict]
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import ScheduleEResult
result = ScheduleEResult(
    total_rental_income=Decimal('24000'),
    total_expenses=Decimal('30000'),
    net_before_limitations=Decimal('-6000'),
    loss_limited=False,
    allowed_loss=Decimal('6000'),
    suspended_loss=Decimal('0'),
    net_rental_income_loss=Decimal('-6000'),
    qbi_rental_income=Decimal('0'),
    property_results=[],
)
print(f'Net rental: {result.net_rental_income_loss}')
"
```

**Done:** ScheduleEResult with limitation tracking

---

### Task 5: Implement calculate_schedule_e()

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create calculate_schedule_e() with passive loss rules:

```python
def calculate_schedule_e(
    data: ScheduleEData,
    modified_agi: Decimal,
    filing_status: FilingStatus,
) -> ScheduleEResult:
    """
    Calculate Schedule E rental income with passive loss limitations.
    
    Passive Activity Loss Rules (simplified):
    - Rental activities are generally passive
    - $25,000 loss allowance for active participation
    - Allowance phases out from $100k-$150k MAGI
    - Real estate professionals: Not subject to limitations
    
    Args:
        data: ScheduleEData with all rental properties
        modified_agi: MAGI for phaseout calculation
        filing_status: For determining phaseout
        
    Returns:
        ScheduleEResult with final figures and limitations
    """
    # Calculate per-property results
    property_results = []
    for prop in data.properties:
        property_results.append({
            "address": prop.property_address,
            "income": prop.rental_income,
            "expenses": prop.expenses.total,
            "net": prop.net_income_loss,
            "qbi_eligible": prop.qbi_eligible and not prop.is_personal_use_property,
        })
    
    net_before = data.net_before_limitations
    
    # Calculate QBI-eligible rental income (sum only eligible properties)
    # NOTE: Only sum net income from properties that are QBI-eligible AND not personal-use
    qbi_eligible_income = sum(
        p["net"] for p in property_results 
        if p["qbi_eligible"] and p["net"] > Decimal("0")
    )
    
    # If net income (not loss), no limitations apply
    if net_before >= Decimal("0"):
        return ScheduleEResult(
            total_rental_income=data.total_rental_income,
            total_expenses=data.total_expenses,
            net_before_limitations=net_before,
            loss_limited=False,
            allowed_loss=Decimal("0"),
            suspended_loss=Decimal("0"),
            net_rental_income_loss=net_before,
            qbi_rental_income=qbi_eligible_income,  # Only eligible property income
            property_results=property_results,
        )
    
    # Handle rental loss
    rental_loss = abs(net_before)
    
    # Real estate professional: No limitation
    if data.is_real_estate_professional:
        allowed_loss = rental_loss
        suspended_loss = Decimal("0")
    # Active participation: $25k allowance with phaseout
    elif data.actively_participates:
        # Phaseout: $100k-$150k MAGI
        PHASEOUT_START = Decimal("100000")
        PHASEOUT_END = Decimal("150000")
        MAX_ALLOWANCE = Decimal("25000")
        
        if modified_agi <= PHASEOUT_START:
            allowance = MAX_ALLOWANCE
        elif modified_agi >= PHASEOUT_END:
            allowance = Decimal("0")
        else:
            # Reduce by $1 for every $2 over $100k
            reduction = (modified_agi - PHASEOUT_START) * Decimal("0.5")
            allowance = max(Decimal("0"), MAX_ALLOWANCE - reduction)
        
        allowed_loss = min(rental_loss, allowance)
        suspended_loss = rental_loss - allowed_loss
    else:
        # No active participation: No current year loss allowed
        allowed_loss = Decimal("0")
        suspended_loss = rental_loss
    
    return ScheduleEResult(
        total_rental_income=data.total_rental_income,
        total_expenses=data.total_expenses,
        net_before_limitations=net_before,
        loss_limited=suspended_loss > Decimal("0"),
        allowed_loss=allowed_loss,
        suspended_loss=suspended_loss,
        net_rental_income_loss=-allowed_loss,  # Negative = loss
        qbi_rental_income=Decimal("0"),  # No QBI for loss
        property_results=property_results,
    )
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import (
    calculate_schedule_e, ScheduleEData, RentalProperty,
    RentalExpenses, FilingStatus
)
sch_e = ScheduleEData(
    properties=[
        RentalProperty(
            property_address='123 Main St',
            property_type='Single Family',
            fair_rental_days=365,
            rental_income=Decimal('24000'),
            expenses=RentalExpenses(
                mortgage_interest=Decimal('12000'),
                taxes=Decimal('5000'),
                depreciation=Decimal('8000'),
                repairs=Decimal('9000'),
            ),
        ),
    ],
    actively_participates=True,
)
result = calculate_schedule_e(sch_e, Decimal('90000'), FilingStatus.SINGLE)
print(f'Net before: {result.net_before_limitations}')
print(f'Allowed loss: {result.allowed_loss}')
print(f'Suspended: {result.suspended_loss}')
print(f'Net included: {result.net_rental_income_loss}')
"
```

**Done:** calculate_schedule_e() with passive loss rules

---

### Task 6: Extend IncomeSummary with Rental Fields

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Add rental income fields to IncomeSummary:

```python
@dataclass
class IncomeSummary:
    """Summary of all income sources."""
    
    # ... existing fields ...
    
    # Rental income (Schedule E)
    schedule_e_rental_income: Decimal = Decimal("0")   # Total rental income
    schedule_e_expenses: Decimal = Decimal("0")        # Total expenses
    schedule_e_net: Decimal = Decimal("0")             # Net after limitations
    schedule_e_suspended_loss: Decimal = Decimal("0")  # Carryforward
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import IncomeSummary
summary = IncomeSummary(
    wages=Decimal('80000'),
    schedule_e_rental_income=Decimal('24000'),
    schedule_e_expenses=Decimal('30000'),
    schedule_e_net=Decimal('-6000'),
)
print(f'Rental net: {summary.schedule_e_net}')
"
```

**Done:** IncomeSummary includes rental fields

---

### Task 7: Update aggregate_income() for Schedule E

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Add Schedule E data to aggregate_income():

```python
def aggregate_income(
    # ... existing params ...
    schedule_e_data: ScheduleEData | None = None,
    modified_agi_for_pal: Decimal | None = None,  # For passive loss calculation
) -> IncomeSummary:
    """
    Aggregate income from all sources.
    
    Args:
        ... existing args ...
        schedule_e_data: Schedule E rental property data
        modified_agi_for_pal: MAGI for passive activity loss calculation
    """
    # ... existing aggregation ...
    
    # Schedule E
    schedule_e_net = Decimal("0")
    schedule_e_suspended = Decimal("0")
    if schedule_e_data:
        magi = modified_agi_for_pal or Decimal("100000")  # Default if not provided
        sch_e_result = calculate_schedule_e(schedule_e_data, magi, filing_status)
        schedule_e_net = sch_e_result.net_rental_income_loss
        schedule_e_suspended = sch_e_result.suspended_loss
    
    return IncomeSummary(
        # ... existing fields ...
        schedule_e_rental_income=schedule_e_data.total_rental_income if schedule_e_data else Decimal("0"),
        schedule_e_expenses=schedule_e_data.total_expenses if schedule_e_data else Decimal("0"),
        schedule_e_net=schedule_e_net,
        schedule_e_suspended_loss=schedule_e_suspended,
    )
```

**Done:** aggregate_income() handles Schedule E

---

### Task 8: Create Schedule E Tests

**Files:** tests/agents/personal_tax/test_calculator.py

**Action:**
Add comprehensive tests for Schedule E:

```python
class TestScheduleE:
    """Tests for Schedule E rental calculations."""
    
    def test_rental_income_no_loss(self):
        """Rental with profit has no limitations."""
        sch_e = ScheduleEData(
            properties=[
                RentalProperty(
                    property_address="123 Main",
                    property_type="Single Family",
                    fair_rental_days=365,
                    rental_income=Decimal("30000"),
                    expenses=RentalExpenses(taxes=Decimal("5000")),
                ),
            ],
        )
        result = calculate_schedule_e(sch_e, Decimal("100000"), FilingStatus.SINGLE)
        assert result.net_rental_income_loss == Decimal("25000")
        assert not result.loss_limited
    
    def test_rental_loss_active_participation(self):
        """Active participant gets $25k loss allowance."""
        sch_e = ScheduleEData(
            properties=[
                RentalProperty(
                    property_address="123 Main",
                    property_type="Single Family",
                    fair_rental_days=365,
                    rental_income=Decimal("12000"),
                    expenses=RentalExpenses(
                        mortgage_interest=Decimal("10000"),
                        depreciation=Decimal("8000"),
                        taxes=Decimal("4000"),
                    ),
                ),
            ],
            actively_participates=True,
        )
        result = calculate_schedule_e(sch_e, Decimal("80000"), FilingStatus.SINGLE)
        # Loss = $10,000, under $25k limit
        assert result.allowed_loss == Decimal("10000")
        assert result.suspended_loss == Decimal("0")
    
    def test_rental_loss_phaseout(self):
        """$25k allowance phases out at high income."""
        sch_e = ScheduleEData(
            properties=[
                RentalProperty(
                    property_address="123 Main",
                    property_type="Single Family",
                    fair_rental_days=365,
                    rental_income=Decimal("12000"),
                    expenses=RentalExpenses(depreciation=Decimal("30000")),
                ),
            ],
            actively_participates=True,
        )
        # At $120k MAGI: allowance reduced by ($120k-$100k)*0.5 = $10k
        # Allowance = $25k - $10k = $15k
        result = calculate_schedule_e(sch_e, Decimal("120000"), FilingStatus.SINGLE)
        assert result.allowed_loss == Decimal("15000")
        assert result.suspended_loss == Decimal("3000")
    
    def test_rental_loss_no_active_participation(self):
        """No active participation = no current loss."""
        sch_e = ScheduleEData(
            properties=[
                RentalProperty(
                    property_address="123 Main",
                    property_type="Single Family",
                    fair_rental_days=365,
                    rental_income=Decimal("12000"),
                    expenses=RentalExpenses(depreciation=Decimal("20000")),
                ),
            ],
            actively_participates=False,
        )
        result = calculate_schedule_e(sch_e, Decimal("80000"), FilingStatus.SINGLE)
        assert result.allowed_loss == Decimal("0")
        assert result.suspended_loss == Decimal("8000")
    
    def test_real_estate_professional(self):
        """Real estate professional has no passive limitations."""
        sch_e = ScheduleEData(
            properties=[
                RentalProperty(
                    property_address="123 Main",
                    property_type="Single Family",
                    fair_rental_days=365,
                    rental_income=Decimal("50000"),
                    expenses=RentalExpenses(depreciation=Decimal("100000")),
                ),
            ],
            is_real_estate_professional=True,
        )
        result = calculate_schedule_e(sch_e, Decimal("200000"), FilingStatus.SINGLE)
        assert result.allowed_loss == Decimal("50000")
        assert result.suspended_loss == Decimal("0")
```

**Verify:**
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v -k "ScheduleE" --tb=short
```
All tests pass.

**Done:** 10+ tests for Schedule E pass

---

## Success Criteria

- [ ] RentalExpenses with all Schedule E expense categories
- [ ] RentalProperty with income/expense tracking
- [ ] ScheduleEData aggregates multiple properties
- [ ] ScheduleEResult with limitation tracking
- [ ] calculate_schedule_e() with passive loss rules
- [ ] $25k allowance with phaseout implemented
- [ ] Real estate professional exception works
- [ ] IncomeSummary extended with rental fields
- [ ] All Schedule E tests pass
- [ ] All Phase 3 tests still pass

## Commit

After all tasks complete:
```bash
git add -A
git commit -m "feat(04-04): add Schedule E rental income calculator"
```
