# Plan 04-05: Schedule D Calculator (Capital Gains)

---
phase: 04-personal-tax-complex
plan: 05
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
---

## Objective

Implement Schedule D calculations for capital gains and losses with proper tax rates.

**Purpose:** Enable calculation of net capital gains/losses from Form 1099-B and apply correct preferential tax rates.

**Output:**
- CapitalTransaction dataclass
- ScheduleDData dataclass
- calculate_schedule_d() function
- Capital gains tax rate calculations
- Capital loss limitation handling

## Tasks

### Task 1: Create CapitalTransaction Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create CapitalTransaction for a single transaction:

```python
@dataclass
class CapitalTransaction:
    """Single capital gain/loss transaction."""
    
    description: str
    date_acquired: str | None  # May be "Various"
    date_sold: str
    proceeds: Decimal
    cost_basis: Decimal | None  # May be None if not reported to IRS
    
    # Classification
    is_short_term: bool = False  # Held â‰¤1 year
    is_long_term: bool = False   # Held >1 year
    basis_reported_to_irs: bool = True  # Box 12 from 1099-B
    
    # Adjustments
    wash_sale_disallowed: Decimal = Decimal("0")
    
    # Special types
    is_collectibles: bool = False  # 28% max rate
    is_section_1202: bool = False  # QSBS exclusion
    is_section_1250: bool = False  # Unrecaptured depreciation
    
    @property
    def requires_basis_escalation(self) -> bool:
        """Transaction requires escalation due to missing basis."""
        return self.cost_basis is None
    
    @property
    def gain_loss(self) -> Decimal | None:
        """Calculate gain or loss. Returns None if basis unknown."""
        if self.cost_basis is None:
            return None  # Cannot calculate - needs escalation
        return self.proceeds - self.cost_basis + self.wash_sale_disallowed
    
    @property
    def adjusted_gain_loss(self) -> Decimal | None:
        """Gain/loss after wash sale adjustment."""
        return self.gain_loss
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import CapitalTransaction
txn = CapitalTransaction(
    description='AAPL 100 shares',
    date_acquired='2023-01-15',
    date_sold='2024-06-20',
    proceeds=Decimal('19500'),
    cost_basis=Decimal('15000'),
    is_long_term=True,
)
print(f'Gain: {txn.gain_loss}')
"
```

**Done:** CapitalTransaction with gain/loss calculation

---

### Task 2: Create ScheduleDData Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create ScheduleDData for all transactions:

```python
@dataclass
class ScheduleDData:
    """Schedule D - Capital Gains and Losses."""
    
    transactions: list[CapitalTransaction] = field(default_factory=list)
    
    # Prior year carryover
    prior_year_loss_carryover: Decimal = Decimal("0")
    
    @property
    def short_term_transactions(self) -> list[CapitalTransaction]:
        """Filter short-term transactions."""
        return [t for t in self.transactions if t.is_short_term]
    
    @property
    def long_term_transactions(self) -> list[CapitalTransaction]:
        """Filter long-term transactions."""
        return [t for t in self.transactions if t.is_long_term]
    
    @property
    def net_short_term(self) -> Decimal:
        """Net short-term capital gain/loss (excluding transactions with missing basis)."""
        # Skip transactions where adjusted_gain_loss is None (missing basis)
        return sum(
            t.adjusted_gain_loss for t in self.short_term_transactions
            if t.adjusted_gain_loss is not None
        )
    
    @property
    def net_long_term(self) -> Decimal:
        """Net long-term capital gain/loss (excluding transactions with missing basis)."""
        # Skip transactions where adjusted_gain_loss is None (missing basis)
        return sum(
            t.adjusted_gain_loss for t in self.long_term_transactions
            if t.adjusted_gain_loss is not None
        )
    
    @property
    def transactions_with_missing_basis(self) -> list[CapitalTransaction]:
        """Transactions that require basis escalation."""
        return [t for t in self.transactions if t.requires_basis_escalation]
    
    @property
    def collectibles_gain(self) -> Decimal:
        """Total collectibles gain (28% rate)."""
        return sum(
            t.adjusted_gain_loss for t in self.long_term_transactions 
            if t.is_collectibles 
            and t.adjusted_gain_loss is not None  # Skip missing basis
            and t.adjusted_gain_loss > 0
        )
    
    @property
    def net_capital_gain_loss(self) -> Decimal:
        """Combined net capital gain/loss before carryover."""
        return self.net_short_term + self.net_long_term
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import ScheduleDData, CapitalTransaction
sch_d = ScheduleDData(
    transactions=[
        CapitalTransaction(
            description='AAPL',
            date_sold='2024-06-20',
            proceeds=Decimal('10000'),
            cost_basis=Decimal('8000'),
            is_long_term=True,
        ),
        CapitalTransaction(
            description='TSLA',
            date_sold='2024-09-15',
            proceeds=Decimal('5000'),
            cost_basis=Decimal('7000'),
            is_short_term=True,
        ),
    ],
)
print(f'Net ST: {sch_d.net_short_term}')
print(f'Net LT: {sch_d.net_long_term}')
print(f'Total: {sch_d.net_capital_gain_loss}')
"
```

**Done:** ScheduleDData aggregates and classifies transactions

---

### Task 3: Create ScheduleDResult Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create ScheduleDResult for calculation output:

```python
@dataclass
class ScheduleDResult:
    """Result of Schedule D calculation."""
    
    # Part I: Short-term (AFTER carryover applied for consistency)
    net_short_term_gain_loss: Decimal  # Post-carryover value
    
    # Part II: Long-term (AFTER carryover applied for consistency)
    net_long_term_gain_loss: Decimal   # Post-carryover value
    collectibles_gain: Decimal
    unrecaptured_1250_gain: Decimal
    
    # Pre-carryover values for audit trail
    gross_short_term: Decimal          # Before carryover
    gross_long_term: Decimal           # Before carryover
    
    # Part III: Summary
    net_capital_gain_loss: Decimal     # Combined after carryover
    capital_loss_carryover_used: Decimal
    capital_loss_limitation_applied: bool
    
    # Final figures
    allowed_capital_loss: Decimal       # Max $3k ($1.5k MFS)
    net_included_in_income: Decimal     # Amount for AGI
    new_loss_carryforward: Decimal      # For next year
    
    # For tax calculation
    qualified_dividends_and_ltcg: Decimal  # For preferential rates
    
    # Escalation tracking
    transactions_missing_basis: int = 0  # Count of transactions needing escalation
```

**Done:** ScheduleDResult with limitation tracking

---

### Task 4: Create Capital Gains Tax Rate Function

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create function to determine capital gains tax rate:

```python
def get_capital_gains_rate(
    taxable_income: Decimal,
    filing_status: FilingStatus,
    tax_year: int = 2024,
) -> Decimal:
    """
    Determine the applicable long-term capital gains tax rate.
    
    2024 Rates:
    - 0%: Low income
    - 15%: Middle income
    - 20%: High income
    
    Returns rate as decimal (e.g., 0.15 for 15%)
    """
    # 2024 thresholds
    THRESHOLDS = {
        FilingStatus.SINGLE: (Decimal("47025"), Decimal("518900")),
        FilingStatus.MARRIED_FILING_JOINTLY: (Decimal("94050"), Decimal("583750")),
        FilingStatus.MARRIED_FILING_SEPARATELY: (Decimal("47025"), Decimal("291850")),
        FilingStatus.HEAD_OF_HOUSEHOLD: (Decimal("63000"), Decimal("551350")),
        FilingStatus.QUALIFYING_WIDOW: (Decimal("94050"), Decimal("583750")),
    }
    
    low_threshold, high_threshold = THRESHOLDS.get(
        filing_status, 
        (Decimal("47025"), Decimal("518900"))
    )
    
    if taxable_income <= low_threshold:
        return Decimal("0")
    elif taxable_income <= high_threshold:
        return Decimal("0.15")
    else:
        return Decimal("0.20")
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import get_capital_gains_rate, FilingStatus
# Single filer at $40k
rate = get_capital_gains_rate(Decimal('40000'), FilingStatus.SINGLE)
print(f'Rate at \$40k: {rate * 100}%')
# Single filer at $100k
rate = get_capital_gains_rate(Decimal('100000'), FilingStatus.SINGLE)
print(f'Rate at \$100k: {rate * 100}%')
# Single filer at $600k
rate = get_capital_gains_rate(Decimal('600000'), FilingStatus.SINGLE)
print(f'Rate at \$600k: {rate * 100}%')
"
```

**Done:** get_capital_gains_rate() returns correct rates

---

### Task 5: Implement calculate_schedule_d()

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create calculate_schedule_d() with loss limitations:

```python
def calculate_schedule_d(
    data: ScheduleDData,
    filing_status: FilingStatus,
) -> ScheduleDResult:
    """
    Calculate Schedule D capital gains/losses with limitations.
    
    Capital Loss Rules:
    - Net capital loss limited to $3,000/year ($1,500 MFS)
    - Excess loss carries forward to future years
    - Short-term losses offset short-term gains first
    - Long-term losses offset long-term gains first
    - Then net against each other
    
    Args:
        data: ScheduleDData with all transactions
        filing_status: For loss limitation amount
        
    Returns:
        ScheduleDResult with final figures
    """
    # Calculate net short-term and long-term
    net_st = data.net_short_term
    net_lt = data.net_long_term
    
    # Special long-term categories
    collectibles_gain = data.collectibles_gain
    unrecaptured_1250 = Decimal("0")  # Would need depreciation data
    
    # Apply prior year carryover to short-term first
    carryover_used = Decimal("0")
    remaining_carryover = data.prior_year_loss_carryover
    
    if remaining_carryover > 0 and net_st > 0:
        st_offset = min(net_st, remaining_carryover)
        net_st -= st_offset
        remaining_carryover -= st_offset
        carryover_used += st_offset
    
    if remaining_carryover > 0 and net_lt > 0:
        lt_offset = min(net_lt, remaining_carryover)
        net_lt -= lt_offset
        remaining_carryover -= lt_offset
        carryover_used += lt_offset
    
    # Combined net gain/loss
    net_combined = net_st + net_lt
    
    # Apply loss limitation
    LOSS_LIMIT = Decimal("3000") if filing_status != FilingStatus.MARRIED_FILING_SEPARATELY else Decimal("1500")
    
    if net_combined < Decimal("0"):
        # Net loss - apply limitation
        total_loss = abs(net_combined)
        allowed_loss = min(total_loss, LOSS_LIMIT)
        new_carryforward = total_loss - allowed_loss
        net_included = -allowed_loss
        loss_limited = total_loss > LOSS_LIMIT
    else:
        # Net gain - no limitation
        allowed_loss = Decimal("0")
        new_carryforward = Decimal("0")
        net_included = net_combined
        loss_limited = False
    
    # Qualified dividends and LTCG for preferential rates
    qualified_ltcg = max(Decimal("0"), net_lt)
    
    # Count transactions missing basis for escalation
    missing_basis_count = sum(
        1 for t in data.transactions if t.requires_basis_escalation
    )
    
    return ScheduleDResult(
        net_short_term_gain_loss=net_st,           # Post-carryover
        net_long_term_gain_loss=net_lt,            # Post-carryover
        collectibles_gain=collectibles_gain,
        unrecaptured_1250_gain=unrecaptured_1250,
        gross_short_term=data.net_short_term,      # Pre-carryover
        gross_long_term=data.net_long_term,        # Pre-carryover
        net_capital_gain_loss=net_combined,
        capital_loss_carryover_used=carryover_used,
        capital_loss_limitation_applied=loss_limited,
        allowed_capital_loss=allowed_loss,
        net_included_in_income=net_included,
        new_loss_carryforward=new_carryforward,
        qualified_dividends_and_ltcg=qualified_ltcg,
        transactions_missing_basis=missing_basis_count,
    )
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import (
    calculate_schedule_d, ScheduleDData, CapitalTransaction, FilingStatus
)
# Test with net loss
sch_d = ScheduleDData(
    transactions=[
        CapitalTransaction(
            description='Stock A',
            date_sold='2024-06-20',
            proceeds=Decimal('5000'),
            cost_basis=Decimal('10000'),
            is_short_term=True,
        ),
        CapitalTransaction(
            description='Stock B',
            date_sold='2024-06-20',
            proceeds=Decimal('8000'),
            cost_basis=Decimal('6000'),
            is_long_term=True,
        ),
    ],
)
result = calculate_schedule_d(sch_d, FilingStatus.SINGLE)
print(f'Net ST: {result.net_short_term_gain_loss}')
print(f'Net LT: {result.net_long_term_gain_loss}')
print(f'Net combined: {result.net_capital_gain_loss}')
print(f'Allowed loss: {result.allowed_capital_loss}')
print(f'Carryforward: {result.new_loss_carryforward}')
"
```

**Done:** calculate_schedule_d() with loss limitations

---

### Task 6: Create Form1099B to Transaction Converter

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create helper to convert Form1099B to CapitalTransaction:

```python
def convert_1099b_to_transactions(
    forms_1099b: list[Form1099B],
) -> tuple[list[CapitalTransaction], list[Form1099B]]:
    """
    Convert Form 1099-B data to CapitalTransaction list.
    
    IMPORTANT: Transactions with missing cost basis are flagged for escalation,
    NOT converted with cost_basis=0 (which would incorrectly inflate gains).
    
    Args:
        forms_1099b: List of Form1099B from extraction
        
    Returns:
        Tuple of:
        - List of CapitalTransaction for Schedule D
        - List of Form1099B with missing basis (for escalation)
    """
    transactions = []
    missing_basis = []
    
    for form in forms_1099b:
        txn = CapitalTransaction(
            description=form.description,
            date_acquired=form.date_acquired,
            date_sold=form.date_sold,
            proceeds=form.proceeds,
            cost_basis=form.cost_basis,  # Keep None if not reported
            is_short_term=form.is_short_term,
            is_long_term=form.is_long_term,
            basis_reported_to_irs=form.basis_reported_to_irs,
            wash_sale_disallowed=form.wash_sale_loss_disallowed,
            is_collectibles=form.is_collectibles,
        )
        transactions.append(txn)
        
        # Track transactions needing escalation
        if form.cost_basis is None and not form.basis_reported_to_irs:
            missing_basis.append(form)
    
    return transactions, missing_basis
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.documents.models import Form1099B
from src.agents.personal_tax.calculator import convert_1099b_to_transactions
forms = [
    Form1099B(
        payer_name='Broker',
        payer_tin='12-3456789',
        recipient_tin='123-45-6789',
        description='AAPL 100 shares',
        date_sold='2024-06-20',
        proceeds=Decimal('10000'),
        cost_basis=Decimal('8000'),
        is_long_term=True,
    ),
    Form1099B(
        payer_name='Broker',
        payer_tin='12-3456789',
        recipient_tin='123-45-6789',
        description='XYZ Corp',
        date_sold='2024-08-15',
        proceeds=Decimal('5000'),
        cost_basis=None,  # Missing basis
        basis_reported_to_irs=False,
        is_short_term=True,
    ),
]
txns, missing_basis = convert_1099b_to_transactions(forms)
print(f'Converted {len(txns)} transactions')
print(f'Missing basis: {len(missing_basis)} (should be 1)')
print(f'First: {txns[0].description}, gain={txns[0].gain_loss}')
print(f'Second requires escalation: {txns[1].requires_basis_escalation}')
"
```

**Done:** Converter from 1099-B to transactions (returns tuple)

---

### Task 7: Extend IncomeSummary with Capital Gains

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Add capital gains fields to IncomeSummary:

```python
@dataclass
class IncomeSummary:
    """Summary of all income sources."""
    
    # ... existing fields ...
    
    # Capital gains (Schedule D)
    capital_gains_short_term: Decimal = Decimal("0")
    capital_gains_long_term: Decimal = Decimal("0")
    capital_gains_net: Decimal = Decimal("0")        # Net included in AGI
    capital_loss_carryforward: Decimal = Decimal("0")  # For next year
```

**Done:** IncomeSummary includes capital gains fields

---

### Task 8: Create Schedule D Tests

**Files:** tests/agents/personal_tax/test_calculator.py

**Action:**
Add comprehensive tests for Schedule D:

```python
class TestScheduleD:
    """Tests for Schedule D capital gains calculations."""
    
    def test_net_capital_gain(self):
        """Schedule D calculates net capital gain."""
        sch_d = ScheduleDData(
            transactions=[
                CapitalTransaction(
                    description="Stock A",
                    date_sold="2024-06-20",
                    proceeds=Decimal("10000"),
                    cost_basis=Decimal("8000"),
                    is_long_term=True,
                ),
            ],
        )
        result = calculate_schedule_d(sch_d, FilingStatus.SINGLE)
        assert result.net_included_in_income == Decimal("2000")
        assert not result.capital_loss_limitation_applied
    
    def test_capital_loss_limitation(self):
        """Capital loss limited to $3,000."""
        sch_d = ScheduleDData(
            transactions=[
                CapitalTransaction(
                    description="Stock A",
                    date_sold="2024-06-20",
                    proceeds=Decimal("1000"),
                    cost_basis=Decimal("10000"),
                    is_short_term=True,
                ),
            ],
        )
        result = calculate_schedule_d(sch_d, FilingStatus.SINGLE)
        assert result.allowed_capital_loss == Decimal("3000")
        assert result.new_loss_carryforward == Decimal("6000")
        assert result.capital_loss_limitation_applied
    
    def test_capital_loss_mfs_limit(self):
        """MFS capital loss limited to $1,500."""
        sch_d = ScheduleDData(
            transactions=[
                CapitalTransaction(
                    description="Stock A",
                    date_sold="2024-06-20",
                    proceeds=Decimal("1000"),
                    cost_basis=Decimal("6000"),
                    is_short_term=True,
                ),
            ],
        )
        result = calculate_schedule_d(sch_d, FilingStatus.MARRIED_FILING_SEPARATELY)
        assert result.allowed_capital_loss == Decimal("1500")
        assert result.new_loss_carryforward == Decimal("3500")
    
    def test_short_long_term_netting(self):
        """Short and long term net against each other."""
        sch_d = ScheduleDData(
            transactions=[
                CapitalTransaction(
                    description="Stock A",
                    date_sold="2024-06-20",
                    proceeds=Decimal("5000"),
                    cost_basis=Decimal("8000"),
                    is_short_term=True,
                ),
                CapitalTransaction(
                    description="Stock B",
                    date_sold="2024-06-20",
                    proceeds=Decimal("10000"),
                    cost_basis=Decimal("6000"),
                    is_long_term=True,
                ),
            ],
        )
        result = calculate_schedule_d(sch_d, FilingStatus.SINGLE)
        # ST: -3000, LT: +4000, Net: +1000
        assert result.net_short_term_gain_loss == Decimal("-3000")
        assert result.net_long_term_gain_loss == Decimal("4000")
        assert result.net_included_in_income == Decimal("1000")
    
    def test_prior_year_carryover(self):
        """Prior year carryover offsets current gains."""
        sch_d = ScheduleDData(
            transactions=[
                CapitalTransaction(
                    description="Stock A",
                    date_sold="2024-06-20",
                    proceeds=Decimal("10000"),
                    cost_basis=Decimal("8000"),
                    is_short_term=True,
                ),
            ],
            prior_year_loss_carryover=Decimal("1500"),
        )
        result = calculate_schedule_d(sch_d, FilingStatus.SINGLE)
        assert result.capital_loss_carryover_used == Decimal("1500")
        assert result.net_included_in_income == Decimal("500")


class TestCapitalGainsRates:
    """Tests for capital gains tax rates."""
    
    def test_zero_percent_rate(self):
        """0% rate for low income."""
        rate = get_capital_gains_rate(Decimal("40000"), FilingStatus.SINGLE)
        assert rate == Decimal("0")
    
    def test_fifteen_percent_rate(self):
        """15% rate for middle income."""
        rate = get_capital_gains_rate(Decimal("100000"), FilingStatus.SINGLE)
        assert rate == Decimal("0.15")
    
    def test_twenty_percent_rate(self):
        """20% rate for high income."""
        rate = get_capital_gains_rate(Decimal("600000"), FilingStatus.SINGLE)
        assert rate == Decimal("0.20")
    
    def test_mfj_thresholds(self):
        """MFJ has higher thresholds."""
        rate = get_capital_gains_rate(Decimal("90000"), FilingStatus.MARRIED_FILING_JOINTLY)
        assert rate == Decimal("0")  # Under $94,050
```

**Verify:**
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v -k "ScheduleD or CapitalGains" --tb=short
```
All tests pass.

**Done:** 15+ tests for Schedule D pass

---

## Success Criteria

- [ ] CapitalTransaction with gain/loss calculation (None if basis missing)
- [ ] ScheduleDData aggregates and classifies transactions
- [ ] ScheduleDResult with limitation tracking and post-carryover values
- [ ] get_capital_gains_rate() returns correct 2024 rates
- [ ] calculate_schedule_d() with $3k loss limit
- [ ] MFS $1.5k limit works correctly
- [ ] Prior year carryover applied correctly to both ST and LT
- [ ] 1099-B converter returns missing basis list for escalation
- [ ] Transactions with basis_reported_to_irs=False AND cost_basis=None escalate
- [ ] Test: 1099-B with missing basis flags escalation (not zero gain)
- [ ] Test: Schedule D carryover affects both ST and LT totals in result
- [ ] IncomeSummary extended with capital gains
- [ ] All Schedule D tests pass
- [ ] All Phase 3 tests still pass

## Commit

After all tasks complete:
```bash
git add -A
git commit -m "feat(04-05): add Schedule D capital gains calculator"
```
