# Plan 04-06: QBI Deduction (Section 199A)

---
phase: 04-personal-tax-complex
plan: 06
type: execute
wave: 4
depends_on: ["04-03", "04-04"]
---

## Objective

Implement the Qualified Business Income (QBI) deduction under Section 199A.

**Purpose:** Calculate the 20% QBI deduction for pass-through income from sole proprietorships, partnerships, and S-corps.

**Output:**
- QBIComponent dataclass
- QBIDeduction dataclass
- calculate_qbi_deduction() function
- Integration with tax calculation flow

## Tasks

### Task 1: Create QBIComponent Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create QBIComponent for each qualified business:

```python
@dataclass
class QBIComponent:
    """QBI component from a single qualified trade or business."""
    
    business_name: str
    
    # Income
    qualified_business_income: Decimal   # Net income from business
    
    # W-2 wages (for limitation)
    w2_wages: Decimal = Decimal("0")
    
    # Qualified property (for limitation)
    unadjusted_basis_qualified_property: Decimal = Decimal("0")
    
    # SSTB status
    is_sstb: bool = False  # Specified Service Trade or Business
    
    # Source
    source: str = "schedule_c"  # schedule_c, k1_partnership, k1_s_corp, rental
    
    @property
    def tentative_qbi_deduction(self) -> Decimal:
        """20% of QBI before limitations."""
        return max(Decimal("0"), self.qualified_business_income * Decimal("0.20"))
    
    @property
    def w2_wage_limit(self) -> Decimal:
        """50% of W-2 wages limitation."""
        return self.w2_wages * Decimal("0.50")
    
    @property
    def wage_plus_property_limit(self) -> Decimal:
        """25% of W-2 wages + 2.5% of UBIA limitation."""
        return (
            self.w2_wages * Decimal("0.25") +
            self.unadjusted_basis_qualified_property * Decimal("0.025")
        )
    
    @property
    def wage_limit(self) -> Decimal:
        """Greater of the two wage-based limits."""
        return max(self.w2_wage_limit, self.wage_plus_property_limit)
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import QBIComponent
qbi = QBIComponent(
    business_name='Consulting LLC',
    qualified_business_income=Decimal('100000'),
    w2_wages=Decimal('50000'),
)
print(f'Tentative QBI deduction: {qbi.tentative_qbi_deduction}')
print(f'W-2 wage limit: {qbi.wage_limit}')
"
```

**Done:** QBIComponent with deduction calculations

---

### Task 2: Create QBIDeduction Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create QBIDeduction for final result:

```python
@dataclass
class QBIDeduction:
    """Final QBI deduction calculation result."""
    
    # Components
    components: list[QBIComponent]
    
    # Total QBI amounts
    total_qbi: Decimal
    total_tentative_deduction: Decimal
    
    # Threshold info
    filing_status: FilingStatus
    taxable_income: Decimal
    threshold: Decimal
    phaseout_range: Decimal
    is_above_threshold: bool
    is_fully_phased_out: bool
    
    # Limitations applied
    wage_limit_applied: bool
    sstb_exclusion_applied: bool
    taxable_income_limit_applied: bool
    
    # Final deduction
    qbi_deduction_before_limit: Decimal
    taxable_income_limit: Decimal  # 20% of (TI - net capital gains)
    final_qbi_deduction: Decimal
```

**Done:** QBIDeduction result dataclass

---

### Task 3: Create QBI Threshold Constants

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Define 2024 QBI thresholds:

```python
# QBI Section 199A thresholds (2024)
QBI_THRESHOLDS: dict[FilingStatus, tuple[Decimal, Decimal]] = {
    FilingStatus.SINGLE: (Decimal("191950"), Decimal("50000")),
    FilingStatus.MARRIED_FILING_JOINTLY: (Decimal("383900"), Decimal("100000")),
    FilingStatus.MARRIED_FILING_SEPARATELY: (Decimal("191950"), Decimal("50000")),
    FilingStatus.HEAD_OF_HOUSEHOLD: (Decimal("191950"), Decimal("50000")),
    FilingStatus.QUALIFYING_WIDOW: (Decimal("383900"), Decimal("100000")),
}
```

**Done:** QBI thresholds defined

---

### Task 4: Implement calculate_qbi_deduction()

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create calculate_qbi_deduction() with full logic:

```python
def calculate_qbi_deduction(
    components: list[QBIComponent],
    taxable_income: Decimal,
    net_capital_gains: Decimal,
    filing_status: FilingStatus,
) -> QBIDeduction:
    """
    Calculate QBI deduction under Section 199A.
    
    Simplified rules:
    1. Below threshold: 20% of QBI, no W-2 wage limitation
    2. In phaseout range: Phased limitation on SSTB and wage limit
    3. Above phaseout: Full W-2 wage limitation, no SSTB deduction
    
    Final deduction is lesser of:
    - Combined QBI deduction from all businesses
    - 20% of (taxable income - net capital gains)
    
    Args:
        components: List of QBI components from each business
        taxable_income: Taxable income before QBI deduction
        net_capital_gains: Net capital gains (for final limitation)
        filing_status: For threshold determination
        
    Returns:
        QBIDeduction with complete breakdown
    """
    threshold, phaseout = QBI_THRESHOLDS.get(
        filing_status,
        (Decimal("191950"), Decimal("50000")),
    )
    
    phaseout_end = threshold + phaseout
    
    is_above_threshold = taxable_income > threshold
    is_fully_phased_out = taxable_income >= phaseout_end
    
    # Calculate deduction for each component
    total_deduction = Decimal("0")
    wage_limit_applied = False
    sstb_exclusion_applied = False
    
    for comp in components:
        if comp.qualified_business_income <= Decimal("0"):
            continue
            
        tentative = comp.tentative_qbi_deduction
        
        # Handle SSTB
        if comp.is_sstb:
            if is_fully_phased_out:
                # No deduction for SSTB above threshold
                sstb_exclusion_applied = True
                continue
            elif is_above_threshold:
                # Partial SSTB in phaseout
                sstb_exclusion_applied = True
                phaseout_pct = (taxable_income - threshold) / phaseout
                tentative = tentative * (Decimal("1") - phaseout_pct)
        
        # Apply W-2 wage limitation if above threshold
        if is_above_threshold and not is_fully_phased_out:
            # Phased-in limitation
            phaseout_pct = (taxable_income - threshold) / phaseout
            limit = comp.wage_limit
            reduction = (tentative - limit) * phaseout_pct
            if reduction > Decimal("0"):
                tentative = max(tentative - reduction, limit)
                wage_limit_applied = True
        elif is_fully_phased_out:
            # Full limitation
            if tentative > comp.wage_limit:
                tentative = comp.wage_limit
                wage_limit_applied = True
        
        total_deduction += tentative
    
    # Final limitation: 20% of (taxable income - net capital gains)
    taxable_income_limit = (taxable_income - net_capital_gains) * Decimal("0.20")
    taxable_income_limit = max(Decimal("0"), taxable_income_limit)
    
    final_deduction = min(total_deduction, taxable_income_limit)
    taxable_income_limit_applied = total_deduction > taxable_income_limit
    
    return QBIDeduction(
        components=components,
        total_qbi=sum(c.qualified_business_income for c in components),
        total_tentative_deduction=sum(c.tentative_qbi_deduction for c in components),
        filing_status=filing_status,
        taxable_income=taxable_income,
        threshold=threshold,
        phaseout_range=phaseout,
        is_above_threshold=is_above_threshold,
        is_fully_phased_out=is_fully_phased_out,
        wage_limit_applied=wage_limit_applied,
        sstb_exclusion_applied=sstb_exclusion_applied,
        taxable_income_limit_applied=taxable_income_limit_applied,
        qbi_deduction_before_limit=total_deduction.quantize(Decimal("0.01")),
        taxable_income_limit=taxable_income_limit.quantize(Decimal("0.01")),
        final_qbi_deduction=final_deduction.quantize(Decimal("0.01")),
    )
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import (
    calculate_qbi_deduction, QBIComponent, FilingStatus
)
# Simple case: Below threshold
components = [
    QBIComponent(
        business_name='Consulting',
        qualified_business_income=Decimal('100000'),
    ),
]
result = calculate_qbi_deduction(
    components,
    taxable_income=Decimal('150000'),
    net_capital_gains=Decimal('0'),
    filing_status=FilingStatus.SINGLE,
)
print(f'QBI: {result.total_qbi}')
print(f'Deduction: {result.final_qbi_deduction}')
print(f'Above threshold: {result.is_above_threshold}')
"
```

Expected: $100k QBI, $20k deduction (20%), not above threshold

**Done:** calculate_qbi_deduction() with thresholds and limitations

---

### Task 5: Create QBI Helper Functions

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create helpers to build QBI components from income sources:

```python
def build_qbi_from_schedule_c(
    schedule_c: ScheduleCData,
    se_tax_deduction: Decimal,
    is_sstb: bool = False,
) -> QBIComponent:
    """
    Build QBI component from Schedule C data.
    
    QBI = Net profit - 50% SE tax - SE health insurance - retirement contributions
    
    Simplified: QBI = Net profit - 50% SE tax
    """
    qbi = schedule_c.net_profit_or_loss - se_tax_deduction
    
    return QBIComponent(
        business_name=schedule_c.business_name,
        qualified_business_income=max(Decimal("0"), qbi),
        w2_wages=Decimal("0"),  # Sole prop has no W-2 wages
        is_sstb=is_sstb,
        source="schedule_c",
    )


def build_qbi_from_k1(
    k1: FormK1,
    is_sstb: bool = False,
) -> QBIComponent:
    """
    Build QBI component from K-1 data.
    
    IMPORTANT: Guaranteed payments (Box 4) are NOT QBI.
    - Guaranteed payments are treated like wages for partners
    - QBI = Box 1 (ordinary income) EXCLUDING guaranteed payments
    - In reality, QBI statement on K-1 would provide exact amount
    
    For K-1: QBI = Box 1 (ordinary income) only
    W-2 wages and UBIA may be reported on K-1 supplemental
    """
    # Use ordinary income only - guaranteed payments are NOT QBI
    # Note: K-1s often include a QBI statement with exact amounts
    qbi = k1.ordinary_business_income
    
    # Guaranteed payments are subject to SE tax but NOT QBI
    # They are reported separately and handled in aggregate_income()
    
    return QBIComponent(
        business_name=k1.entity_name,
        qualified_business_income=max(Decimal("0"), qbi),
        w2_wages=Decimal("0"),  # Would come from K-1 supplemental
        unadjusted_basis_qualified_property=Decimal("0"),
        is_sstb=is_sstb,
        source="k1_partnership" if k1.entity_type == "partnership" else "k1_s_corp",
    )


def build_qbi_from_rental(
    rental_net_income: Decimal,
    property_name: str,
    qualifies_safe_harbor: bool = True,
) -> QBIComponent | None:
    """
    Build QBI component from rental income (if qualifying).
    
    Rental qualifies for QBI under safe harbor if:
    - 250+ hours of rental services per year
    - Separate books and records
    - Not triple net lease
    """
    if not qualifies_safe_harbor or rental_net_income <= Decimal("0"):
        return None
    
    return QBIComponent(
        business_name=f"Rental: {property_name}",
        qualified_business_income=rental_net_income,
        w2_wages=Decimal("0"),
        is_sstb=False,  # Rentals are never SSTB
        source="rental",
    )
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import (
    build_qbi_from_schedule_c, ScheduleCData, ScheduleCExpenses
)
sch_c = ScheduleCData(
    business_name='Consulting LLC',
    business_activity='Consulting',
    principal_business_code='541611',
    gross_receipts=Decimal('150000'),
    expenses=ScheduleCExpenses(office_expense=Decimal('10000')),
)
qbi_comp = build_qbi_from_schedule_c(sch_c, Decimal('7000'))
print(f'QBI component: {qbi_comp.qualified_business_income}')
print(f'Tentative deduction: {qbi_comp.tentative_qbi_deduction}')
"
```

**Done:** QBI helper functions for each income source

---

### Task 6: Extend TaxSituation with QBI

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Add QBI fields to TaxSituation:

```python
@dataclass
class TaxSituation:
    """Complete tax situation for a taxpayer."""
    
    # ... existing fields ...
    
    # QBI deduction
    qbi_components: list[QBIComponent] = field(default_factory=list)
    qbi_deduction: Decimal = Decimal("0")
    
    @property
    def taxable_income(self) -> Decimal:
        """Taxable income after all deductions."""
        return max(
            Decimal("0"),
            self.agi - self.standard_or_itemized_deduction - self.qbi_deduction
        )
```

**Done:** TaxSituation includes QBI

---

### Task 7: Update calculate_tax_liability()

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Integrate QBI into tax calculation:

```python
def calculate_tax_liability(
    income: IncomeSummary,
    filing_status: FilingStatus,
    # ... existing params ...
    qbi_components: list[QBIComponent] | None = None,
) -> TaxSituation:
    """
    Calculate complete tax liability including QBI deduction.
    """
    # ... existing AGI and deduction calculations ...
    
    # Calculate QBI deduction if components provided
    qbi_deduction = Decimal("0")
    if qbi_components:
        # Preliminary taxable income (before QBI)
        preliminary_ti = agi - standard_or_itemized
        net_cap_gains = income.capital_gains_net
        
        qbi_result = calculate_qbi_deduction(
            qbi_components,
            preliminary_ti,
            net_cap_gains,
            filing_status,
        )
        qbi_deduction = qbi_result.final_qbi_deduction
    
    # Final taxable income
    taxable_income = agi - standard_or_itemized - qbi_deduction
    
    # ... rest of tax calculation ...
    
    return TaxSituation(
        # ... existing fields ...
        qbi_components=qbi_components or [],
        qbi_deduction=qbi_deduction,
    )
```

**Done:** Tax calculation integrates QBI deduction

---

### Task 8: Create QBI Tests

**Files:** tests/agents/personal_tax/test_calculator.py

**Action:**
Add comprehensive tests for QBI:

```python
class TestQBIDeduction:
    """Tests for QBI deduction calculation."""
    
    def test_qbi_below_threshold(self):
        """QBI below threshold gets full 20% deduction."""
        components = [
            QBIComponent(
                business_name="Test Business",
                qualified_business_income=Decimal("100000"),
            ),
        ]
        result = calculate_qbi_deduction(
            components,
            taxable_income=Decimal("150000"),
            net_capital_gains=Decimal("0"),
            filing_status=FilingStatus.SINGLE,
        )
        assert result.final_qbi_deduction == Decimal("20000.00")
        assert not result.is_above_threshold
        assert not result.wage_limit_applied
    
    def test_qbi_above_threshold_with_wages(self):
        """QBI above threshold applies W-2 wage limitation."""
        components = [
            QBIComponent(
                business_name="Test Business",
                qualified_business_income=Decimal("100000"),
                w2_wages=Decimal("30000"),  # Limit = 50% = $15k
            ),
        ]
        result = calculate_qbi_deduction(
            components,
            taxable_income=Decimal("300000"),  # Above $241,950 for single
            net_capital_gains=Decimal("0"),
            filing_status=FilingStatus.SINGLE,
        )
        assert result.is_fully_phased_out
        # Limited to 50% of W-2 wages = $15k
        assert result.final_qbi_deduction == Decimal("15000.00")
        assert result.wage_limit_applied
    
    def test_qbi_sstb_exclusion(self):
        """SSTB excluded above threshold."""
        components = [
            QBIComponent(
                business_name="Law Firm",
                qualified_business_income=Decimal("200000"),
                is_sstb=True,
            ),
        ]
        result = calculate_qbi_deduction(
            components,
            taxable_income=Decimal("300000"),  # Fully phased out
            net_capital_gains=Decimal("0"),
            filing_status=FilingStatus.SINGLE,
        )
        assert result.sstb_exclusion_applied
        assert result.final_qbi_deduction == Decimal("0.00")
    
    def test_qbi_taxable_income_limit(self):
        """QBI limited to 20% of taxable income."""
        components = [
            QBIComponent(
                business_name="Test Business",
                qualified_business_income=Decimal("200000"),
            ),
        ]
        result = calculate_qbi_deduction(
            components,
            taxable_income=Decimal("50000"),  # 20% = $10k
            net_capital_gains=Decimal("0"),
            filing_status=FilingStatus.SINGLE,
        )
        # Tentative = $40k, but limited to 20% of TI = $10k
        assert result.final_qbi_deduction == Decimal("10000.00")
        assert result.taxable_income_limit_applied
    
    def test_qbi_multiple_businesses(self):
        """Multiple QBI components aggregated."""
        components = [
            QBIComponent(
                business_name="Business 1",
                qualified_business_income=Decimal("50000"),
            ),
            QBIComponent(
                business_name="Business 2",
                qualified_business_income=Decimal("30000"),
            ),
        ]
        result = calculate_qbi_deduction(
            components,
            taxable_income=Decimal("150000"),
            net_capital_gains=Decimal("0"),
            filing_status=FilingStatus.SINGLE,
        )
        # Total QBI = $80k, deduction = 20% = $16k
        assert result.total_qbi == Decimal("80000")
        assert result.final_qbi_deduction == Decimal("16000.00")
    
    def test_qbi_mfj_higher_threshold(self):
        """MFJ has higher threshold ($383,900)."""
        components = [
            QBIComponent(
                business_name="Test Business",
                qualified_business_income=Decimal("100000"),
            ),
        ]
        result = calculate_qbi_deduction(
            components,
            taxable_income=Decimal("350000"),  # Below MFJ threshold
            net_capital_gains=Decimal("0"),
            filing_status=FilingStatus.MARRIED_FILING_JOINTLY,
        )
        assert not result.is_above_threshold
        assert result.final_qbi_deduction == Decimal("20000.00")
```

**Verify:**
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v -k "QBI" --tb=short
```
All tests pass.

**Done:** 10+ tests for QBI deduction pass

---

## Success Criteria

- [ ] QBIComponent with tentative deduction and wage limits
- [ ] QBIDeduction result with complete breakdown
- [ ] QBI thresholds for all filing statuses
- [ ] calculate_qbi_deduction() with phaseout logic
- [ ] SSTB exclusion above threshold
- [ ] W-2 wage limitation works correctly
- [ ] Taxable income limitation works
- [ ] Helper functions for Schedule C, K-1, rental
- [ ] K-1 QBI excludes guaranteed payments (Box 4)
- [ ] TaxSituation includes QBI deduction
- [ ] All QBI tests pass
- [ ] All Phase 3 tests still pass

## Commit

After all tasks complete:
```bash
git add -A
git commit -m "feat(04-06): add QBI deduction (Section 199A) calculator"
```
