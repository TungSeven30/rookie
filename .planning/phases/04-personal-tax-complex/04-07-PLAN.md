# Plan 04-07: Form 8962 ACA Reconciliation

---
phase: 04-personal-tax-complex
plan: 07
type: execute
wave: 4
depends_on: ["04-01"]
---

## Objective

Implement Form 8962 Premium Tax Credit reconciliation for ACA marketplace coverage.

**Purpose:** Calculate the Premium Tax Credit and reconcile advance payments received during the year.

**Output:**
- Form1095A document model
- extract_1095_a() function
- PremiumTaxCredit dataclass
- calculate_premium_tax_credit() function
- Reconciliation logic (repayment vs additional credit)

## Tasks

### Task 1: Create Form1095A Document Model

**Files:** src/documents/models.py

**Action:**
Create Form1095A Pydantic model:

```python
class MonthlyMarketplaceData(BaseModel):
    """Monthly data from Form 1095-A."""
    month: int  # 1-12
    enrolled_premium: Decimal  # Column A
    slcsp_premium: Decimal     # Column B (Second Lowest Cost Silver Plan)
    advance_ptc: Decimal       # Column C (Advance payments)


class Form1095A(BaseModel):
    """Form 1095-A Health Insurance Marketplace Statement."""
    
    # Recipient information
    recipient_name: str
    recipient_tin: str
    recipient_address: str | None = None
    
    # Marketplace information
    marketplace_id: str
    policy_number: str
    policy_start_date: str
    policy_end_date: str | None = None
    
    # Covered individuals
    covered_individuals: list[str] = Field(default_factory=list)  # Use Field for mutable default
    
    # Monthly data (up to 12 months)
    monthly_data: list[MonthlyMarketplaceData] = Field(default_factory=list)  # Use Field for mutable default
    
    # Annual totals
    annual_enrolled_premium: Decimal = Decimal("0")    # Sum of Column A
    annual_slcsp_premium: Decimal = Decimal("0")       # Sum of Column B
    annual_advance_ptc: Decimal = Decimal("0")         # Sum of Column C
    
    # Metadata
    confidence: ConfidenceLevel = ConfidenceLevel.HIGH
    uncertain_fields: list[str] = Field(default_factory=list)  # Use Field for mutable default
    
    @property
    def coverage_months(self) -> int:
        """Number of months with coverage data."""
        return len(self.monthly_data)
    
    @property
    def is_partial_year(self) -> bool:
        """Check if this is partial-year coverage (less than 12 months)."""
        return len(self.monthly_data) < 12 and len(self.monthly_data) > 0
    
    @field_validator("recipient_tin", mode="before")
    @classmethod
    def validate_tin(cls, value: str) -> str:
        return validate_tin(value)
    
    def model_post_init(self, __context: Any) -> None:
        """Calculate annual totals from monthly data."""
        if self.monthly_data and self.annual_enrolled_premium == Decimal("0"):
            self.annual_enrolled_premium = sum(m.enrolled_premium for m in self.monthly_data)
            self.annual_slcsp_premium = sum(m.slcsp_premium for m in self.monthly_data)
            self.annual_advance_ptc = sum(m.advance_ptc for m in self.monthly_data)
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.documents.models import Form1095A, MonthlyMarketplaceData
form = Form1095A(
    recipient_name='John Smith',
    recipient_tin='123-45-6789',
    marketplace_id='FFMID12345',
    policy_number='POL123',
    policy_start_date='2024-01-01',
    monthly_data=[
        MonthlyMarketplaceData(month=1, enrolled_premium=Decimal('500'), slcsp_premium=Decimal('600'), advance_ptc=Decimal('300')),
        MonthlyMarketplaceData(month=2, enrolled_premium=Decimal('500'), slcsp_premium=Decimal('600'), advance_ptc=Decimal('300')),
    ],
)
print(f'Annual premium: {form.annual_enrolled_premium}')
print(f'Annual SLCSP: {form.annual_slcsp_premium}')
print(f'Advance PTC: {form.annual_advance_ptc}')
"
```

**Done:** Form1095A model with monthly data

---

### Task 2: Create 1095-A Extraction Prompt

**Files:** src/documents/prompts.py

**Action:**
Create FORM_1095_A_PROMPT:

```python
FORM_1095_A_PROMPT = """
You are extracting data from Form 1095-A (Health Insurance Marketplace Statement).

Extract the following fields:

RECIPIENT INFORMATION:
- recipient_name: Name of person covered
- recipient_tin: Recipient's SSN
- recipient_address: Full mailing address

MARKETPLACE/POLICY:
- marketplace_id: Marketplace-assigned policy identifier
- policy_number: Policy number
- policy_start_date: Coverage start date (YYYY-MM-DD)
- policy_end_date: Coverage end date if applicable

COVERED INDIVIDUALS:
- covered_individuals: Array of names of covered family members

MONTHLY AMOUNTS (Part III):
For each month with coverage (months 1-12), extract:
- month: Month number (1-12)
- enrolled_premium: Column A - Monthly enrollment premium
- slcsp_premium: Column B - Monthly SLCSP premium (Second Lowest Cost Silver Plan)
- advance_ptc: Column C - Monthly advance payment of PTC

ANNUAL TOTALS (if shown):
- annual_enrolled_premium: Total of Column A
- annual_slcsp_premium: Total of Column B
- annual_advance_ptc: Total of Column C

Notes:
- If "Annual Totals" row is shown, use those values
- Otherwise, sum the monthly amounts
- SLCSP = Second Lowest Cost Silver Plan for the coverage area
- Advance PTC is what was paid directly to the insurer

Return JSON with uncertain_fields for any values with low confidence.
"""
```

**Done:** 1095-A extraction prompt

---

### Task 3: Implement extract_1095_a()

**Files:** src/documents/extractor.py

**Action:**
Create extract_1095_a() function:

```python
async def extract_1095_a(
    client: anthropic.AsyncAnthropic,
    image_data: bytes,
    mock: bool = False,
) -> Form1095A:
    """
    Extract Form 1095-A data from image.
    
    Args:
        client: Anthropic API client
        image_data: Document image bytes
        mock: Use mock extraction for testing
        
    Returns:
        Form1095A model with extracted data
    """
    if mock:
        return _mock_1095_a()
    
    response = await _extract_with_vision(
        client=client,
        image_data=image_data,
        prompt=FORM_1095_A_PROMPT,
        response_model=Form1095A,
    )
    
    return response


def _mock_1095_a() -> Form1095A:
    """Return mock 1095-A for testing."""
    monthly_data = []
    for month in range(1, 13):
        monthly_data.append(MonthlyMarketplaceData(
            month=month,
            enrolled_premium=Decimal("650"),
            slcsp_premium=Decimal("800"),
            advance_ptc=Decimal("400"),
        ))
    
    return Form1095A(
        recipient_name="John Q. Taxpayer",
        recipient_tin="123-45-6789",
        recipient_address="123 Main St, Austin TX 78701",
        marketplace_id="FFMID123456789",
        policy_number="POL-2024-12345",
        policy_start_date="2024-01-01",
        policy_end_date="2024-12-31",
        covered_individuals=["John Q. Taxpayer", "Jane Taxpayer"],
        monthly_data=monthly_data,
        confidence=ConfidenceLevel.HIGH,
    )
```

**Verify:**
```bash
uv run python -c "
import asyncio
from src.documents.extractor import extract_1095_a

async def test():
    result = await extract_1095_a(None, b'', mock=True)
    print(f'1095-A: {result.recipient_name}')
    print(f'Annual advance PTC: {result.annual_advance_ptc}')

asyncio.run(test())
"
```

**Done:** 1095-A extractor with mock function

---

### Task 4: Create Federal Poverty Level Constants

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Define 2024 Federal Poverty Level:

```python
# Federal Poverty Level (2024) - 48 contiguous states
# Used for Premium Tax Credit calculation
FPL_2024: dict[int, Decimal] = {
    1: Decimal("14580"),
    2: Decimal("19720"),
    3: Decimal("24860"),
    4: Decimal("30000"),
    5: Decimal("35140"),
    6: Decimal("40280"),
    7: Decimal("45420"),
    8: Decimal("50560"),
}

# Additional person above 8
FPL_2024_ADDITIONAL = Decimal("5140")


def get_fpl(household_size: int, tax_year: int = 2024) -> Decimal:
    """Get Federal Poverty Level for household size."""
    if household_size <= 8:
        return FPL_2024.get(household_size, FPL_2024[1])
    else:
        # For each additional person above 8
        return FPL_2024[8] + FPL_2024_ADDITIONAL * (household_size - 8)
```

**Done:** FPL constants defined

---

### Task 5: Create Applicable Percentage Function

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Calculate applicable percentage (contribution %) based on income:

```python
def get_applicable_percentage(
    income_as_fpl_percent: Decimal,
) -> Decimal:
    """
    Get applicable percentage for PTC calculation.
    
    2024 rates (ARP extended):
    - <150% FPL: 0%
    - 150-200% FPL: 0-2%
    - 200-250% FPL: 2-4%
    - 250-300% FPL: 4-6%
    - 300-400% FPL: 6-8.5%
    - >400% FPL: 8.5%
    
    Returns contribution as decimal (e.g., 0.04 for 4%)
    """
    if income_as_fpl_percent < Decimal("150"):
        return Decimal("0")
    elif income_as_fpl_percent < Decimal("200"):
        # Linear from 0% to 2%
        pct = (income_as_fpl_percent - Decimal("150")) / Decimal("50")
        return pct * Decimal("0.02")
    elif income_as_fpl_percent < Decimal("250"):
        # Linear from 2% to 4%
        pct = (income_as_fpl_percent - Decimal("200")) / Decimal("50")
        return Decimal("0.02") + pct * Decimal("0.02")
    elif income_as_fpl_percent < Decimal("300"):
        # Linear from 4% to 6%
        pct = (income_as_fpl_percent - Decimal("250")) / Decimal("50")
        return Decimal("0.04") + pct * Decimal("0.02")
    elif income_as_fpl_percent < Decimal("400"):
        # Linear from 6% to 8.5%
        pct = (income_as_fpl_percent - Decimal("300")) / Decimal("100")
        return Decimal("0.06") + pct * Decimal("0.025")
    else:
        return Decimal("0.085")
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.agents.personal_tax.calculator import get_applicable_percentage
# Test various FPL levels
for fpl in [100, 150, 200, 250, 300, 400, 500]:
    pct = get_applicable_percentage(Decimal(str(fpl)))
    print(f'{fpl}% FPL: {pct * 100:.2f}% contribution')
"
```

**Done:** Applicable percentage function

---

### Task 6: Create PremiumTaxCredit Dataclass

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create PremiumTaxCredit result dataclass:

```python
@dataclass
class PremiumTaxCredit:
    """Premium Tax Credit calculation result (Form 8962)."""
    
    # Household data
    household_size: int
    household_income: Decimal
    federal_poverty_level: Decimal
    income_as_fpl_percent: Decimal
    
    # Premium data
    annual_enrollment_premium: Decimal
    annual_slcsp_premium: Decimal
    
    # Credit calculation
    applicable_percentage: Decimal
    annual_contribution: Decimal      # Income × applicable %
    calculated_ptc: Decimal           # SLCSP - contribution
    
    # Reconciliation
    advance_ptc_received: Decimal
    
    # Final result
    net_ptc: Decimal                  # Additional credit (+) or repayment (-)
    repayment_required: bool
    repayment_amount: Decimal
    repayment_limitation: Decimal | None  # Cap based on income
    additional_credit: Decimal
    
    # Eligibility
    is_eligible: bool
    ineligibility_reason: str | None = None
    
    # Partial year tracking
    is_partial_year: bool = False
    coverage_months: int = 12
```

**Done:** PremiumTaxCredit dataclass

---

### Task 7: Create Repayment Limitation Function

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Implement repayment limitation based on income:

```python
def get_ptc_repayment_limit(
    income_as_fpl_percent: Decimal,
    filing_status: FilingStatus,
) -> Decimal | None:
    """
    Get repayment limitation for excess advance PTC.
    
    2024 limits:
    | FPL % | Single/HOH | MFJ/QW |
    |-------|------------|--------|
    | <200% | $375       | $750   |
    | 200-300% | $975    | $1,950 |
    | 300-400% | $1,625  | $3,250 |
    | >400% | No limit   | No limit |
    
    Returns None if no limit applies.
    """
    is_joint = filing_status in (
        FilingStatus.MARRIED_FILING_JOINTLY,
        FilingStatus.QUALIFYING_WIDOW,
    )
    
    if income_as_fpl_percent >= Decimal("400"):
        return None  # No limit - full repayment required
    elif income_as_fpl_percent >= Decimal("300"):
        return Decimal("3250") if is_joint else Decimal("1625")
    elif income_as_fpl_percent >= Decimal("200"):
        return Decimal("1950") if is_joint else Decimal("975")
    else:
        return Decimal("750") if is_joint else Decimal("375")
```

**Done:** Repayment limitation function

---

### Task 8: Implement calculate_premium_tax_credit()

**Files:** src/agents/personal_tax/calculator.py

**Action:**
Create calculate_premium_tax_credit() function:

```python
def calculate_premium_tax_credit(
    household_income: Decimal,
    household_size: int,
    form_1095a: Form1095A,
    filing_status: FilingStatus,
) -> PremiumTaxCredit:
    """
    Calculate Premium Tax Credit and reconcile advance payments.
    
    Form 8962 logic:
    1. Calculate household income as % of FPL
    2. Determine applicable percentage (contribution %)
    3. Calculate annual contribution (income × applicable %)
    4. Calculate PTC = SLCSP premium - contribution
    5. Compare to advance payments received
    6. Determine additional credit or repayment (with limitations)
    
    Args:
        household_income: MAGI for household
        household_size: Number of people in tax household
        form_1095a: Form 1095-A with marketplace data
        filing_status: For repayment limitation
        
    Returns:
        PremiumTaxCredit with complete reconciliation
    """
    # Get FPL for household
    fpl = get_fpl(household_size)
    income_pct = (household_income / fpl) * Decimal("100")
    
    # Check eligibility (100%-400% FPL for standard PTC)
    # Note: ARP removed 400% cap through 2025
    is_eligible = income_pct >= Decimal("100")
    
    # Track partial-year coverage
    # NOTE: Form 8962 is month-based. If partial-year coverage, we're simplifying
    # by using annual calculation. For full accuracy, should do month-by-month.
    is_partial_year = form_1095a.is_partial_year
    coverage_months = form_1095a.coverage_months
    
    if not is_eligible:
        return PremiumTaxCredit(
            household_size=household_size,
            household_income=household_income,
            federal_poverty_level=fpl,
            income_as_fpl_percent=income_pct,
            annual_enrollment_premium=form_1095a.annual_enrolled_premium,
            annual_slcsp_premium=form_1095a.annual_slcsp_premium,
            applicable_percentage=Decimal("0"),
            annual_contribution=Decimal("0"),
            calculated_ptc=Decimal("0"),
            advance_ptc_received=form_1095a.annual_advance_ptc,
            net_ptc=-form_1095a.annual_advance_ptc,
            repayment_required=True,
            repayment_amount=form_1095a.annual_advance_ptc,
            repayment_limitation=None,
            additional_credit=Decimal("0"),
            is_eligible=False,
            ineligibility_reason="Household income below 100% FPL",
            is_partial_year=is_partial_year,
            coverage_months=coverage_months,
        )
    
    # Calculate applicable percentage and contribution
    applicable_pct = get_applicable_percentage(income_pct)
    annual_contribution = household_income * applicable_pct
    
    # Calculate PTC (cannot exceed enrollment premium)
    slcsp = form_1095a.annual_slcsp_premium
    ptc = max(Decimal("0"), slcsp - annual_contribution)
    ptc = min(ptc, form_1095a.annual_enrolled_premium)  # Can't exceed actual premium
    
    # Reconcile with advance payments
    advance = form_1095a.annual_advance_ptc
    net_ptc = ptc - advance
    
    # Determine repayment or additional credit
    if net_ptc < Decimal("0"):
        # Repayment required
        repayment_amount = abs(net_ptc)
        repayment_limit = get_ptc_repayment_limit(income_pct, filing_status)
        
        if repayment_limit is not None:
            repayment_amount = min(repayment_amount, repayment_limit)
        
        return PremiumTaxCredit(
            household_size=household_size,
            household_income=household_income,
            federal_poverty_level=fpl,
            income_as_fpl_percent=income_pct.quantize(Decimal("0.01")),
            annual_enrollment_premium=form_1095a.annual_enrolled_premium,
            annual_slcsp_premium=slcsp,
            applicable_percentage=applicable_pct.quantize(Decimal("0.0001")),
            annual_contribution=annual_contribution.quantize(Decimal("0.01")),
            calculated_ptc=ptc.quantize(Decimal("0.01")),
            advance_ptc_received=advance,
            net_ptc=net_ptc.quantize(Decimal("0.01")),
            repayment_required=True,
            repayment_amount=repayment_amount.quantize(Decimal("0.01")),
            repayment_limitation=repayment_limit,
            additional_credit=Decimal("0"),
            is_eligible=True,
            is_partial_year=is_partial_year,
            coverage_months=coverage_months,
        )
    else:
        # Additional credit
        return PremiumTaxCredit(
            household_size=household_size,
            household_income=household_income,
            federal_poverty_level=fpl,
            income_as_fpl_percent=income_pct.quantize(Decimal("0.01")),
            annual_enrollment_premium=form_1095a.annual_enrolled_premium,
            annual_slcsp_premium=slcsp,
            applicable_percentage=applicable_pct.quantize(Decimal("0.0001")),
            annual_contribution=annual_contribution.quantize(Decimal("0.01")),
            calculated_ptc=ptc.quantize(Decimal("0.01")),
            advance_ptc_received=advance,
            net_ptc=net_ptc.quantize(Decimal("0.01")),
            repayment_required=False,
            repayment_amount=Decimal("0"),
            repayment_limitation=None,
            additional_credit=net_ptc.quantize(Decimal("0.01")),
            is_eligible=True,
            is_partial_year=is_partial_year,
            coverage_months=coverage_months,
        )
```

**Verify:**
```bash
uv run python -c "
from decimal import Decimal
from src.documents.models import Form1095A, MonthlyMarketplaceData
from src.agents.personal_tax.calculator import (
    calculate_premium_tax_credit, FilingStatus
)
# Create mock 1095-A
monthly = [MonthlyMarketplaceData(month=m, enrolled_premium=Decimal('500'), slcsp_premium=Decimal('600'), advance_ptc=Decimal('300')) for m in range(1, 13)]
form = Form1095A(
    recipient_name='Test',
    recipient_tin='123-45-6789',
    marketplace_id='FFMID123',
    policy_number='POL123',
    policy_start_date='2024-01-01',
    monthly_data=monthly,
)

# Income at 200% FPL for family of 3
result = calculate_premium_tax_credit(
    household_income=Decimal('49720'),  # 200% of $24,860
    household_size=3,
    form_1095a=form,
    filing_status=FilingStatus.SINGLE,
)
print(f'FPL%: {result.income_as_fpl_percent}')
print(f'Applicable %: {result.applicable_percentage * 100:.2f}%')
print(f'Calculated PTC: {result.calculated_ptc}')
print(f'Advance received: {result.advance_ptc_received}')
print(f'Net PTC: {result.net_ptc}')
print(f'Repayment: {result.repayment_required}')
"
```

**Done:** calculate_premium_tax_credit() with full reconciliation

---

### Task 9: Create PTC Tests

**Files:** tests/agents/personal_tax/test_calculator.py

**Action:**
Add comprehensive tests for Premium Tax Credit:

```python
class TestPremiumTaxCredit:
    """Tests for Premium Tax Credit calculation."""
    
    def test_ptc_at_150_fpl(self):
        """PTC at 150% FPL has 0% contribution."""
        form = self._create_mock_1095a()
        result = calculate_premium_tax_credit(
            household_income=Decimal("21870"),  # 150% of $14,580
            household_size=1,
            form_1095a=form,
            filing_status=FilingStatus.SINGLE,
        )
        assert result.applicable_percentage == Decimal("0")
        assert result.is_eligible
    
    def test_ptc_at_200_fpl(self):
        """PTC at 200% FPL has 2% contribution."""
        form = self._create_mock_1095a()
        result = calculate_premium_tax_credit(
            household_income=Decimal("29160"),  # 200% of $14,580
            household_size=1,
            form_1095a=form,
            filing_status=FilingStatus.SINGLE,
        )
        assert result.applicable_percentage == Decimal("0.0200")
    
    def test_ptc_repayment_with_limit(self):
        """Repayment capped based on income."""
        form = self._create_mock_1095a(advance=Decimal("10000"))
        result = calculate_premium_tax_credit(
            household_income=Decimal("35000"),  # ~240% FPL
            household_size=1,
            form_1095a=form,
            filing_status=FilingStatus.SINGLE,
        )
        assert result.repayment_required
        # 200-300% FPL limit is $975 for single
        assert result.repayment_amount <= Decimal("975")
    
    def test_ptc_additional_credit(self):
        """Additional credit when PTC > advance."""
        form = self._create_mock_1095a(advance=Decimal("100"))  # Low advance
        result = calculate_premium_tax_credit(
            household_income=Decimal("21870"),  # 150% FPL
            household_size=1,
            form_1095a=form,
            filing_status=FilingStatus.SINGLE,
        )
        assert not result.repayment_required
        assert result.additional_credit > Decimal("0")
    
    def test_ptc_ineligible_below_100_fpl(self):
        """Ineligible if income below 100% FPL."""
        form = self._create_mock_1095a()
        result = calculate_premium_tax_credit(
            household_income=Decimal("10000"),  # Below 100% FPL
            household_size=1,
            form_1095a=form,
            filing_status=FilingStatus.SINGLE,
        )
        assert not result.is_eligible
        assert result.repayment_required
    
    def _create_mock_1095a(
        self,
        premium: Decimal = Decimal("500"),
        slcsp: Decimal = Decimal("600"),
        advance: Decimal = Decimal("300"),
    ) -> Form1095A:
        """Create mock Form 1095-A."""
        monthly = [
            MonthlyMarketplaceData(
                month=m,
                enrolled_premium=premium,
                slcsp_premium=slcsp,
                advance_ptc=advance / 12,
            )
            for m in range(1, 13)
        ]
        return Form1095A(
            recipient_name="Test",
            recipient_tin="123-45-6789",
            marketplace_id="FFM123",
            policy_number="POL123",
            policy_start_date="2024-01-01",
            monthly_data=monthly,
            annual_enrolled_premium=premium * 12,
            annual_slcsp_premium=slcsp * 12,
            annual_advance_ptc=advance,
        )
```

**Verify:**
```bash
uv run pytest tests/agents/personal_tax/test_calculator.py -v -k "PremiumTaxCredit" --tb=short
```
All tests pass.

**Done:** 10+ tests for Premium Tax Credit pass

---

## Success Criteria

- [ ] Form1095A model with monthly data (using Field for mutable defaults)
- [ ] extract_1095_a() with mock function
- [ ] FPL constants for 2024
- [ ] get_applicable_percentage() with ARP rates
- [ ] get_ptc_repayment_limit() function
- [ ] PremiumTaxCredit result dataclass with partial-year tracking
- [ ] calculate_premium_tax_credit() with full reconciliation
- [ ] Repayment limitations apply correctly
- [ ] Additional credit calculated correctly
- [ ] Partial-year coverage tracked (is_partial_year flag)
- [ ] Test: PTC partial-year coverage is identified
- [ ] All PTC tests pass
- [ ] All Phase 3 tests still pass

## Known Simplifications

- **Month-by-month PTC**: Form 8962 technically calculates PTC month-by-month. 
  This implementation uses annual totals for simplicity. If `is_partial_year=True`, 
  the calculation may be approximate. Add escalation for partial-year cases if 
  significant accuracy variance is detected.

## Commit

After all tasks complete:
```bash
git add -A
git commit -m "feat(04-07): add Form 8962 Premium Tax Credit reconciliation"
```
