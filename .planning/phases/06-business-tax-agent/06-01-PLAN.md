---
phase: 06-business-tax-agent
plan: 01
type: execute
wave: 1
depends_on: ["04-08"]
files_modified:
  - src/agents/business_tax/__init__.py
  - src/agents/business_tax/models.py
  - tests/agents/business_tax/__init__.py
  - tests/agents/business_tax/test_models.py
autonomous: true

must_haves:
  truths:
    - "Form1120S model validates entity info, income, and deduction fields with Decimal precision"
    - "ScheduleK model holds all pro-rata share items (Boxes 1-17) for S-Corp"
    - "ScheduleL model represents balance sheet with beginning/ending columns and assets=liabilities+equity check"
    - "ShareholderInfo model captures ownership percentage, TIN, basis data"
    - "TrialBalanceEntry and TrialBalance models represent GL accounts with debit/credit balances"
  artifacts:
    - path: "src/agents/business_tax/__init__.py"
      provides: "Module marker and public exports"
    - path: "src/agents/business_tax/models.py"
      provides: "All business tax Pydantic models"
      contains: "Form1120S, ScheduleK, ScheduleL, ShareholderInfo, TrialBalanceEntry, TrialBalance"
    - path: "tests/agents/business_tax/test_models.py"
      provides: "Validation and roundtrip tests for all models"
      min_lines: 150
  key_links:
    - from: "src/agents/business_tax/models.py"
      to: "src/documents/models.py"
      via: "imports ConfidenceLevel, validate_ein"
      pattern: "from src\\.documents\\.models import"
---

<objective>
Create Pydantic data models for the Business Tax Agent: Form 1120-S, Schedule K, Schedule L (balance sheet), shareholder information, and trial balance structures.

Purpose: These models define the data contracts for all downstream calculations, basis tracking, K-1 allocation, and output generation. They must be in place before any computation logic is written.

Output:
- `src/agents/business_tax/models.py` with all Pydantic models
- `src/agents/business_tax/__init__.py` with module exports
- Comprehensive model validation tests
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-business-tax-agent/06-RESEARCH.md
@src/documents/models.py
@src/agents/personal_tax/calculator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create business tax Pydantic models</name>
  <files>
    src/agents/business_tax/__init__.py
    src/agents/business_tax/models.py
  </files>
  <action>
Create `src/agents/business_tax/__init__.py` with module docstring and public exports.

Create `src/agents/business_tax/models.py` with these Pydantic models using Decimal for all monetary fields (matching existing conventions in src/documents/models.py):

1. **ShareholderInfo** - Shareholder data for K-1 generation:
   - `name: str`, `tin: TIN` (validated via validate_tin from documents/models.py), `ownership_pct: Decimal` (0-100), `is_officer: bool`, `beginning_stock_basis: Decimal`, `beginning_debt_basis: Decimal`, `suspended_losses: Decimal` (default 0), `officer_compensation: Decimal` (default 0)
   - Validator: ownership_pct must be 0 < pct <= 100

2. **TrialBalanceEntry** - Single GL account line:
   - `account_number: str | None`, `account_name: str`, `account_type: str` (one of: "asset", "liability", "equity", "revenue", "cogs", "expense"), `debit: Decimal` (default 0), `credit: Decimal` (default 0)
   - Property: `net_balance` returns debit - credit
   - Note: For asset/expense accounts, debit is normal balance; for liability/equity/revenue, credit is normal balance

3. **TrialBalance** - Complete trial balance:
   - `entries: list[TrialBalanceEntry]`, `period_start: str`, `period_end: str`, `entity_name: str`, `source_format: str` (one of: "excel", "pdf", "csv")
   - Property: `total_debits` and `total_credits` (sums)
   - Property: `is_balanced` returns total_debits == total_credits
   - Method: `entries_by_type(account_type: str) -> list[TrialBalanceEntry]`

4. **ScheduleKLine** - Single Schedule K line item:
   - `line_number: str`, `description: str`, `amount: Decimal`

5. **ScheduleK** - All Schedule K items (Pages 2-3 of 1120-S):
   - Boxes 1-11 as named Decimal fields (ordinary_income, net_rental_real_estate, other_rental_income, interest_income, dividends, royalties, net_short_term_capital_gain, net_long_term_capital_gain, net_section_1231_gain, other_income_loss, section_179_deduction), all default Decimal("0")
   - Box 12: charitable_contributions (default 0)
   - Box 13: credits (default 0)
   - Box 14: foreign_transactions (default 0, escalation trigger)
   - Box 15: amt_items (default 0, escalation trigger)
   - Box 16a: tax_exempt_interest (default 0)
   - Box 16b: other_tax_exempt_income (default 0)
   - Box 16c: nondeductible_expenses (default 0)
   - Box 16d: distributions (default 0)
   - Box 17: other_information (default 0)

6. **ScheduleLLine** - Balance sheet line item with beginning/ending:
   - `line_number: int`, `description: str`, `beginning_amount: Decimal`, `ending_amount: Decimal`

7. **ScheduleL** - Balance sheet per books:
   - Asset lines (1-15): cash, trade_receivables, inventories, us_government_obligations, tax_exempt_securities, other_current_assets, loans_to_shareholders, mortgage_real_estate, other_investments, buildings_other_depreciable, depreciable_accumulated_depreciation (negative), depletable_assets, land, intangible_assets, other_assets
   - Liability lines (16-22): accounts_payable, mortgages_bonds_payable_less_1yr, other_current_liabilities, loans_from_shareholders, mortgages_bonds_payable_1yr_plus, other_liabilities
   - Equity lines (22-27): capital_stock, additional_paid_in_capital, retained_earnings, adjustments_to_shareholders_equity, less_cost_treasury_stock
   - All fields are ScheduleLLine with beginning/ending
   - Property: `total_assets_beginning`, `total_assets_ending`, `total_liabilities_equity_beginning`, `total_liabilities_equity_ending`
   - Property: `is_balanced_beginning`, `is_balanced_ending` (assets == liabilities+equity)

8. **Form1120SResult** - Complete 1120-S computation result:
   - `entity_name: str`, `entity_ein: str`, `tax_year: int`, `fiscal_year_end: str | None`
   - Page 1 results: `gross_receipts: Decimal`, `cost_of_goods_sold: Decimal`, `gross_profit: Decimal`, `total_income: Decimal`, `total_deductions: Decimal`, `ordinary_business_income: Decimal`
   - `schedule_k: ScheduleK`, `schedule_l: ScheduleL`
   - `shareholders: list[ShareholderInfo]`
   - `escalations: list[str]` (default_factory=list)
   - `confidence: ConfidenceLevel` (default HIGH)

Import ConfidenceLevel from src.documents.models. Import and reuse validate_ein, validate_tin patterns.
  </action>
  <verify>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run python -c "
from src.agents.business_tax.models import (
    Form1120SResult, ScheduleK, ScheduleL, ScheduleLLine,
    ShareholderInfo, TrialBalance, TrialBalanceEntry
)
print('All models import successfully')
# Quick validation check
from decimal import Decimal
entry = TrialBalanceEntry(account_name='Cash', account_type='asset', debit=Decimal('10000'))
assert entry.net_balance == Decimal('10000')
tb = TrialBalance(entries=[entry], period_start='2024-01-01', period_end='2024-12-31', entity_name='Test Corp', source_format='excel')
assert tb.total_debits == Decimal('10000')
print('Basic validation passed')
"
```
  </verify>
  <done>All Pydantic models created with Decimal precision, validation, and computed properties. Models import cleanly and basic validation works.</done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive model tests</name>
  <files>
    tests/agents/business_tax/__init__.py
    tests/agents/business_tax/test_models.py
  </files>
  <action>
Create `tests/agents/business_tax/__init__.py` (empty module marker).

Create `tests/agents/business_tax/test_models.py` with pytest tests covering:

**ShareholderInfo tests:**
- Valid construction with all fields
- TIN validation (SSN and EIN formats accepted)
- Ownership percentage validation (rejects 0, rejects >100, accepts 50.5)
- Default values for optional fields

**TrialBalanceEntry tests:**
- Net balance calculation (debit - credit)
- Asset account with debit balance
- Liability account with credit balance
- Zero balance entry

**TrialBalance tests:**
- Balanced trial balance (total_debits == total_credits)
- Unbalanced trial balance detection
- entries_by_type filtering
- Empty trial balance

**ScheduleK tests:**
- Default zero values for all boxes
- Setting income and deduction items
- All fields are Decimal type

**ScheduleL tests:**
- Balance sheet that balances (assets == liabilities + equity)
- Balance sheet that does NOT balance (detection)
- Beginning and ending period separation
- Total computation accuracy

**Form1120SResult tests:**
- Valid construction with all components
- Confidence level defaults to HIGH
- Escalations list is empty by default
- EIN validation on entity_ein

Run with: `cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_models.py -v`
  </action>
  <verify>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_models.py -v
```
  </verify>
  <done>All model tests pass. Tests cover validation rules, computed properties, balance checks, and edge cases.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_models.py -v --tb=short
```
All tests pass. Models are importable from `src.agents.business_tax.models`.
</verification>

<success_criteria>
- All 8 Pydantic models created with Decimal monetary fields
- ShareholderInfo validates TIN and ownership percentage
- TrialBalance computes total_debits, total_credits, is_balanced
- ScheduleL computes total_assets and total_liabilities_equity with balance check
- All tests pass (target: 30+ tests)
- No new dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/06-business-tax-agent/06-01-SUMMARY.md`
</output>
