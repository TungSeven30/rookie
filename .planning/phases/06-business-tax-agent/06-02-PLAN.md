---
phase: 06-business-tax-agent
plan: 02
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/agents/business_tax/trial_balance.py
  - tests/agents/business_tax/test_trial_balance.py
autonomous: true

must_haves:
  truths:
    - "Excel trial balance is parsed into TrialBalance model with correct debit/credit amounts"
    - "GL accounts are mapped to 1120-S line items with confidence scoring"
    - "Ambiguous account mappings are flagged as LOW confidence for CPA review"
    - "Trial balance debits equal credits after parsing"
    - "Common accounts (officer comp, rent, COGS, revenue) map to correct 1120-S lines"
  artifacts:
    - path: "src/agents/business_tax/trial_balance.py"
      provides: "Trial balance parsing and GL-to-1120S mapping"
      exports: ["parse_excel_trial_balance", "map_gl_to_1120s", "GLMapping"]
      min_lines: 150
    - path: "tests/agents/business_tax/test_trial_balance.py"
      provides: "TDD tests for trial balance parsing and mapping"
      min_lines: 200
  key_links:
    - from: "src/agents/business_tax/trial_balance.py"
      to: "src/agents/business_tax/models.py"
      via: "imports TrialBalance, TrialBalanceEntry"
      pattern: "from src\\.agents\\.business_tax\\.models import"
---

<objective>
Implement trial balance extraction from Excel files and GL account mapping to 1120-S line items using TDD.

Purpose: The trial balance is the primary input for computing the 1120-S return. Accurate parsing and mapping is essential for all downstream calculations (BTAX-04).

Output:
- `src/agents/business_tax/trial_balance.py` with parsing and mapping functions
- Comprehensive TDD test suite
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-business-tax-agent/06-RESEARCH.md
@src/agents/business_tax/models.py
</context>

<feature>
  <name>Trial Balance Parsing and GL-to-1120S Mapping</name>
  <files>src/agents/business_tax/trial_balance.py, tests/agents/business_tax/test_trial_balance.py</files>
  <behavior>
TDD: Write tests first, then implement.

**parse_excel_trial_balance(file_bytes: bytes) -> TrialBalance:**
- Reads Excel bytes (openpyxl) and detects column layout (account number, account name, debit, credit)
- Returns TrialBalance with all entries parsed
- Handles common QuickBooks export formats (columns: Account, Debit, Credit)
- Handles single-column net balance format (positive = debit, negative = credit for asset/expense)
- Strips whitespace from account names
- Converts string amounts to Decimal
- Skips header rows and total rows

**GLMapping dataclass:**
- `account_name: str`, `form_line: str` (e.g., "page1_line7" for officer comp, "schedule_l_line1" for cash), `confidence: ConfidenceLevel`, `reasoning: str`

**DEFAULT_GL_MAPPING: dict[str, str]** - Mapping of common account name patterns to 1120-S lines:
- Revenue/Sales/Income -> page1_line1a
- COGS/Cost of Goods -> page1_line2
- Officer Comp/Officer Salary -> page1_line7
- Salaries and Wages -> page1_line8
- Repairs -> page1_line9
- Bad Debts -> page1_line10
- Rent/Lease -> page1_line13
- Taxes and Licenses -> page1_line12
- Interest Expense -> page1_line14
- Depreciation -> page1_line15
- Advertising -> page1_line17
- Pension -> page1_line18
- Employee Benefits -> page1_line19
- Cash -> schedule_l_line1
- Accounts Receivable -> schedule_l_line2
- Inventory -> schedule_l_line3
- Fixed Assets -> schedule_l_line10a
- Accumulated Depreciation -> schedule_l_line10b
- Accounts Payable -> schedule_l_line16
- Shareholder Loans -> schedule_l_line19
- Capital Stock -> schedule_l_line22
- Retained Earnings -> schedule_l_line24

**map_gl_to_1120s(trial_balance: TrialBalance) -> list[GLMapping]:**
- First pass: match account names against DEFAULT_GL_MAPPING using case-insensitive substring matching
- Matched accounts get HIGH confidence
- Unmatched accounts with recognized account_type get MEDIUM confidence with best-guess mapping based on type (e.g., expense type -> page1_line20 "other deductions")
- Completely ambiguous accounts get LOW confidence and map to page1_line20 (other) or schedule_l_line15 (other assets)
- Return one GLMapping per TrialBalanceEntry

**aggregate_mapped_amounts(trial_balance: TrialBalance, mappings: list[GLMapping]) -> dict[str, Decimal]:**
- Groups mapped entries by form_line and sums amounts
- Uses net_balance from each entry (debit - credit)
- For income/revenue lines, amounts should be positive (credit balance -> negate to get positive)
- For expense lines, amounts should be positive (debit balance = positive)
- Returns dict like {"page1_line1a": Decimal("500000"), "page1_line7": Decimal("120000"), ...}

Test cases:
- parse_excel_trial_balance: Standard 2-column (debit/credit) Excel -> correct TrialBalance
- parse_excel_trial_balance: Single net balance column -> correct TrialBalance
- parse_excel_trial_balance: Skips header and total rows
- parse_excel_trial_balance: Empty spreadsheet raises ValueError
- map_gl_to_1120s: "Officer Salary" maps to page1_line7 with HIGH confidence
- map_gl_to_1120s: "Cash in Bank" maps to schedule_l_line1 with HIGH confidence
- map_gl_to_1120s: "Miscellaneous Expense" maps to page1_line20 with MEDIUM confidence
- map_gl_to_1120s: Unknown account gets LOW confidence
- aggregate_mapped_amounts: Revenue credit balance becomes positive income
- aggregate_mapped_amounts: Expense debit balance stays positive
- aggregate_mapped_amounts: Multiple accounts on same line are summed
- Trial balance debits == credits after parsing
  </behavior>
  <implementation>
Use openpyxl (already installed) to read Excel bytes. Use case-insensitive regex matching for account name patterns. All amounts as Decimal. No LLM calls in v1 mapping -- pure heuristic mapping with confidence scoring. LLM-assisted mapping is a v2 enhancement.

Create test fixtures using openpyxl to generate in-memory Excel bytes with sample trial balance data (30-40 accounts typical of a small S-Corp).
  </implementation>
</feature>

<verification>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_trial_balance.py -v --tb=short
```
</verification>

<success_criteria>
- Excel trial balance parsed correctly into TrialBalance model
- GL accounts mapped to 1120-S lines with confidence scoring
- Common accounts (officer comp, revenue, COGS, rent, cash, AP, etc.) map correctly
- Ambiguous accounts flagged as LOW confidence
- All tests pass (target: 20+ tests)
</success_criteria>

<output>
After completion, create `.planning/phases/06-business-tax-agent/06-02-SUMMARY.md`
</output>
