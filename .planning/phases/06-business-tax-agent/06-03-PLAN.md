---
phase: 06-business-tax-agent
plan: 03
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/agents/business_tax/basis.py
  - tests/agents/business_tax/test_basis.py
autonomous: true

must_haves:
  truths:
    - "Basis calculation follows IRS ordering: income -> distributions -> nondeductible expenses -> losses"
    - "Stock basis is exhausted before debt basis absorbs losses"
    - "Distributions exceeding basis are flagged as taxable capital gain"
    - "Losses exceeding total basis (stock + debt) are suspended"
    - "Multi-year basis carries forward correctly (ending = next year beginning)"
  artifacts:
    - path: "src/agents/business_tax/basis.py"
      provides: "Shareholder basis tracking with IRS ordering rules"
      exports: ["calculate_shareholder_basis", "BasisAdjustmentInputs", "BasisResult"]
      min_lines: 100
    - path: "tests/agents/business_tax/test_basis.py"
      provides: "Extensive basis calculation tests (highest risk area)"
      min_lines: 250
  key_links:
    - from: "src/agents/business_tax/basis.py"
      to: "src/agents/business_tax/models.py"
      via: "uses ShareholderInfo for basis input data"
      pattern: "from decimal import Decimal"
---

<objective>
Implement shareholder basis tracking using TDD. This is the highest-risk component in Phase 6 -- incorrect basis calculations silently produce incorrect K-1s and affect shareholder personal returns.

Purpose: Accurate basis tracking is required by the IRS (Form 7203 since 2021) and determines loss limitations, distribution taxation, and suspended losses (BTAX-03).

Output:
- `src/agents/business_tax/basis.py` with pure basis calculation functions
- Extensive test suite covering all IRS ordering rules and edge cases
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-business-tax-agent/06-RESEARCH.md
@src/agents/business_tax/models.py
</context>

<feature>
  <name>Shareholder Basis Tracker</name>
  <files>src/agents/business_tax/basis.py, tests/agents/business_tax/test_basis.py</files>
  <behavior>
TDD: Write tests first, then implement.

**BasisAdjustmentInputs (frozen dataclass):**
All items affecting shareholder basis for the tax year. All Decimal fields:
- Income items (increase basis, Step 1):
  - `ordinary_income: Decimal` (K-1 Box 1, if positive)
  - `separately_stated_income: Decimal` (Boxes 2-10 positive items aggregated)
  - `tax_exempt_income: Decimal` (Box 16A + 16B)
  - `excess_depletion: Decimal` (default 0)
- Distributions (decrease basis, Step 2):
  - `non_dividend_distributions: Decimal` (Box 16D)
- Nondeductible expenses (decrease basis, Step 3):
  - `nondeductible_expenses: Decimal` (Box 16C)
  - `oil_gas_depletion: Decimal` (default 0)
- Loss items (decrease basis, Step 4):
  - `ordinary_loss: Decimal` (Box 1 negative, use absolute value)
  - `separately_stated_losses: Decimal` (Boxes 2-12 losses aggregated, absolute value)

**BasisResult (dataclass):**
- `beginning_stock_basis: Decimal`
- `ending_stock_basis: Decimal`
- `beginning_debt_basis: Decimal`
- `ending_debt_basis: Decimal`
- `suspended_losses: Decimal` (losses exceeding total basis)
- `distributions_taxable: Decimal` (distributions exceeding basis, taxed as capital gain)
- `distributions_nontaxable: Decimal` (distributions reducing basis)
- `losses_allowed: Decimal` (losses deductible against basis)
- `losses_limited_by_basis: Decimal` (losses suspended due to insufficient basis)

**calculate_shareholder_basis(beginning_stock_basis: Decimal, beginning_debt_basis: Decimal, adjustments: BasisAdjustmentInputs, prior_suspended_losses: Decimal = Decimal("0")) -> BasisResult:**

IRS ordering (applied as of last day of tax year):
1. INCREASE stock basis for: ordinary_income + separately_stated_income + tax_exempt_income + excess_depletion
2. DECREASE stock basis for distributions (not below zero). Excess distributions = taxable capital gain.
3. DECREASE stock basis for nondeductible_expenses + oil_gas_depletion (not below zero)
4. DECREASE for losses: ordinary_loss + separately_stated_losses + prior_suspended_losses
   - Apply losses to stock basis first (reduce to zero)
   - Then apply remainder to debt basis (reduce to zero)
   - Any remaining losses are suspended (carry forward)
5. Return BasisResult with all computed values

Test cases (COMPREHENSIVE - this is the critical path):

**Basic income tests:**
- Income increases stock basis (100 basis + 50 income = 150)
- Tax-exempt income increases basis (100 + 25 tax-exempt = 125)
- Multiple income types sum correctly

**Distribution tests:**
- Distributions within basis reduce basis (150 basis - 50 distribution = 100)
- Distributions exceeding basis: nontaxable up to basis, excess is taxable (100 basis - 150 distribution -> 0 basis, 50 taxable)
- Zero-basis shareholder: all distributions are taxable
- Distributions applied AFTER income increase (income first makes more distributions nontaxable)

**Nondeductible expense tests:**
- Nondeductible expenses reduce basis after distributions (not below zero)
- Ordering: distributions before nondeductible expenses

**Loss tests:**
- Losses reduce stock basis (not below zero)
- Losses exceeding stock basis spill to debt basis
- Losses exceeding stock + debt basis are suspended
- Stock basis exhausted before debt basis
- Suspended losses carry forward

**Multi-year tests:**
- Year 1 ending basis = Year 2 beginning basis
- Suspended losses from Year 1 applied in Year 2 when basis available
- Debt basis restoration after losses

**Edge cases:**
- Zero beginning basis, income + distributions
- All zeros (no activity) -> no change
- Very large numbers (Decimal precision)
- Negative beginning basis rejected (should not happen but guard)

**Ordering rule compliance tests:**
- Same scenario computed in correct vs incorrect order -> different results (proves ordering matters)
- Distribution before income increase vs after -> different taxable amount
  </behavior>
  <implementation>
Pure functions only. No LLM calls. No database access. All Decimal arithmetic. The `calculate_shareholder_basis` function takes all items at once and applies the IRS ordering internally -- never allow incremental/piecemeal basis updates.

Use frozen dataclass for BasisAdjustmentInputs to enforce immutability. Regular dataclass for BasisResult since it's computed output.
  </implementation>
</feature>

<verification>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_basis.py -v --tb=short
```
</verification>

<success_criteria>
- IRS ordering rule strictly enforced (income -> distributions -> nondeductible -> losses)
- Stock basis exhausted before debt basis
- Distributions exceeding basis correctly flagged as taxable
- Suspended losses tracked and carried forward
- All tests pass (target: 30+ tests covering every ordering permutation)
- No floating point arithmetic -- all Decimal
</success_criteria>

<output>
After completion, create `.planning/phases/06-business-tax-agent/06-03-SUMMARY.md`
</output>
