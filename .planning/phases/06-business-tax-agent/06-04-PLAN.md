---
phase: 06-business-tax-agent
plan: 04
type: tdd
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - src/agents/business_tax/calculator.py
  - tests/agents/business_tax/test_calculator.py
  - tests/agents/business_tax/test_schedule_l.py
autonomous: true

must_haves:
  truths:
    - "1120-S Page 1 income and deductions computed from mapped trial balance amounts"
    - "Schedule K items derived from Page 1 ordinary income plus separately stated items"
    - "Schedule L balance sheet beginning/ending populated from trial balance"
    - "Schedule L assets equal liabilities + equity (balance check)"
    - "Schedule M-1 reconciles book income to tax income"
    - "Schedule M-2 tracks AAA (Accumulated Adjustments Account)"
  artifacts:
    - path: "src/agents/business_tax/calculator.py"
      provides: "1120-S computation functions: Page 1, Schedule K, Schedule L, M-1, M-2"
      exports: ["compute_page1", "compute_schedule_k", "compute_schedule_l", "compute_schedule_m1", "compute_schedule_m2", "Page1Result"]
      min_lines: 200
    - path: "tests/agents/business_tax/test_calculator.py"
      provides: "TDD tests for 1120-S Page 1 and Schedule K computations"
      min_lines: 150
    - path: "tests/agents/business_tax/test_schedule_l.py"
      provides: "TDD tests for Schedule L balance sheet and M-1/M-2"
      min_lines: 100
  key_links:
    - from: "src/agents/business_tax/calculator.py"
      to: "src/agents/business_tax/trial_balance.py"
      via: "consumes aggregate_mapped_amounts output"
      pattern: "dict\\[str, Decimal\\]"
    - from: "src/agents/business_tax/calculator.py"
      to: "src/agents/business_tax/models.py"
      via: "returns ScheduleK, ScheduleL, Form1120SResult"
      pattern: "from src\\.agents\\.business_tax\\.models import"
---

<objective>
Implement 1120-S tax computation logic using TDD: Page 1 (income/deductions), Schedule K (shareholder pro-rata items), Schedule L (balance sheet), Schedule M-1 (book-tax reconciliation), and Schedule M-2 (AAA analysis).

Purpose: This is the core tax computation that transforms mapped trial balance data into a complete 1120-S return (BTAX-01, BTAX-05).

Output:
- `src/agents/business_tax/calculator.py` with pure computation functions
- TDD test suites for calculations and balance sheet
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-business-tax-agent/06-RESEARCH.md
@src/agents/business_tax/models.py
@src/agents/business_tax/trial_balance.py
@src/agents/personal_tax/calculator.py
</context>

<feature>
  <name>1120-S Calculator: Page 1, Schedule K, Schedule L, M-1, M-2</name>
  <files>src/agents/business_tax/calculator.py, tests/agents/business_tax/test_calculator.py, tests/agents/business_tax/test_schedule_l.py</files>
  <behavior>
TDD: Write tests first, then implement.

**Page1Result (dataclass):**
- `gross_receipts: Decimal` (Line 1a)
- `returns_and_allowances: Decimal` (Line 1b)
- `cost_of_goods_sold: Decimal` (Line 2)
- `gross_profit: Decimal` (Line 3 = 1a - 1b - 2)
- `net_gain_loss_form_4797: Decimal` (Line 4, default 0)
- `other_income: Decimal` (Line 5, default 0)
- `total_income: Decimal` (Line 6 = 3 + 4 + 5)
- `officer_compensation: Decimal` (Line 7)
- `salaries_wages: Decimal` (Line 8)
- `repairs: Decimal` (Line 9)
- `bad_debts: Decimal` (Line 10)
- `rents: Decimal` (Line 13)
- `taxes_licenses: Decimal` (Line 12)
- `interest: Decimal` (Line 14)
- `depreciation: Decimal` (Line 15)
- `advertising: Decimal` (Line 17)
- `pension_profit_sharing: Decimal` (Line 18)
- `employee_benefits: Decimal` (Line 19)
- `other_deductions: Decimal` (Line 20)
- `total_deductions: Decimal` (Line 21 = sum of Lines 7-20)
- `ordinary_business_income: Decimal` (Line 22 = Line 6 - Line 21)

**ScheduleM1Result (dataclass):**
- `book_income: Decimal` (Line 1)
- `income_on_books_not_on_return: Decimal` (Line 2, e.g., tax-exempt interest)
- `expenses_on_return_not_on_books: Decimal` (Line 3, e.g., tax depreciation > book)
- `total_lines_1_3: Decimal`
- `income_on_return_not_on_books: Decimal` (Line 5)
- `expenses_on_books_not_on_return: Decimal` (Line 6, e.g., book depreciation > tax, nondeductible expenses)
- `total_lines_5_6: Decimal`
- `income_per_return: Decimal` (Line 8 = total_1_3 - total_5_6, should equal Page 1 Line 22)

**ScheduleM2Result (dataclass):**
- `aaa_beginning: Decimal` (Accumulated Adjustments Account)
- `ordinary_income: Decimal`
- `other_additions: Decimal` (separately stated income items)
- `losses_deductions: Decimal`
- `other_reductions: Decimal` (nondeductible expenses)
- `distributions: Decimal`
- `aaa_ending: Decimal`

**compute_page1(mapped_amounts: dict[str, Decimal]) -> Page1Result:**
- Takes the output of aggregate_mapped_amounts (dict of form_line -> Decimal)
- Reads each page1_lineN value from the dict (default 0 if missing)
- Computes gross_profit, total_income, total_deductions, ordinary_business_income
- Pure function, no side effects

**compute_schedule_k(page1: Page1Result, separately_stated: dict[str, Decimal] | None = None) -> ScheduleK:**
- Box 1 = page1.ordinary_business_income
- Boxes 2-17 from separately_stated dict (e.g., interest_income, dividends from entity's own investment income)
- For v1, most separately stated items will be zero unless trial balance includes specific GL accounts for interest/dividend income, charitable contributions, etc.
- Default: all boxes except Box 1 are Decimal("0") unless provided
- Returns ScheduleK model

**compute_schedule_l(mapped_amounts: dict[str, Decimal], prior_year_schedule_l: ScheduleL | None, current_year_net_income: Decimal, current_year_distributions: Decimal) -> ScheduleL:**
- Beginning amounts from prior_year_schedule_l (or zeros if first year)
- Ending amounts from mapped trial balance (schedule_l_lineN values)
- Updates retained_earnings: beginning + current_year_net_income - current_year_distributions
- Returns ScheduleL with beginning and ending columns populated
- Note: Does NOT raise on imbalance -- caller should check is_balanced_ending and escalate

**compute_schedule_m1(book_income: Decimal, tax_income: Decimal, tax_exempt_income: Decimal = Decimal("0"), nondeductible_expenses: Decimal = Decimal("0")) -> ScheduleM1Result:**
- Line 1 = book_income
- Lines 2, 3 computed from known differences
- Lines 5, 6 computed from known differences
- Line 8 should reconcile to tax_income (Page 1 Line 22)
- For v1: compute from known differences only, flag if doesn't reconcile

**Data flow for M-1 inputs:**
- `book_income`: Computed from trial balance as total_revenue - total_expenses (book basis, before tax adjustments). The agent computes this from TrialBalance.entries_by_type("revenue") minus entries_by_type("expense") minus entries_by_type("cogs").
- `tax_income`: Page 1 Line 22 (ordinary_business_income from compute_page1 result).
- `tax_exempt_income`: From ScheduleK.tax_exempt_interest + ScheduleK.other_tax_exempt_income (if any GL accounts mapped to those K items).
- `nondeductible_expenses`: From ScheduleK.nondeductible_expenses (if any GL accounts mapped to that K item, e.g., 50% meals disallowance).

**compute_schedule_m2(aaa_beginning: Decimal, ordinary_income: Decimal, separately_stated_net: Decimal, nondeductible_expenses: Decimal, distributions: Decimal) -> ScheduleM2Result:**
- AAA tracks undistributed income that has been taxed to shareholders
- Beginning + income + other additions - losses - nondeductible - distributions = ending
- AAA can go negative from losses (but not from distributions)

**Data flow for M-2 inputs:**
- `aaa_beginning`: Passed in by agent from prior year data (parameter `prior_year_aaa` on BusinessTaxAgent.process()). Defaults to Decimal("0") for first year.
- `ordinary_income`: ScheduleK.ordinary_income (Box 1, same as Page 1 Line 22).
- `separately_stated_net`: Net of other Schedule K income/loss items (Boxes 2-10 summed). Computed by agent from ScheduleK fields.
- `nondeductible_expenses`: ScheduleK.nondeductible_expenses (Box 16c).
- `distributions`: ScheduleK.distributions (Box 16d). Also used in Schedule L retained earnings calculation.

Test cases for test_calculator.py:
- Page 1: Basic income/deductions computation from mapped amounts
- Page 1: Zero mapped amounts (startup with no revenue)
- Page 1: Ordinary business income = total income - total deductions
- Page 1: Missing line amounts default to zero
- Schedule K: Box 1 equals Page 1 ordinary business income
- Schedule K: Separately stated items populated correctly
- Schedule K: All defaults are Decimal("0")

Test cases for test_schedule_l.py:
- Schedule L: Balance sheet balances (assets = liabilities + equity)
- Schedule L: Retained earnings updated correctly
- Schedule L: Beginning from prior year
- Schedule L: First year (no prior) has zero beginning
- Schedule L: Imbalance detected (is_balanced_ending = False)
- M-1: Reconciliation when book = tax (simplest case)
- M-1: Known differences (tax-exempt income, nondeductible expenses)
- M-2: AAA increases from income, decreases from distributions
- M-2: AAA can go negative from losses
  </behavior>
  <implementation>
All pure functions with Decimal arithmetic. Follow the pattern from src/agents/personal_tax/calculator.py -- dataclass inputs/outputs, no side effects, no LLM calls.

The compute_page1 function reads from a dict[str, Decimal] keyed by form line identifiers (same keys used in trial_balance.py mapping). This decouples the calculator from the trial balance parser.
  </implementation>
</feature>

<verification>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_calculator.py tests/agents/business_tax/test_schedule_l.py -v --tb=short
```
</verification>

<success_criteria>
- Page 1 computation produces correct ordinary business income
- Schedule K Box 1 equals Page 1 ordinary business income
- Schedule L balances (assets = liabilities + equity)
- M-1 reconciles book to tax income
- M-2 AAA tracking is correct
- All tests pass (target: 25+ tests across both test files)
</success_criteria>

<output>
After completion, create `.planning/phases/06-business-tax-agent/06-04-SUMMARY.md`
</output>
