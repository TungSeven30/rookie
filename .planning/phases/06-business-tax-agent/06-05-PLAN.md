---
phase: 06-business-tax-agent
plan: 05
type: tdd
wave: 3
depends_on: ["06-01", "06-03"]
files_modified:
  - src/agents/business_tax/handoff.py
  - tests/agents/business_tax/test_handoff.py
autonomous: true

must_haves:
  truths:
    - "Schedule K items are allocated pro-rata to each shareholder K-1"
    - "K-1 amounts across all shareholders sum exactly to Schedule K totals"
    - "Rounding residual assigned to last shareholder (standard accounting approach)"
    - "Generated K-1 data serialized as FormK1 Pydantic model for Personal Tax Agent consumption"
    - "FormK1 roundtrip serialization/deserialization preserves all fields"
  artifacts:
    - path: "src/agents/business_tax/handoff.py"
      provides: "K-1 allocation and handoff protocol"
      exports: ["allocate_k1s", "generate_k1_for_handoff", "serialize_k1_artifact", "deserialize_k1_artifact"]
      min_lines: 120
    - path: "tests/agents/business_tax/test_handoff.py"
      provides: "K-1 allocation reconciliation and handoff roundtrip tests"
      min_lines: 200
  key_links:
    - from: "src/agents/business_tax/handoff.py"
      to: "src/documents/models.py"
      via: "creates FormK1 instances for handoff"
      pattern: "from src\\.documents\\.models import FormK1"
    - from: "src/agents/business_tax/handoff.py"
      to: "src/agents/business_tax/models.py"
      via: "reads ScheduleK and ShareholderInfo"
      pattern: "from src\\.agents\\.business_tax\\.models import"
---

<objective>
Implement K-1 pro-rata allocation from Schedule K to individual shareholders and the K-1 handoff protocol that generates FormK1 Pydantic models consumable by the Personal Tax Agent.

Purpose: K-1 allocation must be mathematically precise (amounts sum to Schedule K totals) and the handoff protocol bridges the Business Tax Agent output to the Personal Tax Agent input (BTAX-02, BTAX-06).

Output:
- `src/agents/business_tax/handoff.py` with allocation and serialization functions
- TDD test suite verifying allocation accuracy and roundtrip serialization
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-business-tax-agent/06-RESEARCH.md
@src/agents/business_tax/models.py
@src/agents/business_tax/basis.py
@src/documents/models.py
</context>

<feature>
  <name>K-1 Allocation and Handoff Protocol</name>
  <files>src/agents/business_tax/handoff.py, tests/agents/business_tax/test_handoff.py</files>
  <behavior>
TDD: Write tests first, then implement.

**allocate_k1_item(schedule_k_total: Decimal, shareholders: list[ShareholderInfo]) -> list[Decimal]:**
- Allocate a single Schedule K line item to shareholders pro-rata by ownership_pct
- For all shareholders except the last: amount = (total * pct / 100).quantize(Decimal("0.01"))
- Last shareholder: amount = total - sum(all others). This eliminates rounding discrepancy.
- Returns list of Decimal amounts in same order as shareholders
- Precondition: sum of ownership_pct == 100 (validate and raise ValueError if not)

**allocate_k1s(schedule_k: ScheduleK, shareholders: list[ShareholderInfo]) -> list[dict[str, Decimal]]:**
- Allocates every Schedule K field to each shareholder using allocate_k1_item
- Returns list of dicts (one per shareholder), each dict maps K-1 box name to allocated amount
- Keys match FormK1 field names: ordinary_business_income, net_rental_real_estate, interest_income, dividends (maps to dividend_income), etc.
- Map Schedule K field names to FormK1 field names

**generate_k1_for_handoff(entity_name: str, entity_ein: str, tax_year: int, shareholder: ShareholderInfo, allocated_amounts: dict[str, Decimal], basis_result: BasisResult | None = None) -> FormK1:**
- Creates a FormK1 instance from computed K-1 data
- entity_type = "s_corp"
- Sets all K-1 box fields from allocated_amounts dict
- Sets confidence = ConfidenceLevel.HIGH (generated, not extracted)
- Returns FormK1 model (validated by Pydantic)

**BasisResult -> FormK1 capital account mapping (when basis_result is provided):**
- `basis_result.beginning_stock_basis` -> `FormK1.capital_account_beginning`
- `basis_result.ending_stock_basis` -> `FormK1.capital_account_ending`
- `basis_result.current_year_increase` (sum of income/gain adjustments) -> `FormK1.capital_account_current_year_increase`
- `basis_result.current_year_decrease` (sum of loss/deduction/distribution adjustments) -> `FormK1.capital_account_current_year_decrease`
- `FormK1.capital_account_method` = "tax" (S-Corp K-1 uses tax basis method)
- If basis_result is None, leave all capital account fields as their defaults (Decimal("0") or appropriate default)

**serialize_k1_artifact(form_k1: FormK1) -> str:**
- Serializes FormK1 to JSON string using orjson
- Uses model_dump(mode="json") for Decimal serialization

**deserialize_k1_artifact(json_str: str) -> FormK1:**
- Deserializes JSON string back to FormK1
- Validates all fields through Pydantic

Test cases:

**allocate_k1_item tests:**
- 50/50 split: $100 -> $50, $50
- 75/25 split: $100 -> $75, $25
- Rounding case: 33.33/33.33/33.34 split of $100 -> amounts sum to exactly $100
- Uneven rounding: $1.01 split 50/50 -> $0.51 and $0.50 (or $0.50 and $0.51)
- Zero amount: $0 split any way -> all zeros
- Negative amount (loss): -$100 split 50/50 -> -$50, -$50
- Ownership pct not summing to 100 -> ValueError

**allocate_k1s tests:**
- 2 shareholders 50/50 with ordinary income only
- 2 shareholders 70/30 with multiple K items
- All K-1 amounts across shareholders sum to Schedule K totals for EVERY line item
- Zero Schedule K items produce zero allocations

**generate_k1_for_handoff tests:**
- Valid FormK1 created with all required fields
- entity_type is "s_corp"
- confidence is HIGH
- All allocated amounts mapped to correct FormK1 fields
- EIN validated

**Roundtrip serialization tests:**
- serialize -> deserialize produces identical FormK1
- Decimal precision preserved through JSON roundtrip
- All fields survive serialization (no data loss)

**Reconciliation test (critical):**
- Generate K-1s for 2 shareholders
- Sum each K-1 field across all shareholders
- Assert sums equal Schedule K totals for every field
  </behavior>
  <implementation>
Use orjson (already installed) for JSON serialization. Use FormK1 from src/documents/models.py directly -- do NOT create a separate K-1 model. The whole point is that the generated K-1 is structurally identical to an extracted K-1.

The rounding strategy (last shareholder gets residual) is standard accounting practice and prevents IRS matching program discrepancies.
  </implementation>
</feature>

<verification>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_handoff.py -v --tb=short
```
</verification>

<success_criteria>
- K-1 allocations sum exactly to Schedule K totals for every line item
- Rounding residual correctly assigned to last shareholder
- FormK1 model validates with all required fields
- Serialization roundtrip preserves all data and Decimal precision
- All tests pass (target: 25+ tests)
</success_criteria>

<output>
After completion, create `.planning/phases/06-business-tax-agent/06-05-SUMMARY.md`
</output>
