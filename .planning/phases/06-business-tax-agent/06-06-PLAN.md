---
phase: 06-business-tax-agent
plan: 06
type: execute
wave: 4
depends_on: ["06-04", "06-05"]
files_modified:
  - src/agents/business_tax/output.py
  - tests/agents/business_tax/test_output.py
autonomous: true

must_haves:
  truths:
    - "Drake 1120-S worksheet generated as Excel with all Page 1 lines, Schedule K, and Schedule L"
    - "K-1 worksheets generated per shareholder with all allocated amounts"
    - "Basis worksheet generated per shareholder matching Form 7203 structure"
    - "Preparer notes generated as Markdown with entity summary, flags, and review focus areas"
  artifacts:
    - path: "src/agents/business_tax/output.py"
      provides: "Drake worksheet, K-1, basis, and preparer notes generators"
      exports: ["generate_1120s_drake_worksheet", "generate_k1_worksheets", "generate_basis_worksheets", "generate_business_preparer_notes"]
      min_lines: 200
    - path: "tests/agents/business_tax/test_output.py"
      provides: "Output generation tests"
      min_lines: 120
  key_links:
    - from: "src/agents/business_tax/output.py"
      to: "src/agents/business_tax/models.py"
      via: "reads Form1120SResult, ScheduleK, ScheduleL, ShareholderInfo"
      pattern: "from src\\.agents\\.business_tax\\.models import"
    - from: "src/agents/business_tax/output.py"
      to: "src/agents/business_tax/basis.py"
      via: "reads BasisResult for basis worksheets"
      pattern: "from src\\.agents\\.business_tax\\.basis import"
---

<objective>
Create output generators for the Business Tax Agent: Drake 1120-S worksheet (Excel), K-1 worksheets (Excel), shareholder basis worksheets (Excel), and preparer notes (Markdown).

Purpose: These are the CPA-facing deliverables from the Business Tax Agent. The Drake worksheet feeds manual entry into Drake Tax Software, K-1 worksheets are provided to shareholders, and basis worksheets support Form 7203 compliance (BTAX-01, BTAX-02, BTAX-03).

Output:
- `src/agents/business_tax/output.py` with all output generators
- Test suite verifying output structure and content
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-business-tax-agent/06-RESEARCH.md
@src/agents/business_tax/models.py
@src/agents/business_tax/calculator.py
@src/agents/business_tax/basis.py
@src/agents/business_tax/handoff.py
@src/agents/personal_tax/output.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Drake 1120-S worksheet and K-1 worksheet generators</name>
  <files>src/agents/business_tax/output.py</files>
  <action>
Create `src/agents/business_tax/output.py` following the pattern from `src/agents/personal_tax/output.py`. Reuse the helper functions pattern (_create_currency_style, _create_header_style, _auto_fit_columns, _format_decimal).

**generate_1120s_drake_worksheet(result: Form1120SResult, output_path: Path) -> Path:**
- Creates Excel workbook with openpyxl
- Sheet 1 "Summary": Entity name, EIN, tax year, filing date, ordinary business income
- Sheet 2 "Page 1 - Income": Lines 1a through Line 6 with descriptions and amounts
- Sheet 3 "Page 1 - Deductions": Lines 7 through Line 22 with descriptions and amounts
- Sheet 4 "Schedule K": All K boxes (1-17) with descriptions and amounts
- Sheet 5 "Schedule L": Balance sheet with beginning and ending columns. Two column groups: assets (lines 1-15), liabilities + equity (lines 16-27). Include balance check row.
- Sheet 6 "Schedule M-1": Book-tax reconciliation lines
- Sheet 7 "Schedule M-2": AAA analysis
- Apply currency formatting to amount cells, header styling to labels
- Auto-fit column widths
- Returns output_path

**generate_k1_worksheets(entity_name: str, entity_ein: str, tax_year: int, shareholders: list[ShareholderInfo], allocated_k1s: list[dict[str, Decimal]], basis_results: list[BasisResult], output_path: Path) -> Path:**
- Creates Excel workbook with one sheet per shareholder
- Each sheet named "K-1 {shareholder.name}" (truncated to 31 chars for Excel limit)
- Each sheet contains:
  - Header: entity name, EIN, tax year, shareholder name, TIN, ownership %
  - K-1 boxes with descriptions and allocated amounts (matching IRS K-1 form layout)
  - Summary section: total income, total deductions, distributions
- Apply currency formatting
- Returns output_path

**generate_basis_worksheets(entity_name: str, tax_year: int, shareholders: list[ShareholderInfo], basis_results: list[BasisResult], output_path: Path) -> Path:**
- Creates Excel workbook with one sheet per shareholder
- Each sheet named "Basis {shareholder.name}" (truncated to 31 chars)
- Layout mirrors Form 7203 structure:
  - Section A: Stock Basis
    - Line 1: Beginning stock basis
    - Line 2: Increases (income items)
    - Line 3: Subtotal
    - Line 4: Distributions
    - Line 5: Nondeductible expenses
    - Line 6: Losses and deductions allowed
    - Line 7: Ending stock basis
  - Section B: Debt Basis
    - Line 1: Beginning debt basis
    - Line 2: Restoration (if applicable)
    - Line 3: Losses applied to debt basis
    - Line 4: Ending debt basis
  - Summary: Suspended losses, taxable distributions
- Apply currency formatting
- Returns output_path

**generate_business_preparer_notes(result: Form1120SResult, basis_results: list[BasisResult], escalations: list[str], output_path: Path) -> Path:**
- Creates Markdown file with sections:
  1. Entity Summary: name, EIN, tax year, entity type, shareholders count
  2. Income Summary: gross receipts, COGS, gross profit, ordinary business income
  3. Shareholder Summary: table of shareholders with ownership %, basis status
  4. Flags and Escalations: any escalation items
  5. Schedule L Balance Check: balanced/unbalanced status
  6. Reasonable Compensation Check: officer comp vs distributions ratio
  7. Review Focus Areas: areas requiring CPA attention
  8. Assumptions: v1 limitations (full-year shareholders only, federal only, etc.)
- Returns output_path
  </action>
  <verify>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run python -c "
from src.agents.business_tax.output import (
    generate_1120s_drake_worksheet,
    generate_k1_worksheets,
    generate_basis_worksheets,
    generate_business_preparer_notes,
)
print('All output generators import successfully')
"
```
  </verify>
  <done>All four output generators created: 1120-S Drake worksheet, K-1 worksheets, basis worksheets, preparer notes.</done>
</task>

<task type="auto">
  <name>Task 2: Write output generation tests</name>
  <files>tests/agents/business_tax/test_output.py</files>
  <action>
Create `tests/agents/business_tax/test_output.py` with pytest tests.

Use tmp_path fixture for output files. Create test fixture data: a minimal Form1120SResult with 2 shareholders, known amounts, basis results.

**1120-S Drake worksheet tests:**
- Workbook created with correct number of sheets (7)
- Summary sheet has entity name and EIN
- Page 1 Income sheet has gross receipts amount
- Page 1 Deductions sheet has officer compensation
- Schedule K sheet has ordinary business income
- Schedule L sheet has beginning and ending columns
- Currency cells are formatted correctly (check number_format)

**K-1 worksheet tests:**
- One sheet per shareholder
- Each sheet has shareholder name and TIN
- Allocated amounts appear in correct cells
- Sheet names truncated to 31 chars

**Basis worksheet tests:**
- One sheet per shareholder
- Beginning and ending stock basis present
- Suspended losses shown if nonzero
- Form 7203 structure followed (sections A and B)

**Preparer notes tests:**
- Markdown file created
- Contains entity name
- Contains shareholder summary section
- Contains escalations if any
- Contains balance check result
- Contains reasonable compensation check

Run with: `cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_output.py -v`
  </action>
  <verify>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_output.py -v --tb=short
```
  </verify>
  <done>All output tests pass. Drake worksheet, K-1, basis, and preparer notes generators produce correct outputs.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_output.py -v --tb=short
```
</verification>

<success_criteria>
- 1120-S Drake worksheet has all required sheets (Summary, Page 1 Income, Page 1 Deductions, Schedule K, Schedule L, M-1, M-2)
- K-1 worksheets have one sheet per shareholder with correct allocations
- Basis worksheets follow Form 7203 structure
- Preparer notes include entity summary, flags, balance check, and compensation check
- All tests pass (target: 20+ tests)
</success_criteria>

<output>
After completion, create `.planning/phases/06-business-tax-agent/06-06-SUMMARY.md`
</output>
