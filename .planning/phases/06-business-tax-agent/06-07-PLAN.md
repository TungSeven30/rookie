---
phase: 06-business-tax-agent
plan: 07
type: execute
wave: 5
depends_on: ["06-03", "06-04", "06-05", "06-06"]
files_modified:
  - src/agents/business_tax/agent.py
  - src/agents/business_tax/__init__.py
  - tests/agents/business_tax/test_agent.py
autonomous: true

must_haves:
  truths:
    - "BusinessTaxAgent.process() orchestrates the complete 1120-S workflow from trial balance to outputs"
    - "Agent extracts trial balance, maps GL accounts, computes 1120-S, allocates K-1s, tracks basis"
    - "Agent generates all outputs: Drake worksheet, K-1 worksheets, basis worksheets, preparer notes"
    - "Agent escalates on missing data, imbalanced Schedule L, mid-year ownership changes, foreign transactions"
    - "business_tax_handler registered with TaskDispatcher for task_type='business_tax'"
    - "End-to-end test with 2 shareholders produces correct K-1 allocations summing to Schedule K"
  artifacts:
    - path: "src/agents/business_tax/agent.py"
      provides: "BusinessTaxAgent orchestrator and dispatcher handler"
      exports: ["BusinessTaxAgent", "BusinessTaxResult", "business_tax_handler"]
      min_lines: 200
    - path: "tests/agents/business_tax/test_agent.py"
      provides: "Agent orchestration tests including end-to-end"
      min_lines: 200
  key_links:
    - from: "src/agents/business_tax/agent.py"
      to: "src/agents/business_tax/trial_balance.py"
      via: "parses trial balance from input file"
      pattern: "parse_excel_trial_balance"
    - from: "src/agents/business_tax/agent.py"
      to: "src/agents/business_tax/calculator.py"
      via: "computes 1120-S pages"
      pattern: "compute_page1|compute_schedule_k|compute_schedule_l"
    - from: "src/agents/business_tax/agent.py"
      to: "src/agents/business_tax/basis.py"
      via: "tracks shareholder basis"
      pattern: "calculate_shareholder_basis"
    - from: "src/agents/business_tax/agent.py"
      to: "src/agents/business_tax/handoff.py"
      via: "allocates K-1s and generates handoff artifacts"
      pattern: "allocate_k1s|generate_k1_for_handoff|serialize_k1_artifact"
    - from: "src/agents/business_tax/agent.py"
      to: "src/agents/business_tax/output.py"
      via: "generates all output files"
      pattern: "generate_1120s_drake_worksheet|generate_k1_worksheets|generate_basis_worksheets"
    - from: "src/agents/business_tax/agent.py"
      to: "src/orchestration/dispatcher.py"
      via: "business_tax_handler registered for dispatching"
      pattern: "business_tax_handler"
---

<objective>
Create the BusinessTaxAgent orchestrator that coordinates the complete 1120-S workflow, plus the TaskDispatcher handler and end-to-end integration tests.

Purpose: This is the integration point that ties all Phase 6 components together into a working agent that can process an S-Corp return from trial balance input to K-1 output (all BTAX requirements).

Output:
- `src/agents/business_tax/agent.py` with BusinessTaxAgent class and handler
- Updated `src/agents/business_tax/__init__.py` with complete exports
- End-to-end test suite
</objective>

<execution_context>
@/Users/tungmbp1423/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tungmbp1423/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-business-tax-agent/06-RESEARCH.md
@src/agents/business_tax/models.py
@src/agents/business_tax/trial_balance.py
@src/agents/business_tax/calculator.py
@src/agents/business_tax/basis.py
@src/agents/business_tax/handoff.py
@src/agents/business_tax/output.py
@src/agents/personal_tax/agent.py
@src/orchestration/dispatcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BusinessTaxAgent orchestrator and handler</name>
  <files>
    src/agents/business_tax/agent.py
    src/agents/business_tax/__init__.py
  </files>
  <action>
Create `src/agents/business_tax/agent.py` following the pattern of `src/agents/personal_tax/agent.py`.

**BusinessTaxResult (dataclass):**
- `drake_worksheet_path: Path` (1120-S Drake worksheet)
- `k1_worksheet_path: Path` (K-1 worksheets for all shareholders)
- `basis_worksheet_path: Path` (Basis worksheets for all shareholders)
- `preparer_notes_path: Path`
- `form_result: Form1120SResult` (computed 1120-S data)
- `k1_handoff_data: list[FormK1]` (generated K-1s for handoff)
- `basis_results: list[BasisResult]` (per-shareholder basis)
- `escalations: list[str]`
- `overall_confidence: str` (HIGH/MEDIUM/LOW)

**BusinessTaxAgent class:**
- `__init__(self, output_dir: Path)` -- simpler than PersonalTaxAgent (no storage_url needed, trial balance provided directly)
- `escalations: list[str]` -- accumulated escalation reasons

- `async process(self, entity_name: str, entity_ein: str, tax_year: int, trial_balance_bytes: bytes, shareholders: list[ShareholderInfo], session: AsyncSession, prior_year_schedule_l: ScheduleL | None = None, prior_year_aaa: Decimal = Decimal("0"), separately_stated: dict[str, Decimal] | None = None) -> BusinessTaxResult:`

Workflow (mirroring PersonalTaxAgent pattern):
1. Parse trial balance from Excel bytes -> TrialBalance model
   - Validate: trial balance is balanced (debits == credits), escalate if not
2. Map GL accounts to 1120-S lines -> list[GLMapping]
   - Flag LOW confidence mappings as escalations
3. Aggregate mapped amounts -> dict[str, Decimal]
4. Compute Page 1 (income/deductions) -> Page1Result
5. Compute Schedule K -> ScheduleK
   - Check for foreign transactions / AMT items -> escalate if nonzero
6. Allocate K-1s to shareholders -> list[dict[str, Decimal]]
   - Validate ownership percentages sum to 100, escalate if not
   - Check for mid-year ownership changes (v1: not supported, escalate)
7. Calculate shareholder basis for each shareholder -> list[BasisResult]
   - Use calculate_shareholder_basis with K-1 allocated amounts
   - Build BasisAdjustmentInputs from allocated K-1 items per shareholder
8. Compute Schedule L -> ScheduleL
   - Check balance: escalate if not balanced
9. Compute Schedule M-1 -> ScheduleM1Result
10. Compute Schedule M-2 -> ScheduleM2Result
11. Build Form1120SResult from all components
12. Check reasonable compensation (officer comp vs distributions ratio)
    - If any shareholder has distributions > 0 and officer_compensation == 0 and is_officer: escalate
13. Generate outputs (Drake worksheet, K-1 worksheets, basis worksheets, preparer notes)
14. Generate K-1 handoff data (FormK1 instances for Personal Tax Agent)
15. Return BusinessTaxResult

Log events at each step using structured logging (same pattern as PersonalTaxAgent).

**business_tax_handler(task: Task, session: AsyncSession) -> None:**
- Handler for TaskDispatcher registration (task_type="business_tax")
- Reads trial_balance_bytes from task artifact or storage
- Reads shareholders from task metadata
- Creates BusinessTaxAgent and calls process()
- Creates TaskArtifact entries for outputs
- Creates "generated_k1" artifacts for each shareholder K-1
- Handles EscalationRequired exceptions (reuse from personal_tax)
- Updates task status (completed/escalated/failed)
- Pattern identical to personal_tax_handler

Update `src/agents/business_tax/__init__.py` to export BusinessTaxAgent, BusinessTaxResult, and business_tax_handler.
  </action>
  <verify>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run python -c "
from src.agents.business_tax.agent import BusinessTaxAgent, BusinessTaxResult, business_tax_handler
from src.agents.business_tax import BusinessTaxAgent as BTAExport
print('BusinessTaxAgent imports successfully')
print('Handler importable:', business_tax_handler is not None)
"
```
  </verify>
  <done>BusinessTaxAgent orchestrates complete workflow. business_tax_handler ready for dispatcher registration.</done>
</task>

<task type="auto">
  <name>Task 2: Write agent orchestration and end-to-end tests</name>
  <files>tests/agents/business_tax/test_agent.py</files>
  <action>
Create `tests/agents/business_tax/test_agent.py` with pytest tests.

**Test fixture: sample trial balance Excel bytes**
Create a helper function `_make_sample_trial_balance() -> bytes` that generates an openpyxl workbook in memory with ~25 GL accounts typical of a small S-Corp:
- Revenue: $500,000 (credit)
- COGS: $200,000 (debit)
- Officer Compensation: $120,000 (debit)
- Salaries: $80,000 (debit)
- Rent: $24,000 (debit)
- Depreciation: $15,000 (debit)
- Interest Expense: $5,000 (debit)
- Other Expenses: $10,000 (debit)
- Cash: $50,000 (debit)
- Accounts Receivable: $30,000 (debit)
- Fixed Assets: $100,000 (debit)
- Accumulated Depreciation: $40,000 (credit)
- Accounts Payable: $20,000 (credit)
- Shareholder Loans: $10,000 (credit)
- Capital Stock: $1,000 (credit)
- Retained Earnings: $109,000 (credit)
- (Verify: total debits = total credits)

**Test fixture: sample shareholders**
2 shareholders:
- Shareholder A: 60% ownership, officer, $50,000 beginning stock basis, $0 debt basis
- Shareholder B: 40% ownership, not officer, $30,000 beginning stock basis, $10,000 debt basis

**Orchestration tests:**
- test_process_basic: Agent processes trial balance and returns BusinessTaxResult
- test_ordinary_income: Ordinary business income = revenue - COGS - deductions = expected value
- test_k1_allocation: K-1 amounts sum to Schedule K totals
- test_basis_updated: Shareholder basis updated correctly after processing
- test_schedule_l_balanced: Schedule L assets == liabilities + equity
- test_outputs_generated: All 4 output files exist after processing
- test_k1_handoff_data: FormK1 instances generated for each shareholder

**Escalation tests:**
- test_unbalanced_trial_balance: Unbalanced TB triggers escalation
- test_low_confidence_mapping: Unknown GL accounts produce escalation
- test_ownership_not_100: Ownership pcts not summing to 100 triggers escalation
- test_zero_officer_comp: Officer with zero comp but distributions triggers advisory escalation
- test_schedule_l_imbalance: Schedule L not balancing triggers escalation

**End-to-end integration test:**
- test_end_to_end_two_shareholders: Process complete 1120-S with sample data
  - Verify ordinary business income matches manual calculation
  - Verify K-1 allocations sum to Schedule K
  - Verify basis updated for both shareholders
  - Verify Schedule L balances
  - Verify all output files created and non-empty
  - Verify K-1 handoff FormK1 instances are valid

Use AsyncMock for session parameter. Use tmp_path for output directory.

Run with: `cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_agent.py -v`
  </action>
  <verify>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/test_agent.py -v --tb=short
```
  </verify>
  <done>All agent tests pass including end-to-end test with 2 shareholders. K-1 allocations verified, basis tracked, Schedule L balanced, all outputs generated.</done>
</task>

<task type="auto">
  <name>Task 3: Run full Phase 6 test suite</name>
  <files></files>
  <action>
Run the complete Phase 6 test suite to verify all components work together.

Also run the existing Phase 3-4 tests to ensure no regressions (the FormK1 model is shared).

```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/ -v --tb=short
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/personal_tax/ tests/documents/ -v --tb=short
```

Fix any failures discovered during the full suite run. All tests must pass.
  </action>
  <verify>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/ tests/agents/personal_tax/ tests/documents/ -v --tb=short
```
  </verify>
  <done>All Phase 6 tests pass. No regressions in existing Phase 3-4 tests. Complete test suite green.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/business_tax/ -v --tb=short
cd /Users/tungmbp1423/Projects/rookie && uv run pytest tests/agents/personal_tax/ tests/documents/ --tb=short
```
All Phase 6 tests pass. No regressions in existing tests.
</verification>

<success_criteria>
- BusinessTaxAgent.process() executes complete workflow from trial balance to outputs
- End-to-end test with 2 shareholders passes
- K-1 allocations sum to Schedule K totals
- Basis tracked correctly with IRS ordering
- Schedule L balances
- All output files generated
- K-1 handoff FormK1 instances valid
- business_tax_handler ready for dispatcher
- No regressions in existing tests
- Total Phase 6 tests: 150+ across all test files
</success_criteria>

<output>
After completion, create `.planning/phases/06-business-tax-agent/06-07-SUMMARY.md`
</output>
